---
title: ""
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(stringr)
library(useful)
library(here)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(sqldf)
library(matrixTests)
library(pryr)
library(VennDiagram)
library(ggbeeswarm)
library(ggridges)
library(ggpubr)
library(scales)
library(parallel)
library(statmod)
library(ggrepel)
library(rentrez)
library(biomaRt)
library(ggforestplot)
library(forestplot)
library(ArrayTools)

```

#Data loading and manipulation
```{r}

#Hugo symbol locus types, used to identify protein-coding genes
hugo_symbol_locus_types <- read_tsv(here::here("data","hugo_symbol_locus_types.txt"))
hugo_symbol_locus_types <- hugo_symbol_locus_types %>% dplyr::rename(symbol = `Approved symbol`, name = `Approved name`, locus = `Locus type`)

#Cosmic fusion, cancer census gene, and kinase gene lists
cosmic_fusions <- read_tsv(here::here("data","cosmic_fusions.tsv"))
cosmic_fusion_genes_df_fusion_tibble <- read_tsv(here::here("data","cosmic_fusion_genes_df_fusion_tibble.tsv"))
cosmic_translocation_genes <- read_tsv(here::here("data","cosmic_translocation_genes.tsv"))
cosmic_census_genes <- read_tsv(here::here("data","cosmic_census_genes.tsv"))
oncogenes_tsps_kinases_drivers <- read_tsv(here::here("data","oncogenes_tsps_kinases_drivers.txt"))

#Nonessentials and common essentials used in Broad CRISPR screening
common_essentials <- read_csv(here::here("data","common_essentials.csv"))
common_essentials_gene_list <- str_split_fixed(common_essentials$gene, " ", 2)[,1]
nonessentials <- read_csv(here::here("data","nonessentials.csv"))
nonessentials_gene_list <- str_split_fixed(nonessentials$gene, " ", 2)[,1]

#CCLE fusion and annotation data
ccle_fusions <- read_tsv(here::here("data","CCLE_fusions.csv"))
ccle_annotations <- read_csv(here::here("data","sample_info.csv"))
ccle_fusions_annotated <- left_join(ccle_fusions, ccle_annotations, by = c("DepMap_ID" = "DepMap_ID"))
disease_annotations_by_cell_line <- ccle_fusions_annotated %>% distinct(DepMap_ID,CCLE_Name,lineage,lineage_subtype,primary_disease,Subtype)

ccle_fusions_annotated <- ccle_fusions_annotated %>% dplyr::mutate(LeftGeneSymbol = str_split_fixed(LeftGene," ",2)[,1], LeftEnsemblID = gsub("[()]","",str_split_fixed(LeftGene," ",2)[,2]), RightGeneSymbol = str_split_fixed(RightGene," ",2)[,1], RightEnsemblID = gsub("[()]","",str_split_fixed(RightGene," ",2)[,2]), Fusion = str_c(LeftGeneSymbol,"-",RightGeneSymbol), LeftChrom = str_split_fixed(LeftBreakpoint,":",3)[,1], LeftChromPosition = str_split_fixed(LeftBreakpoint,":",3)[,2], LeftChromOrientation = str_split_fixed(LeftBreakpoint,":",3)[,3], RightChrom = str_split_fixed(RightBreakpoint,":",3)[,1], RightChromPosition = str_split_fixed(RightBreakpoint,":",3)[,2], RightChromOrientation = str_split_fixed(RightBreakpoint,":",3)[,3]) %>% dplyr::select(-`#FusionName`,-LeftGene,-LeftBreakpoint,-RightGene,-RightBreakpoint)

ccle_fusions_annotated <- left_join(ccle_fusions_annotated, hugo_symbol_locus_types,by = c("LeftGeneSymbol" = "symbol")) %>% dplyr::rename(LeftGeneName = name, LeftGeneType = locus)

ccle_fusions_annotated <- left_join(ccle_fusions_annotated ,hugo_symbol_locus_types,by = c("RightGeneSymbol" = "symbol")) %>% dplyr::rename(RightGeneName = name, RightGeneType = locus)

ccle_fusions_annotated <- ccle_fusions_annotated %>% mutate(Cosmic = Fusion %in% cosmic_fusion_genes_df_fusion_tibble$value)

ccle_fusions_annotated <- ccle_fusions_annotated[,c("DepMap_ID","Fusion","Cosmic","LeftGeneSymbol","LeftEnsemblID","LeftGeneName","LeftGeneType","RightGeneSymbol","RightEnsemblID","RightGeneName","RightGeneType","LeftChrom","LeftChromPosition","LeftChromOrientation","RightChrom","RightChromPosition","RightChromOrientation","FFPM","JunctionReadCount","SpanningFragCount","SpliceType","LargeAnchorSupport","LeftBreakDinuc","LeftBreakEntropy","RightBreakDinuc","RightBreakEntropy","annots","CCLE_count","stripped_cell_line_name","CCLE_Name","Alias","COSMICID","lineage","lineage_subtype","lineage_sub_subtype","sex","source","Achilles_n_replicates","cell_line_NNMD","culture_type","culture_medium","cas9_activity","RRID","sample_collection_site","primary_or_metastasis","primary_disease","Subtype","age","Sanger_Model_ID")]

#CCLE RNA expression data for protein-coding genes
ccle_expression_protein_coding_log2tpm <- read_csv(here::here("data","CCLE_expression.csv"))
ccle_expression_protein_coding_log2tpm <- ccle_expression_protein_coding_log2tpm %>% dplyr::rename(DepMap_ID = X1)
ccle_expression_protein_coding_log2tpm_colnames <- str_split_fixed(colnames(ccle_expression_protein_coding_log2tpm), " ",2)[,1]
colnames(ccle_expression_protein_coding_log2tpm) <- ccle_expression_protein_coding_log2tpm_colnames
ccle_expression_protein_coding_log2tpm_matrix <- ccle_expression_protein_coding_log2tpm %>% column_to_rownames("DepMap_ID") %>% t()
ccle_expression_protein_coding_log2tpm_matrix_df <- ccle_expression_protein_coding_log2tpm_matrix %>% as.data.frame() %>% rownames_to_column("gene")

ccle_expression_protein_coding_log2tpm_colnames_tibble <- ccle_expression_protein_coding_log2tpm_colnames[!ccle_expression_protein_coding_log2tpm_colnames == "DepMap_ID"] %>% as_tibble()

write_tsv(ccle_expression_protein_coding_log2tpm_colnames_tibble,here::here("results/datatables","ccle_expression_protein_coding_log2tpm_colnames_tibble.tsv"))


output.gct(ccle_expression_protein_coding_log2tpm_matrix_df,here::here("results/datatables","ccle_expression_protein_coding_log2tpm_matrix_df.gct"))

#CCLE dependency data for protein-coding genes
ccle_dependency_probability <- read_csv(here::here("data","gene_dependency.csv"))
ccle_dependency_probability_colnames <- str_split_fixed(colnames(ccle_dependency_probability), " ",2)[,1]
colnames(ccle_dependency_probability) <- ccle_dependency_probability_colnames

#CCLE dependency sgRNA location data
ccle_dependency_guides <- read_csv(here::here("data","gene_guide_map.csv"))
ccle_dependency_guides <- ccle_dependency_guides %>% mutate(chromosome = str_split_fixed(genome_alignment,"_",3)[,1], base = str_split_fixed(genome_alignment,"_",3)[,2], direction = str_split_fixed(genome_alignment,"_",3)[,3], gene = str_split_fixed(gene, " ", 2)[,1])
ccle_dependency_guides <- ccle_dependency_guides %>% dplyr::select(gene,chromosome,base,direction,n_alignments,sgrna)
ccle_dependency_probability_matrix <- ccle_dependency_probability %>% column_to_rownames("DepMap_ID") %>% t()
ccle_dependency_probability_matrix_df <- ccle_dependency_probability_matrix %>% as.data.frame() %>% rownames_to_column("gene")

#CCLE Copy number alterations - gene level (aligned to hg38 and used for primary copy number analysis)
CCLE_gene_cn <- read_csv(here::here("data","CCLE_gene_cn.csv"))
CCLE_gene_cn <- CCLE_gene_cn %>% dplyr::rename(DepMap_ID = X1)
CCLE_gene_cn <- CCLE_gene_cn %>% dplyr::rename_all(funs(str_split_fixed(.," ",2)[,1]))

#CCLE Copy number alterations - segment level (aligned from hg19 from 19q2 data release, and used for ShatterSeek analysis, in order to correspond to correspond to the hg19 structural variant analysis that's available)

CCLE_segment_cn_hg19 <- read_csv(here::here("data","CCLE_segmented_cn_hg19.csv"))

#CCLE Mutation data
CCLE_mutations <- read_tsv(here::here("data","CCLE_mutations.csv"))

#CCLE_translocations_SvABA_20181221 - structural variant calls on a subset of CCLE lines with WGS data. Of note, the chromosomal breakpoints are based on alignment to hg19

CCLE_translocations_SvABA_20181221 <- read_tsv(here::here("data","CCLE_translocations_SvABA_20181221.txt"))

CCLE_translocations_SvABA_20181221 <- CCLE_translocations_SvABA_20181221 %>% mutate(fusion = str_c(gene1,"-",gene2), fusion_inverse = str_c(gene2,"-",gene1))

#Biomart query for gene symbols and corresgene coordinates
ensembl <- useMart("ENSEMBL_MART_ENSEMBL")
datasets <- listDatasets(ensembl)
ensembl = useDataset("hsapiens_gene_ensembl",mart=ensembl) #hsapiens_gene_ensembl is version GRCh38.p13
filters = listFilters(ensembl)
attributes = listAttributes(ensembl)

gene_coordinate_table_hg38 <- getBM(attributes = c("hgnc_symbol","chromosome_name","start_position","end_position"), mart = ensembl)

gene_coordinate_table_hg38 <- gene_coordinate_table_hg38 %>% filter(!hgnc_symbol == (""))

gene_coordinate_table_hg38 <- gene_coordinate_table_hg38 %>% filter(chromosome_name %in% c("1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","X","Y"))

gene_coordinate_table_hg38 <- gene_coordinate_table_hg38 %>% mutate(chromosome_name = str_c("chr",gene_coordinate_table_hg38$chromosome_name))

#TAD boundaries from a reference "normal" cell line
reference_tad_boundaries_hg38 <- read_tsv(here::here("data","ENCFF633ORE_endometrial_microvascular_endothelial_cells_hg38.bed"))

reference_tad_boundaries_hg38 <- reference_tad_boundaries_hg38 %>% mutate(chromosome = str_split_fixed(reference_tad_boundaries_hg38$TAD,":",2)[,1], coordinates = str_split_fixed(reference_tad_boundaries_hg38$TAD,":",2)[,2])

reference_tad_boundaries_hg38 <- reference_tad_boundaries_hg38 %>% mutate(start = str_split_fixed(reference_tad_boundaries_hg38$coordinates,"-",2)[,1], end = str_split_fixed(reference_tad_boundaries_hg38$coordinates,"-",2)[,2]) %>% dplyr::select(chromosome,start,end) %>% mutate(TAD_number = row_number())

reference_tad_boundaries_hg38$start <- as.integer(reference_tad_boundaries_hg38$start)

reference_tad_boundaries_hg38$end <- as.integer(reference_tad_boundaries_hg38$end)

#Gene_TAD_table - constructed by checking to see if start of gene lies within a particular TAD
Gene_TAD_table <- sqldf('SELECT gene_coordinate_table_hg38.*,reference_tad_boundaries_hg38.* FROM gene_coordinate_table_hg38 INNER JOIN reference_tad_boundaries_hg38 ON (gene_coordinate_table_hg38.start_position BETWEEN reference_tad_boundaries_hg38.start AND reference_tad_boundaries_hg38.end) AND (gene_coordinate_table_hg38.chromosome_name = reference_tad_boundaries_hg38.chromosome)')

Gene_TAD_table <- Gene_TAD_table %>% dplyr::rename(TAD_chromosome = chromosome, TAD_start = start, TAD_end = end)

Gene_TAD_table <- Gene_TAD_table %>% dplyr::rename(gene = hgnc_symbol, chromosome = chromosome_name, TAD_identifier = TAD_number)

#Gene_TAD_boundary_table - constructed for genes that fall into a TAD boundaries, to assign them to upstream and downstream TADs
genes_TAD_boundaries_coordinate_table_hg38 <- gene_coordinate_table_hg38 %>% filter(!hgnc_symbol %in% Gene_TAD_table$gene)

Gene_TAD_boundary_table_upstream_TAD <- sqldf('SELECT genes_TAD_boundaries_coordinate_table_hg38.*,reference_tad_boundaries_hg38.* FROM genes_TAD_boundaries_coordinate_table_hg38 INNER JOIN reference_tad_boundaries_hg38 ON (genes_TAD_boundaries_coordinate_table_hg38.start_position > reference_tad_boundaries_hg38.end) AND (genes_TAD_boundaries_coordinate_table_hg38.start_position - reference_tad_boundaries_hg38.end < 40000) AND (genes_TAD_boundaries_coordinate_table_hg38.chromosome_name = reference_tad_boundaries_hg38.chromosome)')

Gene_TAD_boundary_table_upstream_TAD <- Gene_TAD_boundary_table_upstream_TAD %>% dplyr::rename(gene = hgnc_symbol, upstream_TAD_identifier = TAD_number) %>% dplyr::select(gene, upstream_TAD_identifier)

Gene_TAD_boundary_table_downstream_TAD <- sqldf('SELECT genes_TAD_boundaries_coordinate_table_hg38.*,reference_tad_boundaries_hg38.* FROM genes_TAD_boundaries_coordinate_table_hg38 INNER JOIN reference_tad_boundaries_hg38 ON (genes_TAD_boundaries_coordinate_table_hg38.start_position < reference_tad_boundaries_hg38.start) AND (reference_tad_boundaries_hg38.start - genes_TAD_boundaries_coordinate_table_hg38.start_position < 40000) AND (genes_TAD_boundaries_coordinate_table_hg38.chromosome_name = reference_tad_boundaries_hg38.chromosome)')

Gene_TAD_boundary_table_downstream_TAD <- Gene_TAD_boundary_table_downstream_TAD %>% dplyr::rename(gene = hgnc_symbol, downstream_TAD_identifier = TAD_number) %>% dplyr::select(gene, downstream_TAD_identifier)

Gene_TAD_boundary_table <- full_join(Gene_TAD_boundary_table_upstream_TAD,Gene_TAD_boundary_table_downstream_TAD)

#Write output of Gene TAD table and Gene TAD boundary table
write_tsv(Gene_TAD_table,here::here("results/datatables","Gene_TAD_table.tsv"))

write_tsv(Gene_TAD_boundary_table,here::here("results/datatables","Gene_TAD_boundary_table.tsv"))

#TCGA fusion list called by RNAseq
tcga_fusion_list <- read_tsv(here::here("data","tcga_fusion_list.txt"))
tcga_fusion_list_symbols_updated <- tcga_fusion_list
tcga_fusion_list_symbols_updated$LeftGene <- recode(tcga_fusion_list_symbols_updated$LeftGene, "LHFP" = "LHFPL6", "MKL1" = "MRTFA")
tcga_fusion_list_symbols_updated$RightGene <- recode(tcga_fusion_list_symbols_updated$RightGene, "LHFP" = "LHFPL6", "MKL1" = "MRTFA")
tcga_study_abbreviations <- read_tsv(here::here("data","tcga_study_abbreviations.txt"))

#CTD2 drug screen data
ctd2_auc <- read_tsv(here::here("data/CTD2_drug_screen","v20.data.curves_post_qc.txt"))
ctd2_experiment_metadata <- read_tsv(here::here("data/CTD2_drug_screen","v20.meta.per_experiment.txt"))
ctd2_cell_metadata <- read_tsv(here::here("data/CTD2_drug_screen","v20.meta.per_cell_line.txt"))
ctd2_compound_metadata <- read_tsv(here::here("data/CTD2_drug_screen","v20.meta.per_compound.txt"))

#Lung cancer cells based organoid model CRISPR screen from "CRISPR screens in cancer spheroids identify 3D growth-specific vulnerabilities"
NCIH23_D19_3D_U1_counts <- read_csv(here::here("data/H23_GW_counts_organoid_study","D19_3D_U1_counts.csv"))
NCIH23_D19_3D_U2_counts <- read_csv(here::here("data/H23_GW_counts_organoid_study","D19_3D_U2_counts.csv"))
NCIH23_T0_counts <- read_csv(here::here("data/H23_GW_counts_organoid_study","T0_counts.csv"))
NCIH1975_D19_3D_U1_counts <- read_csv(here::here("data/H1975_GW_counts_organoid_study","H1975_3D_1_merged.csv"))
NCIH1975_D19_3D_U2_counts <- read_csv(here::here("data/H1975_GW_counts_organoid_study","H1975_3D_2_merged.csv"))
NCIH1975_T0_counts <- read_csv(here::here("data/H1975_GW_counts_organoid_study","H1975_T0_merged.csv"))
NCIH2009_D19_3D_U1_counts <- read_csv(here::here("data/H2009_GW_counts_organoid_study","H2009_3D_pooled_3.csv"))
NCIH2009_D19_3D_U2_counts <- read_csv(here::here("data/H2009_GW_counts_organoid_study","H2009_3D_pooled_4.csv"))
NCIH2009_T0_counts <- read_csv(here::here("data/H2009_GW_counts_organoid_study","H2009_T0_pooled.csv"))

#Fragile sites in the PCAWG dataset
fragile_sites_PCAWG_hg38 <- read_tsv(here::here("data","fragile_sites_PCAWG_hg38.bed"))

fragile_sites_PCAWG_hg38 <- fragile_sites_PCAWG_hg38 %>% mutate(chromosome = str_split_fixed(fragile_sites,"[:|-]",3)[,1], start = str_split_fixed(fragile_sites,"[:|-]",3)[,2], end = str_split_fixed(fragile_sites,"[:|-]",3)[,3])

#Venetoclax screening data and B-ALL cell lines
venetoclax_screen_all_cell_lines <- read_csv(here::here("data","venetoclax_screen_all_cell_lines.csv"))

B_ALL_cell_lines <- scan(here::here("data","B_ALL_cell_lines.txt"), what = "", sep = ",") %>% as_vector()
  
```

#Filtering fusion calls
```{r}

#List of fusions in CCLE filtered by FFPM > 0.1, GT/ AG breakpoints, JunctionReads > 5, Both genes either being protein coding or part of the IgH locus. Subsequent cleaning to uniformly label IgH locus.
ALL_fusions_protein_coding_filtered_list <- ccle_fusions_annotated %>% filter(FFPM > 0.1 & LeftBreakDinuc == "GT" & RightBreakDinuc == "AG" & JunctionReadCount > 5 & (LeftGeneType == "gene with protein product" | LeftGeneSymbol %in% str_subset(ccle_fusions_annotated$LeftGeneSymbol,"IGH")) & (RightGeneType == "gene with protein product" | RightGeneSymbol %in% str_subset(ccle_fusions_annotated$RightGeneSymbol,"IGH")))

ALL_fusions_protein_coding_filtered_list_IGH_fusions <- ALL_fusions_protein_coding_filtered_list %>% distinct(Fusion,LeftGeneType,RightGeneType) %>% filter(!LeftGeneType == "gene with protein product" | !RightGeneType == "gene with protein product" | LeftGeneType %>% is.na() | RightGeneType %>% is.na())

ALL_fusions_protein_coding_filtered_list <- ALL_fusions_protein_coding_filtered_list %>% filter(!Fusion %in% c("NBEA-IGHV1OR15-6","NSD2-IGHV5-78"))

ALL_fusions_protein_coding_filtered_list_without_IGH <- ALL_fusions_protein_coding_filtered_list %>% filter(!Fusion %in% ALL_fusions_protein_coding_filtered_list_IGH_fusions$Fusion)

ALL_fusions_protein_coding_filtered_list_with_IGH_left <- ALL_fusions_protein_coding_filtered_list %>% filter(Fusion %in% ALL_fusions_protein_coding_filtered_list_IGH_fusions$Fusion & LeftGeneSymbol %in% str_subset(ALL_fusions_protein_coding_filtered_list$LeftGeneSymbol,"IGH")) %>% mutate(LeftGeneSymbol = "IGH") %>% mutate(Fusion = str_c(LeftGeneSymbol,"-",RightGeneSymbol))

ALL_fusions_protein_coding_filtered_list_with_IGH_right <- ALL_fusions_protein_coding_filtered_list %>% filter(Fusion %in% ALL_fusions_protein_coding_filtered_list_IGH_fusions$Fusion & RightGeneSymbol %in% str_subset(ALL_fusions_protein_coding_filtered_list$RightGeneSymbol,"IGH")) %>% mutate(RightGeneSymbol = "IGH") %>% mutate(Fusion = str_c(LeftGeneSymbol,"-",RightGeneSymbol))

ALL_fusions_protein_coding_filtered_list_with_IGH <- full_join(ALL_fusions_protein_coding_filtered_list_with_IGH_left,ALL_fusions_protein_coding_filtered_list_with_IGH_right)

ALL_fusions_protein_coding_filtered_list_final <- full_join(ALL_fusions_protein_coding_filtered_list_without_IGH, ALL_fusions_protein_coding_filtered_list_with_IGH)

hyphenated_genes_to_filter_out <- ALL_fusions_protein_coding_filtered_list_final %>% filter(LeftGeneSymbol %in% str_subset(ALL_fusions_protein_coding_filtered_list_final$LeftGeneSymbol,"-") | RightGeneSymbol %in% str_subset(ALL_fusions_protein_coding_filtered_list_final$RightGeneSymbol,"-") ) %>% distinct(Fusion) %>% unlist() %>% unname()

ALL_fusions_protein_coding_filtered_list_final <- ALL_fusions_protein_coding_filtered_list_final %>% filter(!Fusion %in% hyphenated_genes_to_filter_out)

ALL_fusions_protein_coding_filtered_list_final_unique <- ALL_fusions_protein_coding_filtered_list_final %>% arrange(Fusion) %>% distinct(Fusion) %>% unlist() %>% unname()

#All fusions that have dependency data available
ALL_fusions_with_dependency_data <- tibble(Fusion=NA)
counter = 0

for(fusion in ALL_fusions_protein_coding_filtered_list_final_unique){
  
cell_lines_with_fusion <- ALL_fusions_protein_coding_filtered_list_final %>% dplyr::filter(Fusion == fusion) %>% distinct(DepMap_ID) %>% unlist() %>% unname() %>% intersect(colnames(ccle_dependency_probability_matrix))

if(length(cell_lines_with_fusion) > 0){

ALL_fusions_with_dependency_data <- add_row(ALL_fusions_with_dependency_data, Fusion = fusion)

counter = counter + 1
print(counter)
  
}
}

ALL_fusions_with_dependency_data <- ALL_fusions_with_dependency_data %>% remove_missing() %>% distinct(Fusion) %>% unlist() %>% unname()

#Note that while all of the fusions in this table appear in cell lines with dependency data, not all cell lines in this table have dependency data. As an example, EWSR1-FLI1 appears in this list because there is at least one cell line with EWSR1-FLI1 with dependency data, but the other cell lines with EWSR1-FLI1 without dependency data also appear in this list. Therefore, the cell lines from this list must be intersected by the cell lines in the ccle_dependency_probability_matrix for an accurate view of high-confidence fusions only in cell lines with dependency data
ALL_fusions_protein_coding_filtered_list_final_with_dependency_data <- ALL_fusions_protein_coding_filtered_list_final %>% filter(Fusion %in% ALL_fusions_with_dependency_data)

ALL_fusions_protein_coding_filtered_list_final_with_dependency_data <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% mutate(in_cell_line_with_dependency_data = DepMap_ID %in% colnames(ccle_dependency_probability_matrix))

#Write output: Table of fusions with protein-coding/ IgH partners
write_tsv(ALL_fusions_protein_coding_filtered_list_final_with_dependency_data,here::here("results/datatables","ALL_fusions_protein_coding_filtered_list_final_with_dependency_data.tsv"))

```

#Structural variant dependency analysis
```{r}
#Identify which cell lines with dependency data also have structural variant data available from the SvABA algorithm 

cell_lines_with_dependency_data_CCLE_names <- ccle_annotations %>% dplyr::filter(DepMap_ID %in% ccle_dependency_probability$DepMap_ID) %>% distinct(CCLE_Name) %>% unlist() %>% unname()

cell_lines_with_SvABA_translocation_data_CCLE_names <- CCLE_translocations_SvABA_20181221 %>% distinct(CCLE_name) %>% unlist() %>% unname()

cell_lines_with_SV_and_dependency_data_CCLE_names <- intersect(cell_lines_with_dependency_data_CCLE_names, cell_lines_with_SvABA_translocation_data_CCLE_names)

cell_lines_with_SV_and_dependency_data_DepMap_IDs <- ccle_annotations %>% filter(CCLE_Name %in% cell_lines_with_SV_and_dependency_data_CCLE_names) %>% distinct(DepMap_ID) %>% unlist() %>% unname()

cell_lines_with_SV_and_dependency_data_and_fusions_CCLE_names <- intersect(cell_lines_with_SV_and_dependency_data_CCLE_names, ALL_fusions_protein_coding_filtered_list_final_with_dependency_data$CCLE_Name)

cell_lines_with_SV_and_dependency_data_and_fusions_DepMap_IDs <- ccle_annotations %>% filter(CCLE_Name %in% cell_lines_with_SV_and_dependency_data_and_fusions_CCLE_names) %>% distinct(DepMap_ID) %>% unlist() %>% unname()

#Updated dependency probability table and structural variant table (note: bp coordinates are hg19)

ccle_dependency_probability_matrix_df_with_SV <- ccle_dependency_probability_matrix_df %>% dplyr::select(c(gene,cell_lines_with_SV_and_dependency_data_DepMap_IDs))

CCLE_translocations_SvABA_20181221 <- left_join(CCLE_translocations_SvABA_20181221,ccle_annotations[,c("CCLE_Name","DepMap_ID")], by = c("CCLE_name" = "CCLE_Name"))

CCLE_translocations_SvABA_20181221 <- CCLE_translocations_SvABA_20181221 %>% dplyr::select(DepMap_ID,CCLE_name,map_id,class,bp1,bp2,gene1,gene2,site1,site2,multi_sv_fusion,fusion,fusion_inverse)

write_tsv(CCLE_translocations_SvABA_20181221, here::here("results/datatables","CCLE_translocations_SvABA_20181221.txt"))

#Count of structural variants and corresponding cell counts by category when looking at the 209 cell lines that have overlapping structural variant and dependency data

count_of_unique_structural_variant_cell_line_combinations_looking_at_cells_with_dependency_data_available <- CCLE_translocations_SvABA_20181221 %>% filter(DepMap_ID %in% cell_lines_with_SV_and_dependency_data_DepMap_IDs & !(is.na(gene1) & is.na(gene2))) %>% group_by(class) %>% summarise(unique_structural_variants = n_distinct(gene1,gene2,DepMap_ID))

```

#Determining which fusions have a SV correlate
```{r}

full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(CCLE_Name %in% CCLE_translocations_SvABA_20181221$CCLE_name & DepMap_ID %in% colnames(ccle_dependency_probability_matrix)) %>% mutate(left_gene = str_split_fixed(Fusion,"-",2)[,1], right_gene = str_split_fixed(Fusion,"-",2)[,2]) %>% distinct(Fusion, CCLE_Name, left_gene, right_gene) %>% arrange(Fusion)

full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_by_cell_line <- list()

full_CCLE_translocations_SvABA_20181221_by_cell_line <- list()

counter = 0

for(cell_line in cell_lines_with_SV_and_dependency_data_and_fusions_CCLE_names){
  
full_CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]] <- CCLE_translocations_SvABA_20181221 %>% filter(CCLE_name == cell_line)

full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_by_cell_line[[cell_line]] <- full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data %>% filter(CCLE_Name == cell_line) %>% mutate(evidence_of_SV_in_WGS_data = ifelse(Fusion %in% full_CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$fusion | Fusion %in% full_CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$fusion_inverse,"Fusion seen",ifelse((left_gene %in% full_CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene1 | left_gene %in% full_CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene2) & (right_gene %in% full_CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene1 | right_gene %in% full_CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene2),"Both genes involved in SV",ifelse(left_gene %in% full_CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene1 | left_gene %in% full_CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene2,"Left gene involved in SV",ifelse(right_gene %in% full_CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene1 | right_gene %in% full_CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene2,"Right gene involved in SV","No WGS evidence")))))

counter = counter + 1
print(counter)
}


full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined <- bind_rows(full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_by_cell_line)

full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined_summary <- full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined %>% group_by(evidence_of_SV_in_WGS_data) %>% summarise(count = n()) 

full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined_summary <- full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined_summary %>% mutate(percentage = count/sum(full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined_summary$count)*100)

full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined_summary$evidence_of_SV_in_WGS_data <- factor(full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined_summary$evidence_of_SV_in_WGS_data, levels = c("No WGS evidence","Right gene involved in SV","Left gene involved in SV","Both genes involved in SV","Fusion seen"))

full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined_summary <- full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined_summary %>% mutate(evidence_of_SV_in_WGS_data_aggregated = ifelse(evidence_of_SV_in_WGS_data == "No WGS evidence","No WGS evidence",ifelse(evidence_of_SV_in_WGS_data == "Fusion seen","Exact fusion seen","At least one gene in SV")))

full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined_summary$evidence_of_SV_in_WGS_data_aggregated <- factor(full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined_summary$evidence_of_SV_in_WGS_data_aggregated, levels = c("No WGS evidence","At least one gene in SV","Exact fusion seen"))

#Count of fusions (and corresponding cell counts) that have some direct WGS correlate when looking at the 209 cell lines that have overlapping structural variant and dependency data

fusions_with_supporting_WGS_evidence <- full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined %>% filter(!evidence_of_SV_in_WGS_data == "No WGS evidence")

fusions_with_supporting_WGS_evidence <- left_join(fusions_with_supporting_WGS_evidence,ccle_annotations[,c("CCLE_Name","DepMap_ID")])

count_of_unique_fusion_with_supporting_WGS_evidence_cell_line_combinations_looking_at_cells_with_dependency_data_available <- fusions_with_supporting_WGS_evidence %>% summarise(n_distinct(Fusion,DepMap_ID)) %>% unlist() %>% unname()

cell_lines_with_SV_and_dependency_data_and_fusions_with_supporting_WGS_DepMap_IDs <- fusions_with_supporting_WGS_evidence$DepMap_ID %>% unique()

```

#Count of SVs in each category (fusions are not mutually exclusive)
```{r}
count_of_unique_structural_variant_cell_line_combinations_looking_at_cells_with_dependency_data_available$class <- count_of_unique_structural_variant_cell_line_combinations_looking_at_cells_with_dependency_data_available$class %>% recode(`DEL-like`="Deletions",`DUP-like`="Duplications",`INV-like`="Inversions",`TRA-like`="Translocations")

count_of_all_structural_variants_for_dependency_enrichment_analysis <- count_of_unique_structural_variant_cell_line_combinations_looking_at_cells_with_dependency_data_available %>% rename(class="Structural Variant Category",unique_structural_variants="Count")

count_of_all_structural_variants_for_dependency_enrichment_analysis <- count_of_all_structural_variants_for_dependency_enrichment_analysis %>% add_row(`Structural Variant Category`="Fusions",Count=count_of_unique_fusion_with_supporting_WGS_evidence_cell_line_combinations_looking_at_cells_with_dependency_data_available) %>% add_row(`Structural Variant Category`="All SVs",Count=sum(count_of_all_structural_variants_for_dependency_enrichment_analysis$Count[1:4]))

write_tsv(count_of_all_structural_variants_for_dependency_enrichment_analysis, here::here("results/datatables","count_of_all_structural_variants_for_dependency_enrichment_analysis.tsv"))
```

#SV-dependency analysis for all structural variants involving at least one coding partner
```{r}

cell_line_gene_tibble_with_dependency_partner_collateral_information_ALL_SVs <- list()

counter = 0

for(cell_line in cell_lines_with_SV_and_dependency_data_DepMap_IDs){

cell_line_gene_tibble <- ccle_dependency_probability_matrix_df_with_SV %>% filter(!is.na(get(cell_line))) %>% distinct(gene) %>% mutate(cell_line) %>% dplyr::select(cell_line,gene)

genes_that_are_absolute_dependencies <- ccle_dependency_probability_matrix_df_with_SV %>% filter(get(cell_line) > 0.5) %>% distinct(gene) %>% unlist() %>% unname()

left_genes_involved_in_structural_variants <- CCLE_translocations_SvABA_20181221 %>% filter(DepMap_ID == cell_line) %>% dplyr::select(gene1) %>% unlist() %>% unname()

left_genes_involved_in_structural_variants <- left_genes_involved_in_structural_variants[!is.na(left_genes_involved_in_structural_variants)]

right_genes_involved_in_structural_variants <- CCLE_translocations_SvABA_20181221 %>% filter(DepMap_ID == cell_line) %>% dplyr::select(gene2) %>% unlist() %>% unname()

right_genes_involved_in_structural_variants <- right_genes_involved_in_structural_variants[!is.na(right_genes_involved_in_structural_variants)]

all_genes_involved_in_structural_variants <- unique(c(left_genes_involved_in_structural_variants,right_genes_involved_in_structural_variants))

TAD_identifiers_for_genes_in_single_TADS <- Gene_TAD_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(TAD_identifier) %>% unlist() %>% unname()

left_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(upstream_TAD_identifier) %>% unlist() %>% unname()

right_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(downstream_TAD_identifier) %>% unlist() %>% unname()

all_TAD_identifiers_for_genes_in_structural_variants <- unique(c(TAD_identifiers_for_genes_in_single_TADS,left_TAD_identifiers_for_genes_in_boundaries,right_TAD_identifiers_for_genes_in_boundaries))

all_genes_in_TADs_of_structural_variants <- Gene_TAD_table %>% filter(TAD_identifier %in% all_TAD_identifiers_for_genes_in_structural_variants) %>% distinct(gene) %>% unlist() %>% unname()

collateral_genes_in_TADS_of_structural_variants <- setdiff(all_genes_in_TADs_of_structural_variants, all_genes_involved_in_structural_variants)

cell_line_gene_tibble_with_dependency_partner_collateral_information_ALL_SVs[[cell_line]] <- cell_line_gene_tibble %>% mutate(dependency = gene %in% genes_that_are_absolute_dependencies, sv_partner_gene = gene %in% all_genes_involved_in_structural_variants, sv_collateral_gene = gene %in% collateral_genes_in_TADS_of_structural_variants)

counter = counter + 1
print(counter)

}

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_ALL_SVs <- bind_rows(cell_line_gene_tibble_with_dependency_partner_collateral_information_ALL_SVs)

#Fisher's exact to check whether genes that are directly involved in structural variants (partners) are more likely to be dependencies than those that are not

sv_partner_TRUE_and_dependency_TRUE_count_ALL_SVs <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_ALL_SVs %>% filter(sv_partner_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_TRUE_and_dependency_FALSE_count_ALL_SVs <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_ALL_SVs %>% filter(sv_partner_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_TRUE_count_ALL_SVs <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_ALL_SVs %>% filter(sv_partner_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_FALSE_count_ALL_SVs <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_ALL_SVs %>% filter(sv_partner_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_dependency_matrix_ALL_SVs <- matrix(c(sv_partner_TRUE_and_dependency_TRUE_count_ALL_SVs,sv_partner_TRUE_and_dependency_FALSE_count_ALL_SVs,sv_partner_FALSE_and_dependency_TRUE_count_ALL_SVs,sv_partner_FALSE_and_dependency_FALSE_count_ALL_SVs),nrow = 2)

fisher.test(sv_partner_dependency_matrix_ALL_SVs)

#Fisher's exact to check whether other genes in the same TADs as structural variants (collateral) are more likely to be dependencies than those that are not

sv_collateral_TRUE_and_dependency_TRUE_count_ALL_SVs <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_ALL_SVs %>% filter(sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_ALL_SVs <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_ALL_SVs %>% filter(sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_ALL_SVs <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_ALL_SVs %>% filter(sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_ALL_SVs <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_ALL_SVs %>% filter(sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_ALL_SVs <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_ALL_SVs,sv_collateral_TRUE_and_dependency_FALSE_count_ALL_SVs,sv_collateral_FALSE_and_dependency_TRUE_count_ALL_SVs,sv_collateral_FALSE_and_dependency_FALSE_count_ALL_SVs),nrow = 2)

fisher.test(sv_collateral_dependency_matrix_ALL_SVs)

```

#SV-dependency analysis for translocations only
```{r}

cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS <- list()

counter = 0

for(cell_line in cell_lines_with_SV_and_dependency_data_DepMap_IDs){

cell_line_gene_tibble <- ccle_dependency_probability_matrix_df_with_SV %>% filter(!is.na(get(cell_line))) %>% distinct(gene) %>% mutate(cell_line) %>% dplyr::select(cell_line,gene)

genes_that_are_absolute_dependencies <- ccle_dependency_probability_matrix_df_with_SV %>% filter(get(cell_line) > 0.5) %>% distinct(gene) %>% unlist() %>% unname()

left_genes_involved_in_structural_variants <- CCLE_translocations_SvABA_20181221 %>% filter(class == "TRA-like" & DepMap_ID == cell_line) %>% dplyr::select(gene1) %>% unlist() %>% unname()

left_genes_involved_in_structural_variants <- left_genes_involved_in_structural_variants[!is.na(left_genes_involved_in_structural_variants)]

right_genes_involved_in_structural_variants <- CCLE_translocations_SvABA_20181221 %>% filter(class == "TRA-like" & DepMap_ID == cell_line) %>% dplyr::select(gene2) %>% unlist() %>% unname()

right_genes_involved_in_structural_variants <- right_genes_involved_in_structural_variants[!is.na(right_genes_involved_in_structural_variants)]

all_genes_involved_in_structural_variants <- unique(c(left_genes_involved_in_structural_variants,right_genes_involved_in_structural_variants))

TAD_identifiers_for_genes_in_single_TADS <- Gene_TAD_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(TAD_identifier) %>% unlist() %>% unname()

left_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(upstream_TAD_identifier) %>% unlist() %>% unname()

right_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(downstream_TAD_identifier) %>% unlist() %>% unname()

all_TAD_identifiers_for_genes_in_structural_variants <- unique(c(TAD_identifiers_for_genes_in_single_TADS,left_TAD_identifiers_for_genes_in_boundaries,right_TAD_identifiers_for_genes_in_boundaries))

all_genes_in_TADs_of_structural_variants <- Gene_TAD_table %>% filter(TAD_identifier %in% all_TAD_identifiers_for_genes_in_structural_variants) %>% distinct(gene) %>% unlist() %>% unname()

collateral_genes_in_TADS_of_structural_variants <- setdiff(all_genes_in_TADs_of_structural_variants, all_genes_involved_in_structural_variants)

cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS[[cell_line]] <- cell_line_gene_tibble %>% mutate(dependency = gene %in% genes_that_are_absolute_dependencies, sv_partner_gene = gene %in% all_genes_involved_in_structural_variants, sv_collateral_gene = gene %in% collateral_genes_in_TADS_of_structural_variants)

counter = counter + 1
print(counter)

}

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS <- bind_rows(cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS)

#Fisher's exact to check whether genes that are directly involved in structural variants (partners) are more likely to be dependencies than those that are not

sv_partner_TRUE_and_dependency_TRUE_count_TRANSLOCATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS %>% filter(sv_partner_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_TRUE_and_dependency_FALSE_count_TRANSLOCATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS %>% filter(sv_partner_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_TRUE_count_TRANSLOCATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS %>% filter(sv_partner_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_FALSE_count_TRANSLOCATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS %>% filter(sv_partner_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_dependency_matrix_TRANSLOCATIONS <- matrix(c(sv_partner_TRUE_and_dependency_TRUE_count_TRANSLOCATIONS,sv_partner_TRUE_and_dependency_FALSE_count_TRANSLOCATIONS,sv_partner_FALSE_and_dependency_TRUE_count_TRANSLOCATIONS,sv_partner_FALSE_and_dependency_FALSE_count_TRANSLOCATIONS),nrow = 2)

fisher.test(sv_partner_dependency_matrix_TRANSLOCATIONS)

#Fisher's exact to check whether other genes in the same TADs as structural variants (collateral) are more likely to be dependencies than those that are not

sv_collateral_TRUE_and_dependency_TRUE_count_TRANSLOCATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS %>% filter(sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_TRANSLOCATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS %>% filter(sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_TRANSLOCATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS %>% filter(sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_TRANSLOCATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS %>% filter(sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_TRANSLOCATIONS <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_TRANSLOCATIONS,sv_collateral_TRUE_and_dependency_FALSE_count_TRANSLOCATIONS,sv_collateral_FALSE_and_dependency_TRUE_count_TRANSLOCATIONS,sv_collateral_FALSE_and_dependency_FALSE_count_TRANSLOCATIONS),nrow = 2)

fisher.test(sv_collateral_dependency_matrix_TRANSLOCATIONS)

```

#SV-dependency analysis for inversions only
```{r}

cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS <- list()

counter = 0

for(cell_line in cell_lines_with_SV_and_dependency_data_DepMap_IDs){

cell_line_gene_tibble <- ccle_dependency_probability_matrix_df_with_SV %>% filter(!is.na(get(cell_line))) %>% distinct(gene) %>% mutate(cell_line) %>% dplyr::select(cell_line,gene)

genes_that_are_absolute_dependencies <- ccle_dependency_probability_matrix_df_with_SV %>% filter(get(cell_line) > 0.5) %>% distinct(gene) %>% unlist() %>% unname()

left_genes_involved_in_structural_variants <- CCLE_translocations_SvABA_20181221 %>% filter(class == "INV-like" & DepMap_ID == cell_line) %>% dplyr::select(gene1) %>% unlist() %>% unname()

left_genes_involved_in_structural_variants <- left_genes_involved_in_structural_variants[!is.na(left_genes_involved_in_structural_variants)]

right_genes_involved_in_structural_variants <- CCLE_translocations_SvABA_20181221 %>% filter(class == "INV-like" & DepMap_ID == cell_line) %>% dplyr::select(gene2) %>% unlist() %>% unname()

right_genes_involved_in_structural_variants <- right_genes_involved_in_structural_variants[!is.na(right_genes_involved_in_structural_variants)]

all_genes_involved_in_structural_variants <- unique(c(left_genes_involved_in_structural_variants,right_genes_involved_in_structural_variants))

TAD_identifiers_for_genes_in_single_TADS <- Gene_TAD_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(TAD_identifier) %>% unlist() %>% unname()

left_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(upstream_TAD_identifier) %>% unlist() %>% unname()

right_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(downstream_TAD_identifier) %>% unlist() %>% unname()

all_TAD_identifiers_for_genes_in_structural_variants <- unique(c(TAD_identifiers_for_genes_in_single_TADS,left_TAD_identifiers_for_genes_in_boundaries,right_TAD_identifiers_for_genes_in_boundaries))

all_genes_in_TADs_of_structural_variants <- Gene_TAD_table %>% filter(TAD_identifier %in% all_TAD_identifiers_for_genes_in_structural_variants) %>% distinct(gene) %>% unlist() %>% unname()

collateral_genes_in_TADS_of_structural_variants <- setdiff(all_genes_in_TADs_of_structural_variants, all_genes_involved_in_structural_variants)

cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS[[cell_line]] <- cell_line_gene_tibble %>% mutate(dependency = gene %in% genes_that_are_absolute_dependencies, sv_partner_gene = gene %in% all_genes_involved_in_structural_variants, sv_collateral_gene = gene %in% collateral_genes_in_TADS_of_structural_variants)

counter = counter + 1
print(counter)

}

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS <- bind_rows(cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS)

#Fisher's exact to check whether genes that are directly involved in structural variants (partners) are more likely to be dependencies than those that are not

sv_partner_TRUE_and_dependency_TRUE_count_INVERSIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS %>% filter(sv_partner_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_TRUE_and_dependency_FALSE_count_INVERSIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS %>% filter(sv_partner_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_TRUE_count_INVERSIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS %>% filter(sv_partner_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_FALSE_count_INVERSIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS %>% filter(sv_partner_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_dependency_matrix_INVERSIONS <- matrix(c(sv_partner_TRUE_and_dependency_TRUE_count_INVERSIONS,sv_partner_TRUE_and_dependency_FALSE_count_INVERSIONS,sv_partner_FALSE_and_dependency_TRUE_count_INVERSIONS,sv_partner_FALSE_and_dependency_FALSE_count_INVERSIONS),nrow = 2)

fisher.test(sv_partner_dependency_matrix_INVERSIONS)

#Fisher's exact to check whether other genes in the same TADs as structural variants (collateral) are more likely to be dependencies than those that are not

sv_collateral_TRUE_and_dependency_TRUE_count_INVERSIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS %>% filter(sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_INVERSIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS %>% filter(sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_INVERSIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS %>% filter(sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_INVERSIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS %>% filter(sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_INVERSIONS <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_INVERSIONS,sv_collateral_TRUE_and_dependency_FALSE_count_INVERSIONS,sv_collateral_FALSE_and_dependency_TRUE_count_INVERSIONS,sv_collateral_FALSE_and_dependency_FALSE_count_INVERSIONS),nrow = 2)

fisher.test(sv_collateral_dependency_matrix_INVERSIONS)

```

#SV-dependency analysis for deletions only
```{r}

cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS <- list()

counter = 0

for(cell_line in cell_lines_with_SV_and_dependency_data_DepMap_IDs){

cell_line_gene_tibble <- ccle_dependency_probability_matrix_df_with_SV %>% filter(!is.na(get(cell_line))) %>% distinct(gene) %>% mutate(cell_line) %>% dplyr::select(cell_line,gene)

genes_that_are_absolute_dependencies <- ccle_dependency_probability_matrix_df_with_SV %>% filter(get(cell_line) > 0.5) %>% distinct(gene) %>% unlist() %>% unname()

left_genes_involved_in_structural_variants <- CCLE_translocations_SvABA_20181221 %>% filter(class == "DEL-like" & DepMap_ID == cell_line) %>% dplyr::select(gene1) %>% unlist() %>% unname()

left_genes_involved_in_structural_variants <- left_genes_involved_in_structural_variants[!is.na(left_genes_involved_in_structural_variants)]

right_genes_involved_in_structural_variants <- CCLE_translocations_SvABA_20181221 %>% filter(class == "DEL-like" & DepMap_ID == cell_line) %>% dplyr::select(gene2) %>% unlist() %>% unname()

right_genes_involved_in_structural_variants <- right_genes_involved_in_structural_variants[!is.na(right_genes_involved_in_structural_variants)]

all_genes_involved_in_structural_variants <- unique(c(left_genes_involved_in_structural_variants,right_genes_involved_in_structural_variants))

TAD_identifiers_for_genes_in_single_TADS <- Gene_TAD_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(TAD_identifier) %>% unlist() %>% unname()

left_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(upstream_TAD_identifier) %>% unlist() %>% unname()

right_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(downstream_TAD_identifier) %>% unlist() %>% unname()

all_TAD_identifiers_for_genes_in_structural_variants <- unique(c(TAD_identifiers_for_genes_in_single_TADS,left_TAD_identifiers_for_genes_in_boundaries,right_TAD_identifiers_for_genes_in_boundaries))

all_genes_in_TADs_of_structural_variants <- Gene_TAD_table %>% filter(TAD_identifier %in% all_TAD_identifiers_for_genes_in_structural_variants) %>% distinct(gene) %>% unlist() %>% unname()

collateral_genes_in_TADS_of_structural_variants <- setdiff(all_genes_in_TADs_of_structural_variants, all_genes_involved_in_structural_variants)

cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS[[cell_line]] <- cell_line_gene_tibble %>% mutate(dependency = gene %in% genes_that_are_absolute_dependencies, sv_partner_gene = gene %in% all_genes_involved_in_structural_variants, sv_collateral_gene = gene %in% collateral_genes_in_TADS_of_structural_variants)

counter = counter + 1
print(counter)

}

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS <- bind_rows(cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS)

#Fisher's exact to check whether genes that are directly involved in structural variants (partners) are more likely to be dependencies than those that are not

sv_partner_TRUE_and_dependency_TRUE_count_DELETIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS %>% filter(sv_partner_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_TRUE_and_dependency_FALSE_count_DELETIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS %>% filter(sv_partner_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_TRUE_count_DELETIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS %>% filter(sv_partner_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_FALSE_count_DELETIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS %>% filter(sv_partner_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_dependency_matrix_DELETIONS <- matrix(c(sv_partner_TRUE_and_dependency_TRUE_count_DELETIONS,sv_partner_TRUE_and_dependency_FALSE_count_DELETIONS,sv_partner_FALSE_and_dependency_TRUE_count_DELETIONS,sv_partner_FALSE_and_dependency_FALSE_count_DELETIONS),nrow = 2)

fisher.test(sv_partner_dependency_matrix_DELETIONS)

#Fisher's exact to check whether other genes in the same TADs as structural variants (collateral) are more likely to be dependencies than those that are not

sv_collateral_TRUE_and_dependency_TRUE_count_DELETIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS %>% filter(sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_DELETIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS %>% filter(sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_DELETIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS %>% filter(sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_DELETIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS %>% filter(sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_DELETIONS <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_DELETIONS,sv_collateral_TRUE_and_dependency_FALSE_count_DELETIONS,sv_collateral_FALSE_and_dependency_TRUE_count_DELETIONS,sv_collateral_FALSE_and_dependency_FALSE_count_DELETIONS),nrow = 2)

fisher.test(sv_collateral_dependency_matrix_DELETIONS)

```

#SV-dependency analysis for duplications only
```{r}

cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS <- list()

counter = 0

for(cell_line in cell_lines_with_SV_and_dependency_data_DepMap_IDs){

cell_line_gene_tibble <- ccle_dependency_probability_matrix_df_with_SV %>% filter(!is.na(get(cell_line))) %>% distinct(gene) %>% mutate(cell_line) %>% dplyr::select(cell_line,gene)

genes_that_are_absolute_dependencies <- ccle_dependency_probability_matrix_df_with_SV %>% filter(get(cell_line) > 0.5) %>% distinct(gene) %>% unlist() %>% unname()

left_genes_involved_in_structural_variants <- CCLE_translocations_SvABA_20181221 %>% filter(class == "DUP-like" & DepMap_ID == cell_line) %>% dplyr::select(gene1) %>% unlist() %>% unname()

left_genes_involved_in_structural_variants <- left_genes_involved_in_structural_variants[!is.na(left_genes_involved_in_structural_variants)]

right_genes_involved_in_structural_variants <- CCLE_translocations_SvABA_20181221 %>% filter(class == "DUP-like" & DepMap_ID == cell_line) %>% dplyr::select(gene2) %>% unlist() %>% unname()

right_genes_involved_in_structural_variants <- right_genes_involved_in_structural_variants[!is.na(right_genes_involved_in_structural_variants)]

all_genes_involved_in_structural_variants <- unique(c(left_genes_involved_in_structural_variants,right_genes_involved_in_structural_variants))

TAD_identifiers_for_genes_in_single_TADS <- Gene_TAD_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(TAD_identifier) %>% unlist() %>% unname()

left_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(upstream_TAD_identifier) %>% unlist() %>% unname()

right_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(downstream_TAD_identifier) %>% unlist() %>% unname()

all_TAD_identifiers_for_genes_in_structural_variants <- unique(c(TAD_identifiers_for_genes_in_single_TADS,left_TAD_identifiers_for_genes_in_boundaries,right_TAD_identifiers_for_genes_in_boundaries))

all_genes_in_TADs_of_structural_variants <- Gene_TAD_table %>% filter(TAD_identifier %in% all_TAD_identifiers_for_genes_in_structural_variants) %>% distinct(gene) %>% unlist() %>% unname()

collateral_genes_in_TADS_of_structural_variants <- setdiff(all_genes_in_TADs_of_structural_variants, all_genes_involved_in_structural_variants)

cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS[[cell_line]] <- cell_line_gene_tibble %>% mutate(dependency = gene %in% genes_that_are_absolute_dependencies, sv_partner_gene = gene %in% all_genes_involved_in_structural_variants, sv_collateral_gene = gene %in% collateral_genes_in_TADS_of_structural_variants)

counter = counter + 1
print(counter)

}

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS <- bind_rows(cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS)

#Fisher's exact to check whether genes that are directly involved in structural variants (partners) are more likely to be dependencies than those that are not

sv_partner_TRUE_and_dependency_TRUE_count_DUPLICATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS %>% filter(sv_partner_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_TRUE_and_dependency_FALSE_count_DUPLICATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS %>% filter(sv_partner_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_TRUE_count_DUPLICATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS %>% filter(sv_partner_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_FALSE_count_DUPLICATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS %>% filter(sv_partner_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_dependency_matrix_DUPLICATIONS <- matrix(c(sv_partner_TRUE_and_dependency_TRUE_count_DUPLICATIONS,sv_partner_TRUE_and_dependency_FALSE_count_DUPLICATIONS,sv_partner_FALSE_and_dependency_TRUE_count_DUPLICATIONS,sv_partner_FALSE_and_dependency_FALSE_count_DUPLICATIONS),nrow = 2)

fisher.test(sv_partner_dependency_matrix_DUPLICATIONS)

#Fisher's exact to check whether other genes in the same TADs as structural variants (collateral) are more likely to be dependencies than those that are not

sv_collateral_TRUE_and_dependency_TRUE_count_DUPLICATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS %>% filter(sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_DUPLICATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS %>% filter(sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_DUPLICATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS %>% filter(sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_DUPLICATIONS <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS %>% filter(sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_DUPLICATIONS <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_DUPLICATIONS,sv_collateral_TRUE_and_dependency_FALSE_count_DUPLICATIONS,sv_collateral_FALSE_and_dependency_TRUE_count_DUPLICATIONS,sv_collateral_FALSE_and_dependency_FALSE_count_DUPLICATIONS),nrow = 2)

fisher.test(sv_collateral_dependency_matrix_DUPLICATIONS)

```

#SV-dependency analysis for fusions (only those with some degree of supporting SV evidence)
```{r}

cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- list()

counter = 0

for(cell_line in cell_lines_with_SV_and_dependency_data_DepMap_IDs){

cell_line_gene_tibble <- ccle_dependency_probability_matrix_df_with_SV %>% filter(!is.na(get(cell_line))) %>% distinct(gene) %>% mutate(cell_line) %>% dplyr::select(cell_line,gene)

genes_that_are_absolute_dependencies <- ccle_dependency_probability_matrix_df_with_SV %>% filter(get(cell_line) > 0.5) %>% distinct(gene) %>% unlist() %>% unname()

left_genes_involved_in_structural_variants <- fusions_with_supporting_WGS_evidence %>% filter(DepMap_ID == cell_line) %>% dplyr::select(left_gene) %>% unlist() %>% unname()

right_genes_involved_in_structural_variants <- fusions_with_supporting_WGS_evidence %>% filter(DepMap_ID == cell_line) %>% dplyr::select(right_gene) %>% unlist() %>% unname()

all_genes_involved_in_structural_variants <- unique(c(left_genes_involved_in_structural_variants,right_genes_involved_in_structural_variants))

TAD_identifiers_for_genes_in_single_TADS <- Gene_TAD_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(TAD_identifier) %>% unlist() %>% unname()

left_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(upstream_TAD_identifier) %>% unlist() %>% unname()

right_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(downstream_TAD_identifier) %>% unlist() %>% unname()

all_TAD_identifiers_for_genes_in_structural_variants <- unique(c(TAD_identifiers_for_genes_in_single_TADS,left_TAD_identifiers_for_genes_in_boundaries,right_TAD_identifiers_for_genes_in_boundaries))

all_genes_in_TADs_of_structural_variants <- Gene_TAD_table %>% filter(TAD_identifier %in% all_TAD_identifiers_for_genes_in_structural_variants) %>% distinct(gene) %>% unlist() %>% unname()

collateral_genes_in_TADS_of_structural_variants <- setdiff(all_genes_in_TADs_of_structural_variants, all_genes_involved_in_structural_variants)

cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE[[cell_line]] <- cell_line_gene_tibble %>% mutate(dependency = gene %in% genes_that_are_absolute_dependencies, sv_partner_gene = gene %in% all_genes_involved_in_structural_variants, sv_collateral_gene = gene %in% collateral_genes_in_TADS_of_structural_variants)

counter = counter + 1
print(counter)

}

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- bind_rows(cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)

#Fisher's exact to check whether genes that are directly involved in structural variants (partners) are more likely to be dependencies than those that are not

sv_partner_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_partner_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_partner_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_partner_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_partner_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- matrix(c(sv_partner_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_partner_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_partner_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_partner_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE),nrow = 2)

fisher.test(sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)

#Fisher's exact to check whether other genes in the same TADs as structural variants (collateral) are more likely to be dependencies than those that are not

sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE),nrow = 2)

fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)

```

#Iterative fusion enrichment analysis (for fusion partners and collateral genes), removing one cell line at a time and observing impact on Odds Ratios
```{r}

iterative_fusion_partner_enrichment_analysis_summary_tibble <- tibble(cell_line_excluded=NA,odds_ratio=NA,CI_lower_bound=NA,CI_upper_bound=NA,p_value=NA)

iterative_fusion_collateral_enrichment_analysis_summary_tibble <- tibble(cell_line_excluded=NA,odds_ratio=NA,CI_lower_bound=NA,CI_upper_bound=NA,p_value=NA)

counter = 0

for(cell in cell_lines_with_SV_and_dependency_data_DepMap_IDs){

cell_lines_with_SV_and_dependency_data_DepMap_IDs_with_current_cell_line_removed <- setdiff(cell_lines_with_SV_and_dependency_data_DepMap_IDs,cell)

cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- list()

for(cell_line in cell_lines_with_SV_and_dependency_data_DepMap_IDs_with_current_cell_line_removed){

cell_line_gene_tibble <- ccle_dependency_probability_matrix_df_with_SV %>% filter(!is.na(get(cell_line))) %>% distinct(gene) %>% mutate(cell_line) %>% dplyr::select(cell_line,gene)

genes_that_are_absolute_dependencies <- ccle_dependency_probability_matrix_df_with_SV %>% filter(get(cell_line) > 0.5) %>% distinct(gene) %>% unlist() %>% unname()

left_genes_involved_in_structural_variants <- fusions_with_supporting_WGS_evidence %>% filter(DepMap_ID == cell_line) %>% dplyr::select(left_gene) %>% unlist() %>% unname()

right_genes_involved_in_structural_variants <- fusions_with_supporting_WGS_evidence %>% filter(DepMap_ID == cell_line) %>% dplyr::select(right_gene) %>% unlist() %>% unname()

all_genes_involved_in_structural_variants <- unique(c(left_genes_involved_in_structural_variants,right_genes_involved_in_structural_variants))

TAD_identifiers_for_genes_in_single_TADS <- Gene_TAD_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(TAD_identifier) %>% unlist() %>% unname()

left_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(upstream_TAD_identifier) %>% unlist() %>% unname()

right_TAD_identifiers_for_genes_in_boundaries <- Gene_TAD_boundary_table %>% filter(gene %in% all_genes_involved_in_structural_variants) %>% distinct(downstream_TAD_identifier) %>% unlist() %>% unname()

all_TAD_identifiers_for_genes_in_structural_variants <- unique(c(TAD_identifiers_for_genes_in_single_TADS,left_TAD_identifiers_for_genes_in_boundaries,right_TAD_identifiers_for_genes_in_boundaries))

all_genes_in_TADs_of_structural_variants <- Gene_TAD_table %>% filter(TAD_identifier %in% all_TAD_identifiers_for_genes_in_structural_variants) %>% distinct(gene) %>% unlist() %>% unname()

collateral_genes_in_TADS_of_structural_variants <- setdiff(all_genes_in_TADs_of_structural_variants, all_genes_involved_in_structural_variants)

cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE[[cell_line]] <- cell_line_gene_tibble %>% mutate(dependency = gene %in% genes_that_are_absolute_dependencies, sv_partner_gene = gene %in% all_genes_involved_in_structural_variants, sv_collateral_gene = gene %in% collateral_genes_in_TADS_of_structural_variants)

}

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- bind_rows(cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)

#sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE

sv_partner_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_partner_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_partner_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_partner_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_partner_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- matrix(c(sv_partner_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_partner_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_partner_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_partner_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE),nrow = 2)

#sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE

sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% filter(sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE),nrow = 2)


iterative_fusion_partner_enrichment_analysis_summary_tibble <- add_row(iterative_fusion_partner_enrichment_analysis_summary_tibble,cell_line_excluded=cell,odds_ratio=fisher.test(sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$estimate,CI_lower_bound=fisher.test(sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$conf.int[1],CI_upper_bound=fisher.test(sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$conf.int[2],p_value=fisher.test(sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$p.value)

iterative_fusion_collateral_enrichment_analysis_summary_tibble <- add_row(iterative_fusion_collateral_enrichment_analysis_summary_tibble,cell_line_excluded=cell,odds_ratio=fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$estimate,CI_lower_bound=fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$conf.int[1],CI_upper_bound=fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$conf.int[2],p_value=fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$p.value)

counter = counter + 1
print(counter)
  
}

iterative_fusion_partner_enrichment_analysis_summary_tibble <- iterative_fusion_partner_enrichment_analysis_summary_tibble %>% remove_missing()

iterative_fusion_collateral_enrichment_analysis_summary_tibble <- iterative_fusion_collateral_enrichment_analysis_summary_tibble %>% remove_missing()

write_tsv(iterative_fusion_partner_enrichment_analysis_summary_tibble,here::here("results/datatables","iterative_fusion_partner_enrichment_analysis_summary_tibble.tsv"))

write_tsv(iterative_fusion_collateral_enrichment_analysis_summary_tibble,here::here("results/datatables","iterative_fusion_collateral_enrichment_analysis_summary_tibble.tsv"))

```

#Logistic regression for dependency status vs. partner, collateral, and disease statuses when evaluating fusions supported by SV evidence
```{r}

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_disease_annotations <- left_join(combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,ccle_annotations[,c("DepMap_ID","primary_disease")], by = c("cell_line" = "DepMap_ID"))

write_tsv(combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_disease_annotations,here::here("results/datatables","combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_disease_annotations.tsv"))

logistic_regression_dependency_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- glm(dependency~sv_partner_gene + sv_collateral_gene + primary_disease, family = "binomial", data = combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_disease_annotations)

logistic_regression_dependency_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_summary <- logistic_regression_dependency_FUSIONS_SUPPORTED_BY_SV_EVIDENCE %>% summary()

logistic_regression_dependency_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_summary <- logistic_regression_dependency_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_summary$coefficient

logistic_regression_dependency_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_cell_line_as_covariate <- glm(dependency~sv_partner_gene + sv_collateral_gene + cell_line, family = "binomial", data = combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_disease_annotations)

```

#Individual odds ratios by cell line for partner and collateral genes in the context of fusions
```{r}

count = 0

cell_lines_and_fusion_partner_and_collateral_gene_ORs_tibble <- tibble(cell_line = NA, fusion_partner_OR = NA, fusion_collateral_OR = NA, translocation_partner_OR = NA, translocation_collateral_OR = NA, inversion_partner_OR = NA, inversion_collateral_OR = NA, deletion_partner_OR = NA, deletion_collateral_OR = NA, duplication_partner_OR = NA, duplication_collateral_OR = NA)

for(cell_line in cell_lines_with_SV_and_dependency_data_DepMap_IDs){
  
#Fusions  

sv_partner_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE[[cell_line]] %>% filter(sv_partner_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE[[cell_line]] %>% filter(sv_partner_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE[[cell_line]] %>% filter(sv_partner_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE[[cell_line]] %>% filter(sv_partner_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- matrix(c(sv_partner_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_partner_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_partner_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_partner_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE),nrow = 2)

sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE[[cell_line]] %>% filter(sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE[[cell_line]] %>% filter(sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE[[cell_line]] %>% filter(sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE[[cell_line]] %>% filter(sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE),nrow = 2)

#Translocations

sv_partner_TRUE_and_dependency_TRUE_count_TRANSLOCATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS[[cell_line]] %>% filter(sv_partner_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_TRUE_and_dependency_FALSE_count_TRANSLOCATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS[[cell_line]] %>% filter(sv_partner_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_TRUE_count_TRANSLOCATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS[[cell_line]] %>% filter(sv_partner_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_FALSE_count_TRANSLOCATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS[[cell_line]] %>% filter(sv_partner_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_dependency_matrix_TRANSLOCATIONS <- matrix(c(sv_partner_TRUE_and_dependency_TRUE_count_TRANSLOCATIONS,sv_partner_TRUE_and_dependency_FALSE_count_TRANSLOCATIONS,sv_partner_FALSE_and_dependency_TRUE_count_TRANSLOCATIONS,sv_partner_FALSE_and_dependency_FALSE_count_TRANSLOCATIONS),nrow = 2)

sv_collateral_TRUE_and_dependency_TRUE_count_TRANSLOCATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS[[cell_line]] %>% filter(sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_TRANSLOCATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS[[cell_line]] %>% filter(sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_TRANSLOCATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS[[cell_line]] %>% filter(sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_TRANSLOCATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_TRANSLOCATIONS[[cell_line]] %>% filter(sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_TRANSLOCATIONS <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_TRANSLOCATIONS,sv_collateral_TRUE_and_dependency_FALSE_count_TRANSLOCATIONS,sv_collateral_FALSE_and_dependency_TRUE_count_TRANSLOCATIONS,sv_collateral_FALSE_and_dependency_FALSE_count_TRANSLOCATIONS),nrow = 2)

#Inversions

sv_partner_TRUE_and_dependency_TRUE_count_INVERSIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS[[cell_line]] %>% filter(sv_partner_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_TRUE_and_dependency_FALSE_count_INVERSIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS[[cell_line]] %>% filter(sv_partner_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_TRUE_count_INVERSIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS[[cell_line]] %>% filter(sv_partner_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_FALSE_count_INVERSIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS[[cell_line]] %>% filter(sv_partner_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_dependency_matrix_INVERSIONS <- matrix(c(sv_partner_TRUE_and_dependency_TRUE_count_INVERSIONS,sv_partner_TRUE_and_dependency_FALSE_count_INVERSIONS,sv_partner_FALSE_and_dependency_TRUE_count_INVERSIONS,sv_partner_FALSE_and_dependency_FALSE_count_INVERSIONS),nrow = 2)

sv_collateral_TRUE_and_dependency_TRUE_count_INVERSIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS[[cell_line]] %>% filter(sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_INVERSIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS[[cell_line]] %>% filter(sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_INVERSIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS[[cell_line]] %>% filter(sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_INVERSIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_INVERSIONS[[cell_line]] %>% filter(sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_INVERSIONS <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_INVERSIONS,sv_collateral_TRUE_and_dependency_FALSE_count_INVERSIONS,sv_collateral_FALSE_and_dependency_TRUE_count_INVERSIONS,sv_collateral_FALSE_and_dependency_FALSE_count_INVERSIONS),nrow = 2)

#Deletions

sv_partner_TRUE_and_dependency_TRUE_count_DELETIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS[[cell_line]] %>% filter(sv_partner_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_TRUE_and_dependency_FALSE_count_DELETIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS[[cell_line]] %>% filter(sv_partner_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_TRUE_count_DELETIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS[[cell_line]] %>% filter(sv_partner_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_FALSE_count_DELETIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS[[cell_line]] %>% filter(sv_partner_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_dependency_matrix_DELETIONS <- matrix(c(sv_partner_TRUE_and_dependency_TRUE_count_DELETIONS,sv_partner_TRUE_and_dependency_FALSE_count_DELETIONS,sv_partner_FALSE_and_dependency_TRUE_count_DELETIONS,sv_partner_FALSE_and_dependency_FALSE_count_DELETIONS),nrow = 2)

sv_collateral_TRUE_and_dependency_TRUE_count_DELETIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS[[cell_line]] %>% filter(sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_DELETIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS[[cell_line]] %>% filter(sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_DELETIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS[[cell_line]] %>% filter(sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_DELETIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DELETIONS[[cell_line]] %>% filter(sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_DELETIONS <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_DELETIONS,sv_collateral_TRUE_and_dependency_FALSE_count_DELETIONS,sv_collateral_FALSE_and_dependency_TRUE_count_DELETIONS,sv_collateral_FALSE_and_dependency_FALSE_count_DELETIONS),nrow = 2)

#Duplications

sv_partner_TRUE_and_dependency_TRUE_count_DUPLICATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS[[cell_line]] %>% filter(sv_partner_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_TRUE_and_dependency_FALSE_count_DUPLICATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS[[cell_line]] %>% filter(sv_partner_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_TRUE_count_DUPLICATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS[[cell_line]] %>% filter(sv_partner_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_FALSE_and_dependency_FALSE_count_DUPLICATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS[[cell_line]] %>% filter(sv_partner_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_partner_dependency_matrix_DUPLICATIONS <- matrix(c(sv_partner_TRUE_and_dependency_TRUE_count_DUPLICATIONS,sv_partner_TRUE_and_dependency_FALSE_count_DUPLICATIONS,sv_partner_FALSE_and_dependency_TRUE_count_DUPLICATIONS,sv_partner_FALSE_and_dependency_FALSE_count_DUPLICATIONS),nrow = 2)

sv_collateral_TRUE_and_dependency_TRUE_count_DUPLICATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS[[cell_line]] %>% filter(sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_DUPLICATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS[[cell_line]] %>% filter(sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_DUPLICATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS[[cell_line]] %>% filter(sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_DUPLICATIONS <- cell_line_gene_tibble_with_dependency_partner_collateral_information_DUPLICATIONS[[cell_line]] %>% filter(sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_DUPLICATIONS <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_DUPLICATIONS,sv_collateral_TRUE_and_dependency_FALSE_count_DUPLICATIONS,sv_collateral_FALSE_and_dependency_TRUE_count_DUPLICATIONS,sv_collateral_FALSE_and_dependency_FALSE_count_DUPLICATIONS),nrow = 2)

#Add to tibble
cell_lines_and_fusion_partner_and_collateral_gene_ORs_tibble <- add_row(cell_lines_and_fusion_partner_and_collateral_gene_ORs_tibble,cell_line = cell_line, fusion_partner_OR = fisher.test(sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$estimate, fusion_collateral_OR = fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$estimate, translocation_partner_OR = fisher.test(sv_partner_dependency_matrix_TRANSLOCATIONS)$estimate, translocation_collateral_OR = fisher.test(sv_collateral_dependency_matrix_TRANSLOCATIONS)$estimate, inversion_partner_OR = fisher.test(sv_partner_dependency_matrix_INVERSIONS)$estimate, inversion_collateral_OR = fisher.test(sv_collateral_dependency_matrix_INVERSIONS)$estimate, deletion_partner_OR = fisher.test(sv_partner_dependency_matrix_DELETIONS)$estimate, deletion_collateral_OR = fisher.test(sv_collateral_dependency_matrix_DELETIONS)$estimate, duplication_partner_OR = fisher.test(sv_partner_dependency_matrix_DUPLICATIONS)$estimate, duplication_collateral_OR = fisher.test(sv_collateral_dependency_matrix_DUPLICATIONS)$estimate) 

count = count + 1
print(count)
    
}

cell_lines_and_fusion_partner_and_collateral_gene_ORs_tibble <- cell_lines_and_fusion_partner_and_collateral_gene_ORs_tibble %>% remove_missing()

cell_lines_and_fusion_partner_and_collateral_gene_ORs_tibble_filtered_to_cell_lines_with_fusions_with_WGS_evidence <- cell_lines_and_fusion_partner_and_collateral_gene_ORs_tibble %>% filter(cell_line %in% cell_lines_with_SV_and_dependency_data_and_fusions_with_supporting_WGS_DepMap_IDs)

cell_lines_and_fusion_partner_and_collateral_gene_ORs_tibble_filtered_to_cell_lines_with_fusions_with_WGS_evidence_gathered <- gather(cell_lines_and_fusion_partner_and_collateral_gene_ORs_tibble_filtered_to_cell_lines_with_fusions_with_WGS_evidence, key = "category", value = "odds_ratio", -cell_line)

cell_lines_and_fusion_partner_and_collateral_gene_ORs_tibble_filtered_to_cell_lines_with_fusions_with_WGS_evidence_gathered$category <- factor(cell_lines_and_fusion_partner_and_collateral_gene_ORs_tibble_filtered_to_cell_lines_with_fusions_with_WGS_evidence_gathered$category, levels = c("fusion_partner_OR","translocation_partner_OR","inversion_partner_OR","deletion_partner_OR","duplication_partner_OR","fusion_collateral_OR","translocation_collateral_OR","inversion_collateral_OR","deletion_collateral_OR","duplication_collateral_OR"))

```

#Modified collateral dependency analysis using genomic distances instead of TAD boundaries for fusions supported by SV evidence
```{r}

cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances <- list()

counter = 0

for(cell_line in cell_lines_with_SV_and_dependency_data_DepMap_IDs){

cell_line_gene_tibble <- ccle_dependency_probability_matrix_df_with_SV %>% filter(!is.na(get(cell_line))) %>% distinct(gene) %>% mutate(cell_line) %>% dplyr::select(cell_line,gene)

genes_that_are_absolute_dependencies <- ccle_dependency_probability_matrix_df_with_SV %>% filter(get(cell_line) > 0.5) %>% distinct(gene) %>% unlist() %>% unname()

left_genes_involved_in_structural_variants <- fusions_with_supporting_WGS_evidence %>% filter(DepMap_ID == cell_line) %>% dplyr::select(left_gene) %>% unlist() %>% unname()

right_genes_involved_in_structural_variants <- fusions_with_supporting_WGS_evidence %>% filter(DepMap_ID == cell_line) %>% dplyr::select(right_gene) %>% unlist() %>% unname()

all_genes_involved_in_structural_variants <- unique(c(left_genes_involved_in_structural_variants,right_genes_involved_in_structural_variants))

genomic_windows_for_all_genes_involved_in_structural_variants <- gene_coordinate_table_hg38 %>% filter(hgnc_symbol %in% all_genes_involved_in_structural_variants) %>% mutate(genomic_window_start = start_position - half_of_mean_TAD_size, genomic_window_end = start_position + half_of_mean_TAD_size) %>% dplyr::rename(chromosome = "chromosome_name") %>% dplyr::select(chromosome, genomic_window_start, genomic_window_end)

all_genes_in_genomic_windows_of_structural_variants <- sqldf('SELECT gene_coordinate_table_hg38.*,genomic_windows_for_all_genes_involved_in_structural_variants.* FROM gene_coordinate_table_hg38 INNER JOIN genomic_windows_for_all_genes_involved_in_structural_variants ON (gene_coordinate_table_hg38.start_position BETWEEN genomic_windows_for_all_genes_involved_in_structural_variants.genomic_window_start AND genomic_windows_for_all_genes_involved_in_structural_variants.genomic_window_end) AND (gene_coordinate_table_hg38.chromosome_name = genomic_windows_for_all_genes_involved_in_structural_variants.chromosome)') %>% distinct(hgnc_symbol) %>% unlist() %>% unname()

collateral_genes_in_TADS_of_structural_variants <- setdiff(all_genes_in_genomic_windows_of_structural_variants, all_genes_involved_in_structural_variants)

cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances[[cell_line]] <- cell_line_gene_tibble %>% mutate(dependency = gene %in% genes_that_are_absolute_dependencies, sv_partner_gene = gene %in% all_genes_involved_in_structural_variants, sv_collateral_gene = gene %in% collateral_genes_in_TADS_of_structural_variants)

counter = counter + 1
print(counter)

}

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances <- bind_rows(cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances)

#Fisher's exact to check whether other genes in the same TADs as structural variants (collateral) are more likely to be dependencies than those that are not

sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances %>% filter(sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances %>% filter(sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances %>% filter(sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances %>% filter(sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances,sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances,sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances,sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances),nrow = 2)

fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances)

```

#Enrichment of fusions with associated dependencies vs those without for COSMIC status or involvement of COSMIC genes
```{r}

fusions_with_partner_dependencies <- distinct_fusion_dependency_pairings %>% filter(is_partner==TRUE) %>% distinct(Fusion) %>% unlist() %>% unname()

fusions_with_collateral_dependencies <- distinct_fusion_dependency_pairings %>% filter(is_partner==FALSE) %>% distinct(Fusion) %>% unlist() %>% unname()

fusions_with_dependency_and_cosmic_status <- tibble(fusion = ALL_fusions_with_dependency_data)

fusions_with_dependency_and_cosmic_status <- fusions_with_dependency_and_cosmic_status %>% mutate(partner_dependency = fusion %in% fusions_with_partner_dependencies, collateral_dependency = fusion %in% fusions_with_collateral_dependencies, cosmic_fusion = fusion %in% cosmic_fusions$value, fusion_partner_cosmic_gene = (str_split_fixed(fusion,"-",2)[,1] %in% cosmic_census_gene_symbols) | (str_split_fixed(fusion,"-",2)[,2] %in% cosmic_census_gene_symbols))

#Are fusions with partner dependencies more likely to be COSMIC fusions?

fusion_partner_dependency_TRUE_cosmic_fusion_TRUE <- fusions_with_dependency_and_cosmic_status %>% filter(partner_dependency == TRUE & cosmic_fusion == TRUE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_partner_dependency_TRUE_cosmic_fusion_FALSE <- fusions_with_dependency_and_cosmic_status %>% filter(partner_dependency == TRUE & cosmic_fusion == FALSE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_partner_dependency_FALSE_cosmic_fusion_TRUE <- fusions_with_dependency_and_cosmic_status %>% filter(partner_dependency == FALSE & cosmic_fusion == TRUE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_partner_dependency_FALSE_cosmic_fusion_FALSE <- fusions_with_dependency_and_cosmic_status %>% filter(partner_dependency == FALSE & cosmic_fusion == FALSE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_partner_dependency_cosmic_fusion_matrix <- matrix(c(fusion_partner_dependency_TRUE_cosmic_fusion_TRUE,fusion_partner_dependency_TRUE_cosmic_fusion_FALSE,fusion_partner_dependency_FALSE_cosmic_fusion_TRUE,fusion_partner_dependency_FALSE_cosmic_fusion_FALSE), nrow = 2)

fisher.test(fusion_partner_dependency_cosmic_fusion_matrix)

#Are fusions with partner dependencies more likely to involve COSMIC genes?

fusion_partner_dependency_TRUE_cosmic_gene_TRUE <- fusions_with_dependency_and_cosmic_status %>% filter(partner_dependency == TRUE & fusion_partner_cosmic_gene == TRUE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_partner_dependency_TRUE_cosmic_gene_FALSE <- fusions_with_dependency_and_cosmic_status %>% filter(partner_dependency == TRUE & fusion_partner_cosmic_gene == FALSE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_partner_dependency_FALSE_cosmic_gene_TRUE <- fusions_with_dependency_and_cosmic_status %>% filter(partner_dependency == FALSE & fusion_partner_cosmic_gene == TRUE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_partner_dependency_FALSE_cosmic_gene_FALSE <- fusions_with_dependency_and_cosmic_status %>% filter(partner_dependency == FALSE & fusion_partner_cosmic_gene == FALSE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_partner_dependency_cosmic_gene_matrix <- matrix(c(fusion_partner_dependency_TRUE_cosmic_gene_TRUE,fusion_partner_dependency_TRUE_cosmic_gene_FALSE,fusion_partner_dependency_FALSE_cosmic_gene_TRUE,fusion_partner_dependency_FALSE_cosmic_gene_FALSE), nrow = 2)

fisher.test(fusion_partner_dependency_cosmic_gene_matrix)

#Are fusions with collateral dependencies more likely to be COSMIC fusions?

fusion_collateral_dependency_TRUE_cosmic_fusion_TRUE <- fusions_with_dependency_and_cosmic_status %>% filter(collateral_dependency == TRUE & cosmic_fusion == TRUE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_collateral_dependency_TRUE_cosmic_fusion_FALSE <- fusions_with_dependency_and_cosmic_status %>% filter(collateral_dependency == TRUE & cosmic_fusion == FALSE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_collateral_dependency_FALSE_cosmic_fusion_TRUE <- fusions_with_dependency_and_cosmic_status %>% filter(collateral_dependency == FALSE & cosmic_fusion == TRUE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_collateral_dependency_FALSE_cosmic_fusion_FALSE <- fusions_with_dependency_and_cosmic_status %>% filter(collateral_dependency == FALSE & cosmic_fusion == FALSE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_collateral_dependency_cosmic_fusion_matrix <- matrix(c(fusion_collateral_dependency_TRUE_cosmic_fusion_TRUE,fusion_collateral_dependency_TRUE_cosmic_fusion_FALSE,fusion_collateral_dependency_FALSE_cosmic_fusion_TRUE,fusion_collateral_dependency_FALSE_cosmic_fusion_FALSE), nrow = 2)

fisher.test(fusion_collateral_dependency_cosmic_fusion_matrix)

#Are fusions with collateral dependencies more likely to involve COSMIC genes?

fusion_collateral_dependency_TRUE_cosmic_gene_TRUE <- fusions_with_dependency_and_cosmic_status %>% filter(collateral_dependency == TRUE & fusion_partner_cosmic_gene == TRUE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_collateral_dependency_TRUE_cosmic_gene_FALSE <- fusions_with_dependency_and_cosmic_status %>% filter(collateral_dependency == TRUE & fusion_partner_cosmic_gene == FALSE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_collateral_dependency_FALSE_cosmic_gene_TRUE <- fusions_with_dependency_and_cosmic_status %>% filter(collateral_dependency == FALSE & fusion_partner_cosmic_gene == TRUE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_collateral_dependency_FALSE_cosmic_gene_FALSE <- fusions_with_dependency_and_cosmic_status %>% filter(collateral_dependency == FALSE & fusion_partner_cosmic_gene == FALSE) %>% summarise(n_distinct(fusion)) %>% unlist() %>% unname()

fusion_collateral_dependency_cosmic_gene_matrix <- matrix(c(fusion_collateral_dependency_TRUE_cosmic_gene_TRUE,fusion_collateral_dependency_TRUE_cosmic_gene_FALSE,fusion_collateral_dependency_FALSE_cosmic_gene_TRUE,fusion_collateral_dependency_FALSE_cosmic_gene_FALSE), nrow = 2)

fisher.test(fusion_collateral_dependency_cosmic_gene_matrix)

```

#Genome-scale dependency and unbiased differential expression analysis of fusion-associated genes
```{r}

TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries <- tibble(Fusion=NA,Gene=NA,Cell_Count=NA)
TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries <- tibble(Fusion=NA,Gene=NA,Cell_Count=NA)

dependency_probability_fusion_with_vs_without_stats <- list()
dependency_probability_fusion_with_vs_without_stats_matrix <- list()
expression_fusion_with_vs_without_stats <- list()
expression_fusion_with_vs_without_stats_matrix <- list()

left_gene_TAD_neighbors <- list()
right_gene_TAD_neighbors <- list()
fusion_partners <- list()

left_gene_TAD_neighbors_expression_quartiles <- list()
right_gene_TAD_neighbors_expression_quartiles <- list()
fusion_partners_expression_quartiles <- list()

counter = 0

for(fusion in ALL_fusions_with_dependency_data){
  
#Cell lines with dependency data that have fusion of interest and those that don't
cell_lines_with_fusion_dependency <- ALL_fusions_protein_coding_filtered_list_final %>% dplyr::filter(Fusion == fusion) %>% distinct(DepMap_ID) %>% unlist() %>% unname() %>% intersect(colnames(ccle_dependency_probability_matrix))

cell_lines_without_fusion_dependency <- ccle_dependency_probability %>% dplyr::filter(!(DepMap_ID %in% cell_lines_with_fusion_dependency)) %>% distinct(DepMap_ID) %>% unlist() %>% unname()

#Cell lines with expression data that have fusion of interest and those that don't
cell_lines_with_fusion_expression <- ALL_fusions_protein_coding_filtered_list_final %>% dplyr::filter(Fusion == fusion) %>% distinct(DepMap_ID) %>% unlist() %>% unname() %>% intersect(colnames(ccle_expression_protein_coding_log2tpm_matrix))

cell_lines_without_fusion_expression <- ccle_expression_protein_coding_log2tpm %>% dplyr::filter(!(DepMap_ID %in% cell_lines_with_fusion_expression)) %>% distinct(DepMap_ID) %>% unlist() %>% unname()

#Fusion partners
left_gene_fusion <- str_split_fixed(fusion,"-",2)[,1]
right_gene_fusion <- str_split_fixed(fusion,"-",2)[,2]
fusion_partners[[fusion]] <- c(left_gene_fusion,right_gene_fusion)

#If there is at least one cell line that has dependency data, then proceed
if(length(cell_lines_with_fusion_dependency) > 0 & length(cell_lines_without_fusion_dependency) > 0){
  
#Create expression matrices for cell lines that have the fusion and cell lines that don't
ccle_expression_matrix_with_fusion <- ccle_expression_protein_coding_log2tpm_matrix %>% subset(select = cell_lines_with_fusion_expression)

ccle_expression_matrix_without_fusion <- ccle_expression_protein_coding_log2tpm_matrix %>% subset(select = cell_lines_without_fusion_expression)

#Compare expression between the two groups with two sample t-test with equal variance and correct p-values using Benjamini-Hochberg procedure for multiple hypothesis testing. Also categorize by quartile of differential expression. Then create an abstracted binary matrix
expression_fusion_with_vs_without_stats[[fusion]] <- row_t_equalvar(ccle_expression_matrix_with_fusion, ccle_expression_matrix_without_fusion) %>% dplyr::mutate(BH_QValue = p.adjust(pvalue, "BH", length(ccle_expression_matrix_with_fusion[,1]))) %>% dplyr::mutate(negative_log10_BH_QValue = -log10(BH_QValue), gene = ccle_expression_protein_coding_log2tpm_matrix_df$gene) %>% dplyr::rename(log2_fold_change = `mean.diff`, expression_with_fusion = `mean.x`, expression_without_fusion = `mean.y`) %>% dplyr::select(gene, log2_fold_change, expression_with_fusion, expression_without_fusion, negative_log10_BH_QValue) %>% mutate(log2_fold_change_quartile = ntile(log2_fold_change,4))

expression_fusion_with_vs_without_stats_matrix[[fusion]] <- expression_fusion_with_vs_without_stats[[fusion]] %>% mutate(overexpressed = ifelse(log2_fold_change > 1,1,0), significant = ifelse(negative_log10_BH_QValue > -log10(.05),1,0), overexpressed_and_significant = ifelse(overexpressed == 1 & significant == 1, 1, 0)) %>% dplyr::select(overexpressed_and_significant,log2_fold_change_quartile)

#Create dependency matrices for cell lines that have the fusion and cell lines that don't  
ccle_dependency_probability_matrix_with_fusion <- ccle_dependency_probability_matrix %>% subset(select = cell_lines_with_fusion_dependency)

ccle_dependency_probability_matrix_without_fusion <- ccle_dependency_probability_matrix %>% subset(select = cell_lines_without_fusion_dependency)

#Compare dependency between the two groups with two sample t-test with equal variance and correct p-values using Benjamini-Hochberg procedure for multiple hypothesis testing. Also categorize by quartile of differential expression (joined from above). Then create an abstracted binary matrix
dependency_probability_fusion_with_vs_without_stats[[fusion]] <- row_t_equalvar(ccle_dependency_probability_matrix_with_fusion, ccle_dependency_probability_matrix_without_fusion) %>% dplyr::mutate(BH_QValue = p.adjust(pvalue, "BH", length(ccle_dependency_probability_matrix_with_fusion[,1]))) %>% dplyr::mutate(negative_log10_BH_QValue = -log10(BH_QValue), gene = ccle_dependency_probability_matrix_df$gene) %>% dplyr::rename(dependency_probability_difference = `mean.diff`, dependency_probability_with_fusion = `mean.x`, dependency_probability_without_fusion = `mean.y`) %>% dplyr::select(gene, dependency_probability_difference, dependency_probability_with_fusion, dependency_probability_without_fusion, negative_log10_BH_QValue)

dependency_probability_fusion_with_vs_without_stats[[fusion]] <- merge(dependency_probability_fusion_with_vs_without_stats[[fusion]],expression_fusion_with_vs_without_stats[[fusion]][,c("gene","log2_fold_change_quartile")],by = c("gene","gene"),all.x = TRUE)

dependency_probability_fusion_with_vs_without_stats_matrix[[fusion]] <- dependency_probability_fusion_with_vs_without_stats[[fusion]] %>% mutate(dependency = ifelse(dependency_probability_difference > 0.5,1,0), significant = ifelse(negative_log10_BH_QValue > -log10(.05),1,0), dependency_and_significant = ifelse(dependency == 1 & significant == 1, 1, 0)) %>% dplyr::select(dependency_and_significant,log2_fold_change_quartile)

#If the partner gene falls into a TAD then proceed to identify the other genes that fall into that TAD that are not the fusion partners themselves
if(left_gene_fusion %in% Gene_TAD_table$gene){

left_gene_TAD <- Gene_TAD_table %>% filter(gene == left_gene_fusion) %>% dplyr::select(TAD_identifier) %>% unlist() %>% unname()
left_gene_TAD_neighbors[[fusion]] <- Gene_TAD_table %>% filter(TAD_identifier == left_gene_TAD) %>% dplyr::select(gene) %>% unlist() %>% unname()
left_gene_TAD_neighbors[[fusion]] <- left_gene_TAD_neighbors[[fusion]][!left_gene_TAD_neighbors[[fusion]] %in% c(left_gene_fusion,right_gene_fusion)]

#If the partner gene falls into a TAD boundary (and not a single TAD) then look to see if there is an upstream or downstream TAD that is within 40Kb of the gene. If so, identify the genes that fall into the upstream and/or downstream TADs (should not include the fusion partners themselves)
} else if(left_gene_fusion %in% Gene_TAD_boundary_table$gene){
left_gene_upstream_TAD <- Gene_TAD_boundary_table %>% filter(gene == left_gene_fusion) %>% dplyr::select(upstream_TAD_identifier) %>% unlist() %>% unname()

left_gene_downstream_TAD <- Gene_TAD_boundary_table %>% filter(gene == left_gene_fusion) %>% dplyr::select(downstream_TAD_identifier) %>% unlist() %>% unname()

left_gene_TADs <- c(left_gene_upstream_TAD,left_gene_downstream_TAD)

left_gene_TADs <- left_gene_TADs[!is.na(left_gene_TADs)]

left_gene_TAD_neighbors[[fusion]] <- Gene_TAD_table %>% filter(TAD_identifier %in% left_gene_TADs) %>% dplyr::select(gene) %>% unlist() %>% unname()

#If the partner gene has no plausibly associated TADs, say there are no genes that are close to it
} else{
left_gene_TAD_neighbors[[fusion]] <- c()  
}

#If the partner gene falls into a TAD then proceed to identify the other genes that fall into that TAD that are not the fusion partners themselves
if(right_gene_fusion %in% Gene_TAD_table$gene){
  
right_gene_TAD <- Gene_TAD_table %>% filter(gene == right_gene_fusion) %>% dplyr::select(TAD_identifier) %>% unlist() %>% unname()
right_gene_TAD_neighbors[[fusion]] <- Gene_TAD_table %>% filter(TAD_identifier == right_gene_TAD) %>% dplyr::select(gene) %>% unlist() %>% unname()
right_gene_TAD_neighbors[[fusion]] <- right_gene_TAD_neighbors[[fusion]][!right_gene_TAD_neighbors[[fusion]] %in% c(left_gene_fusion,right_gene_fusion)]

#If the partner gene falls into a TAD boundary (and not a single TAD) then look to see if there is an upstream or downstream TAD that is within 40Kb of the gene. If so, identify the genes that fall into the upstream and/or downstream TADs (should not include the fusion partners themselves)
} else if(right_gene_fusion %in% Gene_TAD_boundary_table$gene){
right_gene_upstream_TAD <- Gene_TAD_boundary_table %>% filter(gene == right_gene_fusion) %>% dplyr::select(upstream_TAD_identifier) %>% unlist() %>% unname()

right_gene_downstream_TAD <- Gene_TAD_boundary_table %>% filter(gene == right_gene_fusion) %>% dplyr::select(downstream_TAD_identifier) %>% unlist() %>% unname()

right_gene_TADs <- c(right_gene_upstream_TAD,right_gene_downstream_TAD)

right_gene_TADs <- right_gene_TADs[!is.na(right_gene_TADs)]

right_gene_TAD_neighbors[[fusion]] <- Gene_TAD_table %>% filter(TAD_identifier %in% right_gene_TADs) %>% dplyr::select(gene) %>% unlist() %>% unname()

#If the partner gene has no plausibly associated TADs, say there are no genes that are close to it
} else{
right_gene_TAD_neighbors[[fusion]] <- c()  
}

#Summary stats dependency tables for the genes in close proximity to the fusion partners
dependency_probability_fusion_with_vs_without_stats_left_gene_TAD_neighbors <- dependency_probability_fusion_with_vs_without_stats[[fusion]] %>% dplyr::filter(gene %in% c(left_gene_TAD_neighbors[[fusion]], left_gene_fusion))

dependency_probability_fusion_with_vs_without_stats_right_gene_TAD_neighbors <- dependency_probability_fusion_with_vs_without_stats[[fusion]] %>% dplyr::filter(gene %in% c(right_gene_TAD_neighbors[[fusion]],right_gene_fusion))

#Summary stats expression tables for the genes in close proximity to the fusion partners
expression_fusion_with_vs_without_stats_left_gene_TAD_neighbors <- expression_fusion_with_vs_without_stats[[fusion]] %>% dplyr::filter(gene %in% c(left_gene_TAD_neighbors[[fusion]], left_gene_fusion))

expression_fusion_with_vs_without_stats_right_gene_TAD_neighbors <- expression_fusion_with_vs_without_stats[[fusion]] %>% dplyr::filter(gene %in% c(right_gene_TAD_neighbors[[fusion]],right_gene_fusion))

#For left partner or neighbors, if the gene has dependency data and is a significant dependency, then add the fusion, gene, and number of cells to the total signficant fusion-associated dependency table. Same if overexpression is significant
for(neighbor in c(left_gene_TAD_neighbors[[fusion]], left_gene_fusion)){

if(neighbor %in% ccle_dependency_probability_matrix_df$gene){
  
if(!subset(dependency_probability_fusion_with_vs_without_stats_left_gene_TAD_neighbors, subset = gene == neighbor, select = dependency_probability_difference) %>% unlist() %>% unname() == "NaN"){
  
if(subset(dependency_probability_fusion_with_vs_without_stats_left_gene_TAD_neighbors, subset = gene == neighbor, select = dependency_probability_difference) %>% unlist() %>% unname() >= 0.5 & subset(dependency_probability_fusion_with_vs_without_stats_left_gene_TAD_neighbors, subset = gene == neighbor, select = negative_log10_BH_QValue) %>% unlist() %>% unname() >= -log10(.05)){
  
TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries <- add_row(TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries, Fusion = fusion, Gene = neighbor, Cell_Count = length(cell_lines_with_fusion_dependency))

}
}
}
  
if(neighbor %in% ccle_expression_protein_coding_log2tpm_matrix_df$gene){
  
if(!subset(expression_fusion_with_vs_without_stats_left_gene_TAD_neighbors, subset = gene == neighbor, select = log2_fold_change) %>% unlist() %>% unname() == "NaN"){
  
if(subset(expression_fusion_with_vs_without_stats_left_gene_TAD_neighbors, subset = gene == neighbor, select = log2_fold_change) %>% unlist() %>% unname() >= 1 & subset(expression_fusion_with_vs_without_stats_left_gene_TAD_neighbors, subset = gene == neighbor, select = negative_log10_BH_QValue) %>% unlist() %>% unname() >= -log10(.05)){
  
TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries <- add_row(TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries, Fusion = fusion, Gene = neighbor, Cell_Count = length(cell_lines_with_fusion_expression))
  
}
}
}
  
}

#For right partner or neighbors, if the gene has dependency data and is a significant dependency, then add the fusion, gene, and number of cells to the total signficant fusion-associated dependency table. Same if overexpression is significant  
for(neighbor in c(right_gene_TAD_neighbors[[fusion]],right_gene_fusion)){

if(neighbor %in% ccle_dependency_probability_matrix_df$gene){
  
if(!subset(dependency_probability_fusion_with_vs_without_stats_right_gene_TAD_neighbors, subset = gene == neighbor, select = dependency_probability_difference) %>% unlist() %>% unname() == "NaN"){
  
if(subset(dependency_probability_fusion_with_vs_without_stats_right_gene_TAD_neighbors, subset = gene == neighbor, select = dependency_probability_difference) %>% unlist() %>% unname() >= 0.5 & subset(dependency_probability_fusion_with_vs_without_stats_right_gene_TAD_neighbors, subset = gene == neighbor, select = negative_log10_BH_QValue) %>% unlist() %>% unname() >= -log10(.05)){
  
TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries <- add_row(TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries, Fusion = fusion, Gene = neighbor, Cell_Count = length(cell_lines_with_fusion_dependency))
  
}
}
}
  
if(neighbor %in% ccle_expression_protein_coding_log2tpm_matrix_df$gene){
  
if(!subset(expression_fusion_with_vs_without_stats_right_gene_TAD_neighbors, subset = gene == neighbor, select = log2_fold_change) %>% unlist() %>% unname() == "NaN"){
  
if(subset(expression_fusion_with_vs_without_stats_right_gene_TAD_neighbors, subset = gene == neighbor, select = log2_fold_change) %>% unlist() %>% unname() >= 1 & subset(expression_fusion_with_vs_without_stats_right_gene_TAD_neighbors, subset = gene == neighbor, select = negative_log10_BH_QValue) %>% unlist() %>% unname() >= -log10(.05)){
  
TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries <- add_row(TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries, Fusion = fusion, Gene = neighbor, Cell_Count = length(cell_lines_with_fusion_expression))

}
}
}  
  
}

#Make vectors of the expression quartiles of left partner TAD associated genes, right partner TAD associated genes, and both partners. Note that this inherently filters these lists for 1) genes that are protein-coding and 2) genes that have associated dependency data
left_gene_TAD_neighbors_expression_quartiles[[fusion]] <- dependency_probability_fusion_with_vs_without_stats[[fusion]] %>% filter(gene %in% left_gene_TAD_neighbors[[fusion]]) %>% dplyr::select(log2_fold_change_quartile) %>% unlist() %>% unname()

right_gene_TAD_neighbors_expression_quartiles[[fusion]] <- dependency_probability_fusion_with_vs_without_stats[[fusion]] %>% filter(gene %in% right_gene_TAD_neighbors[[fusion]]) %>% dplyr::select(log2_fold_change_quartile) %>% unlist() %>% unname() 

fusion_partners_expression_quartiles[[fusion]] <- dependency_probability_fusion_with_vs_without_stats[[fusion]] %>% filter(gene %in% fusion_partners[[fusion]]) %>% dplyr::select(log2_fold_change_quartile) %>% unlist() %>% unname() 

}

counter = counter + 1
print(counter)

}

TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries <- TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries %>% remove_missing()
TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries <- TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries %>% mutate(is_partner = Gene == str_split_fixed(Fusion,"-",2)[,1] | Gene == str_split_fixed(Fusion,"-",2)[,2])

TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries <- TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries %>% remove_missing()
TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries <- TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries %>% mutate(is_partner = Gene == str_split_fixed(Fusion,"-",2)[,1] | Gene == str_split_fixed(Fusion,"-",2)[,2])

#Create list by fusion of all unique coding TAD neighbors with dependency data available (which are the lists that should be used for permutation). Doing this to avoid "double counting" for permutations later on
all_unique_coding_TAD_neighbors_with_dependency_data <- list()
all_unique_coding_TAD_neighbors_with_dependency_data_expression_quartiles <- list()
counter = 0

for(fusion in ALL_fusions_with_dependency_data){

all_unique_coding_TAD_neighbors_with_dependency_data[[fusion]] <- dependency_probability_fusion_with_vs_without_stats[[fusion]] %>% dplyr::filter(gene %in% c(left_gene_TAD_neighbors[[fusion]], right_gene_TAD_neighbors[[fusion]])) %>% dplyr::select(gene) %>% unlist() %>% unname() 

counter = counter + 1
print(counter)
  
}

#Lists of corresponding expression quartiles for all unique coding TAD neighbors with dependency data available
for(fusion in ALL_fusions_with_dependency_data){

all_unique_coding_TAD_neighbors_with_dependency_data_expression_quartiles[[fusion]] <- dependency_probability_fusion_with_vs_without_stats[[fusion]] %>% filter(gene %in% all_unique_coding_TAD_neighbors_with_dependency_data[[fusion]]) %>% dplyr::select(log2_fold_change_quartile) %>% unlist() %>% unname()     

counter = counter + 1
print(counter)
  
}

```

#Count of fusion-associated dependencies from genome-scale screen
```{r}

TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries_duplicates_marked <- TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries %>% mutate(Fusion_Inverse = str_c(str_split_fixed(Fusion,"-",2)[,2],"-",str_split_fixed(Fusion,"-",2)[,1])) %>% mutate(Duplicate = Fusion_Inverse %in% TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries$Fusion)

TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed <- TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries_duplicates_marked %>% filter(!Fusion %in% c("ABL1-BCR", "C2orf69-ROCK2", "HNRNPC-RAD51B", "RARA-PML"))

TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed <- TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed %>% mutate(Fusion_Dependency_Pairing = str_c(Fusion,"-",Gene)) %>% distinct(Fusion,Gene,Cell_Count,is_partner,Fusion_Inverse,Duplicate,Fusion_Dependency_Pairing)

#Distinct Fusion-Dependency Pairings
distinct_fusion_dependency_pairings <- TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed %>% distinct(Fusion,Gene,is_partner)

count_of_partner_fusion_dependency_pairings <- distinct_fusion_dependency_pairings %>% filter(is_partner == TRUE) %>% summarise(n_distinct(Fusion,Gene)) %>% unlist() %>% unname()

count_of_actual_fusion_dependency_pairings <- distinct_fusion_dependency_pairings %>% filter(is_partner == FALSE) %>% summarise(n_distinct(Fusion,Gene)) %>% unlist() %>% unname()

#List of dependencies identified and the number of fusions they are associated with
distinct_fusion_dependency_pairings_count_of_fusions <- distinct_fusion_dependency_pairings %>% group_by(Gene) %>% dplyr::summarise(count_of_fusions = n_distinct(Fusion)) %>% arrange(desc(count_of_fusions))

#For each unique fusion-dependency pairing, list all the cell lines in which it is seen
cell_lines_associated_with_each_gene_and_fusion <- tibble(gene = NA, fusion = NA, cell_lines = NA, CCLE_names = NA)

for(gene in unique(distinct_fusion_dependency_pairings$Gene)){
  
fusions_with_gene_as_dependency <- distinct_fusion_dependency_pairings %>% filter(Gene == gene) %>% distinct(Fusion) %>% unlist() %>% unname()

for(fusion in fusions_with_gene_as_dependency){

cell_lines_associated_with_each_gene_and_fusion <- add_row(cell_lines_associated_with_each_gene_and_fusion, gene = gene, fusion = fusion, cell_lines = str_c(ALL_fusions_protein_coding_filtered_list_final %>% filter(Fusion == fusion & DepMap_ID %in% colnames(ccle_dependency_probability_matrix)) %>% distinct(DepMap_ID) %>% unlist() %>% unname(), collapse = ", "), CCLE_names = str_c(ALL_fusions_protein_coding_filtered_list_final %>% filter(Fusion == fusion & DepMap_ID %in% colnames(ccle_dependency_probability_matrix)) %>% distinct(CCLE_Name) %>% unlist() %>% unname(), collapse = ", "))
  
}

}

cell_lines_associated_with_each_gene_and_fusion <- cell_lines_associated_with_each_gene_and_fusion %>% remove_missing()

cell_lines_associated_with_each_gene_and_fusion <- cell_lines_associated_with_each_gene_and_fusion %>% mutate(is_partner = gene == str_split_fixed(fusion,"-",2)[,1] | gene == str_split_fixed(fusion,"-",2)[,2])

cell_lines_associated_with_each_gene_and_fusion <- cell_lines_associated_with_each_gene_and_fusion %>% mutate(cell_line_count = str_count(cell_lines,"ACH"))

cell_lines_associated_with_each_gene_and_fusion <- cell_lines_associated_with_each_gene_and_fusion %>% mutate(left_fusion_partner = str_split_fixed(fusion,"-",2)[,1], right_fusion_partner = str_split_fixed(fusion,"-",2)[,2])

cell_lines_associated_with_each_gene_and_fusion <- cell_lines_associated_with_each_gene_and_fusion %>% dplyr::select(fusion,left_fusion_partner,right_fusion_partner,gene,is_partner,cell_lines,CCLE_names,cell_line_count)

#Develop a conservative count for the number of fusion-dependency pairings by removing instances in which the same dependency is associated with multiple fusions in the same cell line (to account for complex rearrangements). This is used as the comparator for the number of fusion-dependency pairings expected by chance in subsequent permutation analysis.

distinct_fusion_dependency_cell_line_pairings <- cell_lines_associated_with_each_gene_and_fusion %>% distinct(gene,cell_lines,is_partner) %>% arrange(desc(is_partner)) %>% arrange(gene,cell_lines) 

distinct_fusion_dependency_cell_line_pairings <- distinct_fusion_dependency_cell_line_pairings %>% mutate(duplicate = duplicated(str_c(gene,cell_lines)))

distinct_fusion_dependency_cell_line_pairings_duplicates_removed <- distinct_fusion_dependency_cell_line_pairings %>% filter(duplicate == FALSE)

count_of_partner_fusion_dependency_pairings_conservative <- distinct_fusion_dependency_cell_line_pairings_duplicates_removed %>% filter(is_partner == TRUE) %>% summarise(n_distinct(gene,cell_lines)) %>% unlist() %>% unname()

count_of_partner_fusion_dependency_pairings_conservative_adjusted <- count_of_partner_fusion_dependency_pairings_conservative - 1

count_of_other_TAD_fusion_dependency_pairings_conservative <- distinct_fusion_dependency_cell_line_pairings_duplicates_removed %>% filter(is_partner == FALSE) %>% summarise(n_distinct(gene,cell_lines)) %>% unlist() %>% unname()

count_of_other_TAD_fusion_dependency_pairings_conservative_adjusted <- count_of_other_TAD_fusion_dependency_pairings_conservative - 3

count_of_actual_fusion_dependency_pairings_conservative <- tibble(partner_or_other_TAD = c("partner","other_TAD"), count = c(count_of_partner_fusion_dependency_pairings_conservative_adjusted, count_of_other_TAD_fusion_dependency_pairings_conservative_adjusted))

#Count of all dependencies fusion context
count_of_all_dependencies_for_fusion_context <- tibble(fusion = NA, count_of_all_dependencies = NA)

count = 0

for(fusion in ALL_fusions_with_dependency_data){
  
count_of_all_dependencies_for_fusion_context <- add_row(count_of_all_dependencies_for_fusion_context,fusion = fusion, count_of_all_dependencies = dependency_probability_fusion_with_vs_without_stats_matrix[[fusion]] %>% summarise(sum(dependency_and_significant, na.rm = TRUE)) %>% unlist() %>% unname())

count = count + 1
print(count)

}

count_of_all_dependencies_for_fusion_context <- count_of_all_dependencies_for_fusion_context %>% remove_missing()

#Write output of fusion-dependency pairings
write_tsv(TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed, here::here("results/datatables","TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed.tsv"))

write_tsv(distinct_fusion_dependency_pairings, here::here("results/datatables","distinct_fusion_dependency_pairings.tsv"))


```

#Count of fusion-associated overexpressed genes from genome-scale screen
```{r}

TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries_duplicates_marked <- TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries %>% mutate(Fusion_Inverse = str_c(str_split_fixed(Fusion,"-",2)[,2],"-",str_split_fixed(Fusion,"-",2)[,1])) %>% mutate(Duplicate = Fusion_Inverse %in% TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries$Fusion)

TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed <- TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries_duplicates_marked %>% filter(!Fusion %in% c("ABL1-BCR", "NSD2-IGH"))

TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed <- TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed %>% mutate(Fusion_Overexpression_Pairing = str_c(Fusion,"-",Gene)) %>% distinct(Fusion,Gene,Cell_Count,is_partner,Fusion_Inverse,Duplicate,Fusion_Overexpression_Pairing)

#Write output of fusion-overexpressed gene pairings
write_tsv(TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed, here::here("results/datatables","TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed.tsv"))

```

#Permuting gene labels to determine total number of fusion-associated dependencies expected by chance from genome-scale screen
```{r}

iteration_one_thousand <- c(1:1000)

multiple_iterations_cumulative_partner_dependencies_permuted_by_expression_quartiles <- c()
multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_expression_quartiles <- c()

iteration_counter = 1

for(i in iteration_one_thousand){

cumulative_partner_dependencies <- c()    
cumulative_other_TAD_dependencies <- c()

fusion_counter = 0

for(fusion in ALL_fusions_with_dependency_data){

#Binary matrix of significant dependencies (0 = no, 1 = yes) and associated expression quartile
dependency_and_significant <- dependency_probability_fusion_with_vs_without_stats_matrix[[fusion]][,c("dependency_and_significant","log2_fold_change_quartile")] 
dependency_and_significant <- dependency_and_significant %>% filter(!dependency_and_significant %>% is.na())

#Binary matrices of significant dependencies filtered for expression quartile
dependency_and_significant_first_quartile_expression <- dependency_and_significant %>% filter(log2_fold_change_quartile == 1) %>% dplyr::select(dependency_and_significant) %>% unlist() %>% unname()
dependency_and_significant_second_quartile_expression <- dependency_and_significant %>% filter(log2_fold_change_quartile == 2) %>% dplyr::select(dependency_and_significant) %>% unlist() %>% unname()
dependency_and_significant_third_quartile_expression <- dependency_and_significant %>% filter(log2_fold_change_quartile == 3) %>% dplyr::select(dependency_and_significant) %>% unlist() %>% unname()
dependency_and_significant_fourth_quartile_expression <- dependency_and_significant %>% filter(log2_fold_change_quartile == 4) %>% dplyr::select(dependency_and_significant) %>% unlist() %>% unname()

#Individually sample the number of partners with dependency data from each of the binary matrices, and sum these samples together. This is the equivalent of permuting all the genes.
sample_partner_dependency <- sum(dependency_and_significant_first_quartile_expression %>% sample(length(fusion_partners_expression_quartiles[[fusion]][fusion_partners_expression_quartiles[[fusion]] == 1])), dependency_and_significant_second_quartile_expression %>% sample(length(fusion_partners_expression_quartiles[[fusion]][fusion_partners_expression_quartiles[[fusion]] == 2])), dependency_and_significant_third_quartile_expression %>% sample(length(fusion_partners_expression_quartiles[[fusion]][fusion_partners_expression_quartiles[[fusion]] == 3])), dependency_and_significant_fourth_quartile_expression %>% sample(length(fusion_partners_expression_quartiles[[fusion]][fusion_partners_expression_quartiles[[fusion]] == 4])))

cumulative_partner_dependencies <- c(cumulative_partner_dependencies, sample_partner_dependency)

#Individually sample the number of unique coding TAD neighbors with dependency data from each of the binary matrices, and sum these samples together. This is the equivalent of permuting all the genes.
sample_other_TAD_dependency <- sum(dependency_and_significant_first_quartile_expression %>% sample(length(all_unique_coding_TAD_neighbors_with_dependency_data_expression_quartiles[[fusion]][all_unique_coding_TAD_neighbors_with_dependency_data_expression_quartiles[[fusion]] == 1])), dependency_and_significant_second_quartile_expression %>% sample(length(all_unique_coding_TAD_neighbors_with_dependency_data_expression_quartiles[[fusion]][all_unique_coding_TAD_neighbors_with_dependency_data_expression_quartiles[[fusion]] == 2])), dependency_and_significant_third_quartile_expression %>% sample(length(all_unique_coding_TAD_neighbors_with_dependency_data_expression_quartiles[[fusion]][all_unique_coding_TAD_neighbors_with_dependency_data_expression_quartiles[[fusion]] == 3])), dependency_and_significant_fourth_quartile_expression %>% sample(length(all_unique_coding_TAD_neighbors_with_dependency_data_expression_quartiles[[fusion]][all_unique_coding_TAD_neighbors_with_dependency_data_expression_quartiles[[fusion]] == 4])))

cumulative_other_TAD_dependencies <- c(cumulative_other_TAD_dependencies, sample_other_TAD_dependency)

fusion_counter = fusion_counter + 1
print(fusion_counter)

}

multiple_iterations_cumulative_partner_dependencies_permuted_by_expression_quartiles <- c(multiple_iterations_cumulative_partner_dependencies_permuted_by_expression_quartiles, cumulative_partner_dependencies %>% sum())

multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_expression_quartiles <- c(multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_expression_quartiles, cumulative_other_TAD_dependencies %>% sum())

iteration_counter = iteration_counter + 1
print(str_c("Iteration = ", iteration_counter))

}


#Write output of fusion-dependency pairings expected from gene label permutation
write_tsv(as_tibble(multiple_iterations_cumulative_partner_dependencies_permuted_by_expression_quartiles),here::here("results/datatables","multiple_iterations_cumulative_partner_dependencies_permuted_by_expression_quartiles.tsv"))

write_tsv(as_tibble(multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_expression_quartiles),here::here("results/datatables","multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_expression_quartiles.tsv"))

```

#Permuting fusion labels to determine total number of fusion-associated dependencies expected by chance from genome-scale screen
```{r}

#Creating a list of dependency probability dataframes that can be randomly shuffled

dependency_probability_fusion_with_vs_without_stats_random <- dependency_probability_fusion_with_vs_without_stats

counter = 0

for(fusion in ALL_fusions_with_dependency_data){

dependency_probability_fusion_with_vs_without_stats_random[[fusion]] <- dependency_probability_fusion_with_vs_without_stats_random[[fusion]] %>% mutate(dependency = ifelse(dependency_probability_difference > 0.5,1,0), significant = ifelse(negative_log10_BH_QValue > -log10(.05),1,0), dependency_and_significant = ifelse(dependency == 1 & significant == 1, 1, 0))

counter = counter + 1
print(counter)

}  

#Identifying most common disease type associated with each fusion, and making vectors of fusions associated with each disease type

calculate_mode <- function(x) {
  uniqx <- unique(na.omit(x))
  uniqx[which.max(tabulate(match(x, uniqx)))]
}

fusion_most_common_disease_type_tibble <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% group_by(Fusion) %>% summarise(most_common_disease_type = calculate_mode(primary_disease))

ccle_primary_diseases <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% distinct(primary_disease) %>% unlist() %>% unname()

fusions_associated_with_disease_type <- list()

for(disease in ccle_primary_diseases){
  
fusions_associated_with_disease_type[[disease]] <- fusion_most_common_disease_type_tibble %>% filter(most_common_disease_type == disease) %>% distinct(Fusion) %>% unlist() %>% unname()
  
}

#Defining functions to use in apply functions to determine number of partner or other TAD dependencies

count_of_partner_dependencies_function <- function(x){
dependency_probability_fusion_with_vs_without_stats_random_disease_subset[[x]] %>% filter(gene %in% fusion_partners[[x]]) %>% filter(!is.na(dependency_and_significant)) %>% dplyr::select(dependency_and_significant) %>% unlist() %>% unname() %>% sum()
}

count_of_other_TAD_dependencies_function <- function(x){
dependency_probability_fusion_with_vs_without_stats_random_disease_subset[[x]] %>% filter(gene %in% c(left_gene_TAD_neighbors[[x]], right_gene_TAD_neighbors[[x]])) %>% filter(!is.na(dependency_and_significant)) %>% dplyr::select(dependency_and_significant) %>% unlist() %>% unname() %>% sum()
}

#Lists to store information from permutations
count_of_partner_dependencies_phenotypic_permutation <- c()
count_of_other_TAD_dependencies_phenotypic_permutation <- c()

counter = 0

#Start of iterative for loop
for(i in iteration_one_thousand){

count_of_partner_dependencies_total <- c()
count_of_other_TAD_dependencies_total <- c()
  
#Shuffle fusions assigned to different dependencies

for(disease in ccle_primary_diseases){  

appropriate_fusion_name_order <- fusions_associated_with_disease_type[[disease]]

dependency_probability_fusion_with_vs_without_stats_random_disease_subset <- dependency_probability_fusion_with_vs_without_stats_random[appropriate_fusion_name_order]
  
random_fusion_name_order <- sample(fusions_associated_with_disease_type[[disease]], fusions_associated_with_disease_type[[disease]] %>% length())

names(dependency_probability_fusion_with_vs_without_stats_random_disease_subset) <- random_fusion_name_order

count_of_partner_dependencies <- sapply(appropriate_fusion_name_order,count_of_partner_dependencies_function)
count_of_partner_dependencies_total <- c(count_of_partner_dependencies_total,count_of_partner_dependencies)

count_of_other_TAD_dependencies <- sapply(appropriate_fusion_name_order,count_of_other_TAD_dependencies_function)
count_of_other_TAD_dependencies_total <- c(count_of_other_TAD_dependencies_total,count_of_other_TAD_dependencies)

}

count_of_partner_dependencies_total <- count_of_partner_dependencies_total %>% unlist() %>% unname()

count_of_other_TAD_dependencies_total <- count_of_other_TAD_dependencies_total %>% unlist() %>% unname()

count_of_partner_dependencies_phenotypic_permutation <- c(count_of_partner_dependencies_phenotypic_permutation, count_of_partner_dependencies_total %>% sum())

count_of_other_TAD_dependencies_phenotypic_permutation <- c(count_of_other_TAD_dependencies_phenotypic_permutation, count_of_other_TAD_dependencies_total %>% sum())

counter = counter + 1
print(counter)

}

#Write output of fusion-dependency pairings expected from fusion label permutation
write_tsv(as_tibble(count_of_partner_dependencies_phenotypic_permutation),here::here("results/datatables","count_of_partner_dependencies_phenotypic_permutation_with_disease_as_covariate.tsv"))

write_tsv(as_tibble(count_of_other_TAD_dependencies_phenotypic_permutation),here::here("results/datatables","count_of_other_TAD_dependencies_phenotypic_permutation_with_disease_as_covariate.tsv"))

```

#Hotspot mutation analysis in cell lines with and without fusion-associated depedendencies to determine which cell lines have COSMIC cancer census genes with hotspot mutations and what the average count of hotspot mutations in these cell lines is
```{r}

cosmic_census_gene_symbols <- cosmic_census_genes$`Gene Symbol`

CCLE_mutations_annotated <- left_join(CCLE_mutations,ccle_annotations, by = c("DepMap_ID" = "DepMap_ID"))

canonical_driver_mutations_in_cell_lines <- tibble(Cell_line = NA, Other_driver = NA)

cell_lines_with_fusion_calls_and_dependency_data <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% distinct(DepMap_ID) %>% unlist() %>% unname() %>% intersect(colnames(ccle_dependency_probability_matrix))

cell_lines_with_fusion_associated_dependencies <- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line$cell_lines %>% unique()

cell_lines_without_fusion_associated_dependencies <- setdiff(ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% distinct(DepMap_ID) %>% unlist() %>% unname() %>% intersect(colnames(ccle_dependency_probability_matrix)),cell_lines_with_fusion_associated_dependencies)

counter = 0

for(cell_line in cell_lines_with_fusion_calls_and_dependency_data){
  
cosmic_census_genes_with_hotspot_mutation <- CCLE_mutations_annotated %>% filter(DepMap_ID == cell_line & Hugo_Symbol %in% cosmic_census_gene_symbols & isTCGAhotspot == TRUE) %>% distinct(Hugo_Symbol) %>% unlist() %>% unname()
  
for(other_driver in cosmic_census_genes_with_hotspot_mutation){

canonical_driver_mutations_in_cell_lines <- add_row(canonical_driver_mutations_in_cell_lines, Cell_line = cell_line, Other_driver = other_driver)

}
 
counter = counter + 1
print(counter)

}

canonical_driver_mutations_in_cell_lines <- canonical_driver_mutations_in_cell_lines %>% remove_missing() %>% mutate(Cell_line_with_fusion_associated_dependency = Cell_line %in% cell_lines_with_fusion_associated_dependencies)

write_tsv(canonical_driver_mutations_in_cell_lines, here::here("results/datatables","canonical_driver_mutations_in_cell_lines.tsv"))

#Hotspot mutation summary for cell lines with fusion-associated dependencies
cell_lines_with_fusion_associated_dependencies_with_at_least_one_hotspot_driver <- canonical_driver_mutations_in_cell_lines %>% filter(Cell_line_with_fusion_associated_dependency == TRUE) %>% distinct(Cell_line)

cell_line_hotspot_mutation_combinations_for_cell_lines_with_fusion_associated_dependencies_with_at_least_one_hotspot_driver <- canonical_driver_mutations_in_cell_lines %>% filter(Cell_line_with_fusion_associated_dependency == TRUE) %>% distinct(Cell_line,Other_driver)

other_driver_count_by_cell_line <- canonical_driver_mutations_in_cell_lines %>% filter(Cell_line_with_fusion_associated_dependency == TRUE) %>% group_by(Cell_line) %>% summarise(other_driver_count = n_distinct(Other_driver))

minimum_other_driver_count_by_cell_line <- other_driver_count_by_cell_line %>% summarise(min(other_driver_count))

maximum_other_driver_count_by_cell_line <- other_driver_count_by_cell_line %>% summarise(max(other_driver_count))

mean_other_driver_count_by_cell_line <- other_driver_count_by_cell_line %>% summarise(mean(other_driver_count))

#Hotspot mutation summary for cell lines without fusion-associated dependencies
cell_lines_in_other_fusion_contexts_with_at_least_one_hotspot_driver <- canonical_driver_mutations_in_cell_lines %>% filter(Cell_line_with_fusion_associated_dependency == FALSE) %>% distinct(Cell_line)

cell_line_hotspot_mutation_combinations_for_cell_lines_in_other_fusion_contexts_with_at_least_one_hotspot_driver <- canonical_driver_mutations_in_cell_lines %>% filter(Cell_line_with_fusion_associated_dependency == FALSE) %>% distinct(Cell_line,Other_driver)

other_driver_count_by_cell_line_for_other_fusion_contexts <- canonical_driver_mutations_in_cell_lines %>% filter(Cell_line_with_fusion_associated_dependency == FALSE) %>% group_by(Cell_line) %>% summarise(other_driver_count = n_distinct(Other_driver))

minimum_other_driver_count_by_cell_line_for_other_fusion_contexts <- other_driver_count_by_cell_line_for_other_fusion_contexts %>% summarise(min(other_driver_count))

maximum_other_driver_count_by_cell_line_for_other_fusion_contexts <- other_driver_count_by_cell_line_for_other_fusion_contexts %>% summarise(max(other_driver_count))

mean_other_driver_count_by_cell_line_for_other_fusion_contexts <- other_driver_count_by_cell_line_for_other_fusion_contexts %>% summarise(mean(other_driver_count))

#Count of TCGA hotspot mutations in the TCGA
CCLE_mutations %>% filter(DepMap_ID %in% cell_lines_with_fusion_calls_and_dependency_data & Hugo_Symbol %in% cosmic_census_gene_symbols & isTCGAhotspot == TRUE) %>% summarise(mean(TCGAhsCnt))

```

#Statistics for comparing results of hotspot mutation analysis for cell lines with and without fusion-associated depedendencies
```{r}

#Chi-square test comparing proportions of cell lines with hotspot driver mutations (cell lines with fusion-associated dependencies vs. cell lines without fusion-associated dependencies)
count_of_cell_lines_with_fusion_associated_dependencies_with_at_least_one_hotspot_driver <- cell_lines_with_fusion_associated_dependencies_with_at_least_one_hotspot_driver %>% unlist() %>% unname() %>% length()
count_of_cell_lines_with_fusion_associated_dependencies_without_hotspot_driver <- setdiff(cell_lines_with_fusion_associated_dependencies,cell_lines_with_fusion_associated_dependencies_with_at_least_one_hotspot_driver %>% unlist() %>% unname()) %>% length()
count_of_cell_lines_in_other_fusion_contexts_with_at_least_one_hotspot_driver <- cell_lines_in_other_fusion_contexts_with_at_least_one_hotspot_driver %>% unlist() %>% unname() %>% length()
count_of_cell_lines_in_other_fusion_contexts_with_without_hotspot_driver <- setdiff(cell_lines_without_fusion_associated_dependencies, cell_lines_in_other_fusion_contexts_with_at_least_one_hotspot_driver %>% unlist() %>% unname()) %>% length()

contingency_table_comparing_cell_lines_with_hotspot_driver_mutation <- matrix(c(count_of_cell_lines_with_fusion_associated_dependencies_with_at_least_one_hotspot_driver,count_of_cell_lines_with_fusion_associated_dependencies_without_hotspot_driver,count_of_cell_lines_in_other_fusion_contexts_with_at_least_one_hotspot_driver,count_of_cell_lines_in_other_fusion_contexts_with_without_hotspot_driver), ncol = 2)

chisq.test(contingency_table_comparing_cell_lines_with_hotspot_driver_mutation)

#T test comparing hotspot mutation counts in cell lines (cell lines with fusion-associated dependencies vs. cell lines without fusion-associated dependencies)
t.test(other_driver_count_by_cell_line$other_driver_count, other_driver_count_by_cell_line_for_other_fusion_contexts$other_driver_count, alternative = "two.sided")

```

#Fusion-associated dependency t-statistic analysis: 1) Generate table of t-statistics for dependency (and expression) for each gene for each fusion
```{r}

dependency_probability_fusion_with_vs_without_TSTATS <- list()
expression_fusion_with_vs_without_TSTATS <- list()

counter = 0

for(fusion in ALL_fusions_with_dependency_data){
  
#Cell lines with dependency data that have fusion of interest and those that don't
cell_lines_with_fusion_dependency <- ALL_fusions_protein_coding_filtered_list_final %>% dplyr::filter(Fusion == fusion) %>% distinct(DepMap_ID) %>% unlist() %>% unname() %>% intersect(colnames(ccle_dependency_probability_matrix))

cell_lines_without_fusion_dependency <- ccle_dependency_probability %>% dplyr::filter(!(DepMap_ID %in% cell_lines_with_fusion_dependency)) %>% distinct(DepMap_ID) %>% unlist() %>% unname()

#Cell lines with expression data that have fusion of interest and those that don't
cell_lines_with_fusion_expression <- ALL_fusions_protein_coding_filtered_list_final %>% dplyr::filter(Fusion == fusion) %>% distinct(DepMap_ID) %>% unlist() %>% unname() %>% intersect(colnames(ccle_expression_protein_coding_log2tpm_matrix))

cell_lines_without_fusion_expression <- ccle_expression_protein_coding_log2tpm %>% dplyr::filter(!(DepMap_ID %in% cell_lines_with_fusion_expression)) %>% distinct(DepMap_ID) %>% unlist() %>% unname()

#If there is at least one cell line that has dependency data, then proceed
if(length(cell_lines_with_fusion_dependency) > 0 & length(cell_lines_without_fusion_dependency) > 0){
  
#Create expression matrices for cell lines that have the fusion and cell lines that don't
ccle_expression_matrix_with_fusion <- ccle_expression_protein_coding_log2tpm_matrix %>% subset(select = cell_lines_with_fusion_expression)

ccle_expression_matrix_without_fusion <- ccle_expression_protein_coding_log2tpm_matrix %>% subset(select = cell_lines_without_fusion_expression)

#Compare expression between the two groups with two sample t-test with equal variance
expression_fusion_with_vs_without_TSTATS[[fusion]] <- row_t_equalvar(ccle_expression_matrix_with_fusion, ccle_expression_matrix_without_fusion) %>% dplyr::mutate(gene = ccle_expression_protein_coding_log2tpm_matrix_df$gene) %>% dplyr::rename(log2_fold_change = `mean.diff`, expression_with_fusion = `mean.x`, expression_without_fusion = `mean.y`) %>% dplyr::select(gene, log2_fold_change, expression_with_fusion, expression_without_fusion, pvalue, statistic)

#Create dependency matrices for cell lines that have the fusion and cell lines that don't  
ccle_dependency_probability_matrix_with_fusion <- ccle_dependency_probability_matrix %>% subset(select = cell_lines_with_fusion_dependency)

ccle_dependency_probability_matrix_without_fusion <- ccle_dependency_probability_matrix %>% subset(select = cell_lines_without_fusion_dependency)

#Compare dependency between the two groups with two sample t-test with equal variance
dependency_probability_fusion_with_vs_without_TSTATS[[fusion]] <- row_t_equalvar(ccle_dependency_probability_matrix_with_fusion, ccle_dependency_probability_matrix_without_fusion) %>% dplyr::mutate(gene = ccle_dependency_probability_matrix_df$gene) %>% dplyr::rename(dependency_probability_difference = `mean.diff`, dependency_probability_with_fusion = `mean.x`, dependency_probability_without_fusion = `mean.y`) %>% dplyr::select(gene, dependency_probability_difference, dependency_probability_with_fusion, dependency_probability_without_fusion, pvalue, statistic)

}

counter = counter + 1
print(counter)

}

```

#Fusion-associated dependency t-statistic analysis: 2) Generate null tables of t-statistics for dependency based on the number of cell lines that have a fusion of interest (ranging from 1-11)
```{r}

cell_permutation_matrices_TSTATS_1000 <- list()

for(number_of_cells in c(1:11)){

cell_permutation_matrices_TSTATS_1000[[number_of_cells]] <- matrix(nrow = length(c(1:1000)), ncol = length(rownames(ccle_dependency_probability_matrix)))
rownames(cell_permutation_matrices_TSTATS_1000[[number_of_cells]]) <- c(1:1000)
colnames(cell_permutation_matrices_TSTATS_1000[[number_of_cells]]) <- rownames(ccle_dependency_probability_matrix)

count <- 0

for(iteration in c(1:1000)){

#Cell lines with dependency data that have fusion of interest and those that don't
cell_lines_with_fusion_dependency <- sample(colnames(ccle_dependency_probability_matrix), number_of_cells)

cell_lines_without_fusion_dependency <- ccle_dependency_probability %>% dplyr::filter(!(DepMap_ID %in% cell_lines_with_fusion_dependency)) %>% distinct(DepMap_ID) %>% unlist() %>% unname()

#Create dependency matrices for cell lines that have the fusion and cell lines that don't  
ccle_dependency_probability_matrix_with_fusion <- ccle_dependency_probability_matrix %>% subset(select = cell_lines_with_fusion_dependency)

ccle_dependency_probability_matrix_without_fusion <- ccle_dependency_probability_matrix %>% subset(select = cell_lines_without_fusion_dependency)

#Compare dependency between the two groups with two sample t-test with equal variance and correct p-values using Benjamini-Hochberg procedure for multiple hypothesis testing. Also categorize by quartile of differential expression (joined from above). Then create an abstracted binary matrix
dependency_probability_with_vs_without_stats_TSTATS_null <- row_t_equalvar(ccle_dependency_probability_matrix_with_fusion, ccle_dependency_probability_matrix_without_fusion) %>% dplyr::mutate(gene = ccle_dependency_probability_matrix_df$gene) %>% dplyr::rename(dependency_probability_difference = `mean.diff`, dependency_probability_with_fusion = `mean.x`, dependency_probability_without_fusion = `mean.y`) %>% dplyr::select(gene, dependency_probability_difference, dependency_probability_with_fusion, dependency_probability_without_fusion, pvalue, statistic)

cell_permutation_matrices_TSTATS_1000[[number_of_cells]][iteration,] <- dependency_probability_with_vs_without_stats_TSTATS_null$statistic
                                                                 
count <- count + 1
print(count)

}

}

```

#Fusion-associated dependency t-statistic analysis: 3) Testing only partner genes and other TAD genes for each fusion, use the permutation-based t-statistics and actual t-statistics to determining FDRs for each possible fusion-associated dependency
```{r}

fusion_count_of_cells_with_dependency_data <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(DepMap_ID %in% colnames(ccle_dependency_probability_matrix)) %>% group_by(Fusion) %>% summarise(cell_count = n_distinct(DepMap_ID))

fusion_associated_dependency_TSTAT_FDR <- tibble(fusion = NA, dependency = NA, FDR = NA)
count <- 0

for(fusion in fusion_count_of_cells_with_dependency_data$Fusion){

number_of_cells <- fusion_count_of_cells_with_dependency_data %>% filter(Fusion == fusion) %>% dplyr::select(cell_count) %>% unlist() %>% unname()
    
associated_gene_set <- intersect(cell_permutation_matrices_TSTATS_1000[[number_of_cells]] %>% colnames(), c(left_gene_TAD_neighbors[[fusion]], right_gene_TAD_neighbors[[fusion]],fusion_partners[[fusion]]))

if(associated_gene_set %>% length() > 0){

if(associated_gene_set %>% length() == 1){
permutation_tstats_matrix_for_associated_genes <- cbind(cell_permutation_matrices_TSTATS_1000[[number_of_cells]][,associated_gene_set],NA)  
colnames(permutation_tstats_matrix_for_associated_genes) <- c(associated_gene_set,NA)
}        
else{    
permutation_tstats_matrix_for_associated_genes <- cell_permutation_matrices_TSTATS_1000[[number_of_cells]][,associated_gene_set]
}

actuat_tstats_for_associated_genes <- dependency_probability_fusion_with_vs_without_TSTATS[[fusion]] %>% filter(gene %in% associated_gene_set)

for(dependency in associated_gene_set){
  
dependency_tstat <- dependency_probability_fusion_with_vs_without_TSTATS[[fusion]] %>% filter(gene == dependency) %>% dplyr::select(statistic) %>% unlist() %>% unname()

number_of_hits_at_dependency_tstat_across_permutations <- c()

for(iteration in c(1:1000)){

permutation_tstats_matrix_for_associated_genes_iteration_with_NA_removed <- permutation_tstats_matrix_for_associated_genes[iteration,][!is.na(permutation_tstats_matrix_for_associated_genes[iteration,])]    
  
number_of_hits_at_dependency_tstat_across_permutations <- c(number_of_hits_at_dependency_tstat_across_permutations, permutation_tstats_matrix_for_associated_genes_iteration_with_NA_removed[permutation_tstats_matrix_for_associated_genes_iteration_with_NA_removed >= dependency_tstat] %>% length())

}

mean_number_of_hits_at_dependency_tstat_across_permutations <- number_of_hits_at_dependency_tstat_across_permutations %>% mean()

number_of_hits_at_dependency_tstat_for_fusion <- actuat_tstats_for_associated_genes$statistic[actuat_tstats_for_associated_genes$statistic >= dependency_tstat] %>% na.omit() %>% length()

FDR <- (mean_number_of_hits_at_dependency_tstat_across_permutations/number_of_hits_at_dependency_tstat_for_fusion)

fusion_associated_dependency_TSTAT_FDR <- add_row(fusion_associated_dependency_TSTAT_FDR, fusion = fusion, dependency = dependency, FDR = FDR)
  
}

}

count = count + 1
print(count)

}

fusion_associated_dependency_TSTAT_FDR_NA_removed <- fusion_associated_dependency_TSTAT_FDR %>% remove_missing()

#Write output of fusion-dependency pairings with associated FDRs from t-statistic analysis
write_tsv(fusion_associated_dependency_TSTAT_FDR_NA_removed, here::here("results/datatables","fusion_associated_dependency_TSTAT_FDR_NA_removed.tsv"))

```

#Fusion-associated dependency t-statistic analysis: 4) Comparison of results to original genome-scale analysis
```{r}

fusion_associated_dependency_TSTAT_FDR_NA_removed <- read_tsv(here::here("results/datatables","fusion_associated_dependency_TSTAT_FDR_NA_removed.tsv")) %>% mutate(Fusion_Dependency_Pairing = str_c(fusion,"_",dependency))

#Determining the FDRs according to t-statistics for each of the fusion-associated dependencies previously determine by genome-scale screening
fusion_associated_dependencies_with_FDRs_TSTATS <- TAD_signficant_dependency_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed %>% distinct(Fusion,Gene,Cell_Count) %>% dplyr::select(Fusion,Gene,Cell_Count) %>% mutate(Fusion_Dependency_Pairing = str_c(Fusion,"_",Gene))

fusion_associated_dependencies_with_FDRs_TSTATS <- left_join(fusion_associated_dependencies_with_FDRs_TSTATS,fusion_associated_dependency_TSTAT_FDR_NA_removed, by = c("Fusion" = "fusion","Gene" = "dependency", "Fusion_Dependency_Pairing" = "Fusion_Dependency_Pairing"))

fusion_associated_dependencies_with_FDRs_TSTATS %>% view()

#Filtering fusion-associated depenendencies by various FDR thresholds according to t-statistics in order to enable comparison of results to genome-scale screening
fusion_associated_dependency_TSTAT_FDR_NA_removed <- fusion_associated_dependency_TSTAT_FDR_NA_removed %>% mutate(Fusion_Dependency_Pairing = str_c(fusion,"_",dependency))

fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.1 <- fusion_associated_dependency_TSTAT_FDR_NA_removed %>% filter(FDR < 0.1)

fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.1_duplicates_marked <- fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.1 %>% mutate(fusion_inverse = str_c(str_split_fixed(fusion,"-",2)[,2],"-",str_split_fixed(fusion,"-",2)[,1])) %>% mutate(duplicate = fusion_inverse %in% fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.1$fusion)

fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.1_duplicates_removed <- fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.1_duplicates_marked %>% filter(!fusion %in% c("ABL1-BCR", "AFF1-KMT2A", "C2orf69-ROCK2", "CRYBG1-PDSS2", "MLLT10-PICALM", "NSD2-IGH", "RARA-PML"))

fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.05 <- fusion_associated_dependency_TSTAT_FDR_NA_removed %>% filter(FDR < 0.05)

fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.05_duplicates_marked <- fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.05 %>% mutate(fusion_inverse = str_c(str_split_fixed(fusion,"-",2)[,2],"-",str_split_fixed(fusion,"-",2)[,1])) %>% mutate(duplicate = fusion_inverse %in% fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.05$fusion)

fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.05_duplicates_removed <- fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.05_duplicates_marked %>% filter(!fusion %in% c("ABL1-BCR", "RARA-PML"))

#Full list of fusion-dependency pairings from cell-line permutation based FDR approach (includes only partners and collateral genes)

fusion_associated_dependency_TSTAT_FDR_NA_removed_duplicates_marked <- fusion_associated_dependency_TSTAT_FDR_NA_removed %>% mutate(fusion_inverse = str_c(str_split_fixed(fusion,"-",2)[,2],"-",str_split_fixed(fusion,"-",2)[,1])) %>% mutate(duplicate = fusion_inverse %in% fusion_associated_dependency_TSTAT_FDR_NA_removed$fusion)

duplicated_fusions <- c("ABL1-BCR", "ADGRV1-WASHC2A", "AFF1-KMT2A", "AGBL4-FAF1","ARID2-SCAF11", "BANP-CA5A", "BCAS3-NPIPB12", "BCL7A-DYRK1A","C21orf58-PCNT","C22orf39-MTMR3", "C2orf69-ROCK2", "CDKN2A-MTAP","CHMP2B-MAGI1", "CHST11-TXNRD1","CLTC-RPS6KB1", "CNTNAP2-TPK1", "CRYBG1-PDSS2", "CTTN-SHANK2", "DOCK4-IMMP2L", "EIF3D-MYH9", "ELP1-MRRF", "ELP2-FHOD3", "ELP6-PTPN23", "FAM222A-MND1","FARP2-SNED1","FBXL7-TRIO","FGFR1OP-LPP","FRK-NT5DC1","GBE1-KIF20B","GPN1-GTF3C2","HEG1-ZNF148","HIRA-MTMR3","HNRNPC-RAD51B","KDM4C-UHRF2","LRR1-RPL36AL","LYN-NCOA2","MBOAT2-PRKCE","MECOM-PRKCI","MELK-P4HA1","MFSD1-RSRC1","MLLT10-PICALM","NETO2-TOPBP1","NGFR-SPAG9","NIPBL-WDR70","NSD2-IGH","PCNX1-UBAC2","PITPNA-YWHAE","PPP2R2A-SNX14","PRDX3-PTEN","PREX2-SDHB","RARA-PML","SPAG9-STK11","TUBD1-VMP1")

fusion_associated_dependency_TSTAT_FDR_NA_removed_duplicates_removed <- fusion_associated_dependency_TSTAT_FDR_NA_removed %>% filter(!fusion %in% duplicated_fusions)

fusion_associated_dependency_TSTAT_FDR_NA_removed_duplicates_removed$FDR <- recode(fusion_associated_dependency_TSTAT_FDR_NA_removed_duplicates_removed$FDR, `0` = 0.0001)

#Full list of fusion-dependency pairings from genome-scale based FDR approach (includes only partners and collateral genes)
genome_scale_FDRs <- list()

count = 0

for(fusion in fusion_count_of_cells_with_dependency_data$Fusion){
  
associated_gene_set <- intersect(rownames(ccle_dependency_probability_matrix), c(left_gene_TAD_neighbors[[fusion]], right_gene_TAD_neighbors[[fusion]],fusion_partners[[fusion]]))

genome_scale_FDRs[[fusion]] <- dependency_probability_fusion_with_vs_without_stats[[fusion]] %>% dplyr::rename(dependency = gene) %>% dplyr::filter(dependency %in% associated_gene_set) %>% mutate(fusion = fusion, Fusion_Dependency_Pairing = str_c(fusion,"_",dependency)) %>% dplyr::select(fusion,dependency,negative_log10_BH_QValue,Fusion_Dependency_Pairing, dependency_probability_difference)

count = count + 1
print(count)
  
}

genome_scale_FDRs_combined <- bind_rows(genome_scale_FDRs) %>% remove_missing()

genome_scale_FDRs_combined_duplicates_removed <- genome_scale_FDRs_combined %>% filter(!fusion %in% duplicated_fusions)

#Joined list of fusion-dependency pairings with FDRs from both approaches

fusion_dependency_pairings_with_FDRs_from_both_approaches <- inner_join(fusion_associated_dependency_TSTAT_FDR_NA_removed_duplicates_removed,genome_scale_FDRs_combined_duplicates_removed) %>% dplyr::rename(genome_scale_negative_log10_BH_QValue = negative_log10_BH_QValue) %>% mutate(cell_line_permutation_negative_log10_QValue = -log10(FDR)) %>% dplyr::select(fusion,dependency,Fusion_Dependency_Pairing,genome_scale_negative_log10_BH_QValue,cell_line_permutation_negative_log10_QValue,dependency_probability_difference)

fusion_dependency_pairings_with_FDRs_from_both_approaches$Fusion_Dependency_Pairing <- factor(fusion_dependency_pairings_with_FDRs_from_both_approaches$Fusion_Dependency_Pairing, levels = fusion_dependency_pairings_with_FDRs_from_both_approaches$Fusion_Dependency_Pairing %>% sort())

```

#Orthogonal WGS data providing additional evidence for the presence of fusions
```{r}

distinct_fusion_dependency_pairings <- read_tsv(here::here("results/datatables","distinct_fusion_dependency_pairings.tsv"))

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(CCLE_Name %in% CCLE_translocations_SvABA_20181221$CCLE_name & DepMap_ID %in% colnames(ccle_dependency_probability_matrix) & Fusion %in% distinct_fusion_dependency_pairings$Fusion) %>% mutate(left_gene = str_split_fixed(Fusion,"-",2)[,1], right_gene = str_split_fixed(Fusion,"-",2)[,2]) %>% distinct(Fusion, CCLE_Name, left_gene, right_gene) %>% arrange(Fusion)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_distinct_CCLE_Names <- list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data %>% distinct(CCLE_Name) %>% unlist() %>% unname()

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_by_cell_line <- list()
CCLE_translocations_SvABA_20181221_by_cell_line <- list()
counter = 0

for(cell_line in list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_distinct_CCLE_Names){
  
CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]] <- CCLE_translocations_SvABA_20181221 %>% filter(CCLE_name == cell_line)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_by_cell_line[[cell_line]] <- list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data %>% filter(CCLE_Name == cell_line) %>% mutate(evidence_of_SV_in_WGS_data = ifelse(Fusion %in% CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$fusion | Fusion %in% CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$fusion_inverse,"Fusion seen",ifelse((left_gene %in% CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene1 | left_gene %in% CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene2) & (right_gene %in% CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene1 | right_gene %in% CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene2),"Both genes involved in SV",ifelse(left_gene %in% CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene1 | left_gene %in% CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene2,"Left gene involved in SV",ifelse(right_gene %in% CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene1 | right_gene %in% CCLE_translocations_SvABA_20181221_by_cell_line[[cell_line]]$gene2,"Right gene involved in SV","No WGS evidence")))))

counter = counter + 1
print(counter)
}

CCLE_translocations_SvABA_20181221_by_cell_line_combined_for_cell_lines_with_fusion_associated_dependencies <- bind_rows(CCLE_translocations_SvABA_20181221_by_cell_line)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined <- bind_rows(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_by_cell_line)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary <- list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined %>% group_by(evidence_of_SV_in_WGS_data) %>% summarise(count = n()) 

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary <- list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary %>% mutate(percentage = count/sum(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary$count)*100)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary$evidence_of_SV_in_WGS_data <- factor(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary$evidence_of_SV_in_WGS_data, levels = c("No WGS evidence","Right gene involved in SV","Left gene involved in SV","Both genes involved in SV","Fusion seen"))

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary <- list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary %>% mutate(evidence_of_SV_in_WGS_data_aggregated = ifelse(evidence_of_SV_in_WGS_data == "No WGS evidence","No WGS evidence",ifelse(evidence_of_SV_in_WGS_data == "Fusion seen","Exact fusion seen","At least one gene in SV")))

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary$evidence_of_SV_in_WGS_data_aggregated <- factor(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary$evidence_of_SV_in_WGS_data_aggregated, levels = c("No WGS evidence","At least one gene in SV","Exact fusion seen"))

```

#Identifying which fusion with associated dependencines and with corresponding WGS data have multiple SVs in close proximity, suggesting they are part of complex rearrangements
```{r}

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_left <- left_join(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined,Gene_TAD_table[,c("gene","TAD_identifier")],by = c("left_gene" = "gene")) %>% dplyr::rename(left_TAD_identifier_1 = TAD_identifier)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_left_genes_in_boundaries <- list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_left %>% filter(is.na(left_TAD_identifier_1)) %>% dplyr::select(Fusion,CCLE_Name,left_gene,right_gene,evidence_of_SV_in_WGS_data)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_left_genes_in_boundaries <- left_join(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_left_genes_in_boundaries,Gene_TAD_boundary_table[,c("gene","upstream_TAD_identifier")],by = c("left_gene" = "gene")) %>% dplyr::rename(left_TAD_identifier_1 = upstream_TAD_identifier)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_left_genes_in_boundaries <- left_join(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_left_genes_in_boundaries,Gene_TAD_boundary_table[,c("gene","downstream_TAD_identifier")],by = c("left_gene" = "gene")) %>% dplyr::rename(left_TAD_identifier_2 = downstream_TAD_identifier)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_left_all <- full_join(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_left %>% filter(!is.na(left_TAD_identifier_1)), list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_left_genes_in_boundaries)


list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_right <- left_join(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined,Gene_TAD_table[,c("gene","TAD_identifier")],by = c("right_gene" = "gene")) %>% dplyr::rename(right_TAD_identifier_1 = TAD_identifier)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_right_genes_in_boundaries <- list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_right %>% filter(is.na(right_TAD_identifier_1)) %>% dplyr::select(Fusion,CCLE_Name,left_gene,right_gene,evidence_of_SV_in_WGS_data)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_right_genes_in_boundaries <- left_join(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_right_genes_in_boundaries,Gene_TAD_boundary_table[,c("gene","upstream_TAD_identifier")],by = c("right_gene" = "gene")) %>% dplyr::rename(right_TAD_identifier_1 = upstream_TAD_identifier)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_right_genes_in_boundaries <- left_join(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_right_genes_in_boundaries,Gene_TAD_boundary_table[,c("gene","downstream_TAD_identifier")],by = c("right_gene" = "gene")) %>% dplyr::rename(right_TAD_identifier_2 = downstream_TAD_identifier)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_right_all <- full_join(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_right %>% filter(!is.na(right_TAD_identifier_1)), list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_right_genes_in_boundaries)


list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all <- full_join(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_left_all,list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_right_all)


count = 0

SV_in_same_TAD_tibble <- tibble(Fusion = NA, CCLE_Name = NA, SV_in_same_TAD = NA)

for(fusion in unique(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all$Fusion)){
  
cell_lines_with_this_fusion <- list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all %>% filter(Fusion == fusion) %>% distinct(CCLE_Name) %>% unlist() %>% unname()
  
for(cell_line in cell_lines_with_this_fusion){
    
list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all_indexed <- list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all %>% filter(Fusion == fusion & cell_line == CCLE_Name)
  
all_partner_TADs <- c(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all_indexed[["left_TAD_identifier_1"]], list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all_indexed[["left_TAD_identifier_2"]], list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all_indexed[["right_TAD_identifier_1"]],list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all_indexed[["right_TAD_identifier_2"]])
    
all_partner_TADs <- all_partner_TADs[!is.na(all_partner_TADs)]    

all_partner_TADs_associated_genes <- Gene_TAD_table %>% filter(TAD_identifier %in% all_partner_TADs) %>% distinct(gene) %>% unlist() %>% unname()

fusion_partner_genes <- c(str_split_fixed(fusion,"-",2)[,1],str_split_fixed(fusion,"-",2)[,2])

all_partner_TADs_associated_genes_excluding_fusion_partners <- setdiff(all_partner_TADs_associated_genes,fusion_partner_genes)

CCLE_translocations_in_specific_cell_line <- CCLE_translocations_SvABA_20181221_by_cell_line_combined_for_cell_lines_with_fusion_associated_dependencies %>% filter(CCLE_name == cell_line)

CCLE_translocations_in_specific_cell_line <- CCLE_translocations_in_specific_cell_line %>% mutate(SV_in_same_TAD = (gene1 %in% all_partner_TADs_associated_genes_excluding_fusion_partners | gene2 %in% all_partner_TADs_associated_genes_excluding_fusion_partners) & !(gene1 %in% fusion_partner_genes | gene2 %in% fusion_partner_genes))

SV_in_same_TAD_tibble <- add_row(SV_in_same_TAD_tibble, Fusion = fusion, CCLE_Name = cell_line, SV_in_same_TAD = CCLE_translocations_in_specific_cell_line$SV_in_same_TAD %>% sum())
  
}
 
count = count + 1
print(count)  
   
}

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all <- left_join(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all,SV_in_same_TAD_tibble)

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all <- list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all %>% mutate(SV_in_same_TAD_group = ifelse(SV_in_same_TAD == 0,"0",ifelse(SV_in_same_TAD >=1 & SV_in_same_TAD <=5,"1-5",ifelse(SV_in_same_TAD >=6 & SV_in_same_TAD <=10,"6-10",">10"))))

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all_summarized_by_SV_count_groupings <- list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all %>% group_by(SV_in_same_TAD_group) %>% summarise(count = n())

write_tsv(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all, here::here("results/datatables","list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all.tsv"))


```

#Compare proportion of WGS-based SV correlates for fusions with associated dependencies vs. fusions that don't have associated dependencies
```{r}

#Fisher's exact

fusions_WITH_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined <- list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined %>% mutate(evidence_of_ANY_SV_in_WGS = !evidence_of_SV_in_WGS_data == "No WGS evidence")

fusions_WITHOUT_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined <- full_list_of_fusions_with_associated_cell_lines_with_orthogonal_WGS_data_combined %>% filter(!Fusion %in% list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined$Fusion) %>% mutate(evidence_of_ANY_SV_in_WGS = !evidence_of_SV_in_WGS_data == "No WGS evidence")

fusions_WITH_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary <- fusions_WITH_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined %>% group_by(evidence_of_ANY_SV_in_WGS) %>% summarise(count = n())

fusions_WITHOUT_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary <- fusions_WITHOUT_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined %>% group_by(evidence_of_ANY_SV_in_WGS) %>% summarise(count = n())

matrix_comparing_presence_of_aWGS_correlate_to_whether_fusion_has_associated_dependencies_or_not <- matrix(c(fusions_WITH_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary[[1,2]],fusions_WITH_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary[[2,2]],fusions_WITHOUT_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary[[1,2]],fusions_WITHOUT_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary[[2,2]]),nrow = 2)

fisher.test(matrix_comparing_presence_of_aWGS_correlate_to_whether_fusion_has_associated_dependencies_or_not)

#Combining and formatting WGS data for fusions with and without associated dependencies into a single dataframe

fusions_WITH_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_aggregated <- fusions_WITH_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined %>% group_by(evidence_of_SV_in_WGS_data) %>% summarise(count = n()) %>% mutate(percentage = count/sum(fusions_WITH_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary$count)*100) %>% mutate(evidence_of_SV_in_WGS_data_aggregated = ifelse(evidence_of_SV_in_WGS_data == "No WGS evidence","No WGS evidence",ifelse(evidence_of_SV_in_WGS_data == "Fusion seen","Exact fusion seen","At least one gene in SV"))) %>% mutate(fusions_with_associated_dependency = "Fusions with\nassociated\ndependency")

fusions_WITHOUT_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_aggregated <- fusions_WITHOUT_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined %>% group_by(evidence_of_SV_in_WGS_data) %>% summarise(count = n()) %>% mutate(percentage = count/sum(fusions_WITHOUT_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary$count)*100) %>% mutate(evidence_of_SV_in_WGS_data_aggregated = ifelse(evidence_of_SV_in_WGS_data == "No WGS evidence","No WGS evidence",ifelse(evidence_of_SV_in_WGS_data == "Fusion seen","Exact fusion seen","At least one gene in SV"))) %>% mutate(fusions_with_associated_dependency = "Other\nfusions")

all_fusions_with_orthogonal_WGS_data_combined_aggregated <- full_join(fusions_WITH_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_aggregated,fusions_WITHOUT_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_aggregated)

all_fusions_with_orthogonal_WGS_data_combined_aggregated$evidence_of_SV_in_WGS_data_aggregated <- factor(all_fusions_with_orthogonal_WGS_data_combined_aggregated$evidence_of_SV_in_WGS_data_aggregated, levels = c("No WGS evidence","At least one gene in SV","Exact fusion seen"))

```

#TCGA data from clinical samples to analyze fusions/ partners that have clinical correlates from this dataset
```{r}

#Identifying fusions from cell lines derived from tumors that have representation in the TCGA fusion call list
diseases_for_fusions_with_associated_dependencies <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(Fusion %in% unique(distinct_fusion_dependency_pairings$Fusion)) %>% distinct(Fusion, lineage, lineage_subtype) %>% arrange(Fusion)

tcga_disease_represented <- left_join(tcga_fusion_list_symbols_updated %>% distinct(Cancer), tcga_study_abbreviations, by = c("Cancer" = "Abbreviation"))

write_tsv(diseases_for_fusions_with_associated_dependencies, here::here("results/datatables","diseases_for_fusions_with_associated_dependencies.txt"))

write_tsv(tcga_disease_represented, here::here("results/datatables","tcga_disease_represented.txt"))

diseases_for_fusions_with_associated_dependencies_annotated <- read_tsv(here::here("results/datatables","diseases_for_fusions_with_associated_dependencies_annotated.txt"))

fusions_from_cell_lines_derived_from_tumors_with_representation_in_tcga_fusion_call_list <- diseases_for_fusions_with_associated_dependencies_annotated %>% filter(disease_in_tcga == "yes") %>% distinct(Fusion) %>% unlist() %>% unname()

#Summary tables to reference
tcga_fusion_summary <- tcga_fusion_list_symbols_updated %>% group_by(Fusion) %>% summarise(count = n_distinct(Sample)) %>% arrange(desc(count))

tcga_leftgene_summary <- tcga_fusion_list_symbols_updated %>% group_by(LeftGene) %>% summarise(count = n_distinct(Sample))

tcga_rightgene_summary <- tcga_fusion_list_symbols_updated %>% group_by(RightGene) %>% summarise(count = n_distinct(Sample))

tcga_partner_summary <- full_join(tcga_leftgene_summary, tcga_rightgene_summary, by = c("LeftGene" = "RightGene"))

tcga_partner_summary$count.x <- tcga_partner_summary$count.x %>% replace_na(0)

tcga_partner_summary$count.y <- tcga_partner_summary$count.y %>% replace_na(0)

tcga_partner_summary <- tcga_partner_summary %>% mutate(count = count.x + count.y) %>% dplyr::select(gene = LeftGene, count)

#Dataframe of fusions with associated dependencies that show up themselves, or have partners that show up, in the TCGA dataset

frequency_of_fusion_and_partner_recurrence_in_human_samples <- tibble(Fusion = distinct_fusion_dependency_pairings$Fusion %>% unique()) %>% mutate(LeftGene = str_split_fixed(Fusion,"-",2)[,1], RightGene = str_split_fixed(Fusion,"-",2)[,2])

frequency_of_fusion_and_partner_recurrence_in_human_samples <- left_join(frequency_of_fusion_and_partner_recurrence_in_human_samples,tcga_fusion_summary, by = "Fusion") %>% rename(tcga_fusion_count = count)

frequency_of_fusion_and_partner_recurrence_in_human_samples <- left_join(frequency_of_fusion_and_partner_recurrence_in_human_samples,tcga_partner_summary, by = c("LeftGene" = "gene")) %>% rename(tcga_leftgene_count = count)

frequency_of_fusion_and_partner_recurrence_in_human_samples <- left_join(frequency_of_fusion_and_partner_recurrence_in_human_samples,tcga_partner_summary, by = c("RightGene" = "gene")) %>% rename(tcga_rightgene_count = count)

frequency_of_fusion_and_partner_recurrence_in_human_samples[is.na(frequency_of_fusion_and_partner_recurrence_in_human_samples)] <- 0

frequency_of_fusion_and_partner_recurrence_in_human_samples <- frequency_of_fusion_and_partner_recurrence_in_human_samples %>% mutate(tcga_max_partner_count = ifelse(tcga_leftgene_count > tcga_rightgene_count, tcga_leftgene_count, tcga_rightgene_count))

frequency_of_fusion_and_partner_recurrence_in_human_samples <- frequency_of_fusion_and_partner_recurrence_in_human_samples %>% mutate(tcga_fusion_count_group = ifelse(tcga_fusion_count == 0, "0",ifelse(tcga_fusion_count == 1, "1", ifelse(tcga_fusion_count > 1 & tcga_fusion_count <= 5,"2 - 5",ifelse(tcga_fusion_count > 5,"5+","error"))))) %>% mutate(tcga_max_partner_count_group = ifelse(tcga_max_partner_count == 0, "0",ifelse(tcga_max_partner_count == 1, "1", ifelse(tcga_max_partner_count > 1 & tcga_max_partner_count <= 5,"2 - 5",ifelse(tcga_max_partner_count > 5,"5+","error")))))

frequency_of_fusion_and_partner_recurrence_in_human_samples_filtered_for_fusions_from_cell_lines_derived_from_tumors_with_representation_in_tcga_fusion_call_list <- frequency_of_fusion_and_partner_recurrence_in_human_samples %>% filter(Fusion %in% fusions_from_cell_lines_derived_from_tumors_with_representation_in_tcga_fusion_call_list)

#Summary tables

summary_of_tcga_fusion_count_group <- frequency_of_fusion_and_partner_recurrence_in_human_samples %>% group_by(tcga_fusion_count_group) %>% summarise(count = n_distinct(Fusion)) %>% mutate(percent = count/sum(count)*100)

summary_of_tcga_max_partner_count_group <- frequency_of_fusion_and_partner_recurrence_in_human_samples %>% group_by(tcga_max_partner_count_group) %>% summarise(count = n_distinct(Fusion)) %>% mutate(percent = count/sum(count)*100)

summary_of_tcga_samples <- full_join(summary_of_tcga_fusion_count_group, summary_of_tcga_max_partner_count_group, by = c("tcga_fusion_count_group" = "tcga_max_partner_count_group")) %>% rename(frequency = tcga_fusion_count_group, fusion_percent = percent.x, partner_percent = percent.y) %>% dplyr::select(frequency, fusion_percent, partner_percent)

summary_of_tcga_fusion_count_group_fusions_with_tcga_disease_rep <- frequency_of_fusion_and_partner_recurrence_in_human_samples_filtered_for_fusions_from_cell_lines_derived_from_tumors_with_representation_in_tcga_fusion_call_list %>% group_by(tcga_fusion_count_group) %>% summarise(count = n_distinct(Fusion)) %>% mutate(percent = count/sum(count)*100)

summary_of_tcga_max_partner_count_group_fusions_with_tcga_disease_rep <- frequency_of_fusion_and_partner_recurrence_in_human_samples_filtered_for_fusions_from_cell_lines_derived_from_tumors_with_representation_in_tcga_fusion_call_list %>% group_by(tcga_max_partner_count_group) %>% summarise(count = n_distinct(Fusion)) %>% mutate(percent = count/sum(count)*100)

summary_of_tcga_samples_fusions_with_tcga_disease_rep <- full_join(summary_of_tcga_fusion_count_group_fusions_with_tcga_disease_rep, summary_of_tcga_max_partner_count_group_fusions_with_tcga_disease_rep, by = c("tcga_fusion_count_group" = "tcga_max_partner_count_group")) %>% rename(frequency = tcga_fusion_count_group, fusion_percent = percent.x, partner_percent = percent.y) %>% dplyr::select(frequency, fusion_percent, partner_percent)

frequency_of_fusion_and_partner_recurrence_in_human_samples_filtered_for_fusions_from_cell_lines_derived_from_tumors_with_representation_in_tcga_fusion_call_list %>% view()

```

#Orthogonal copy number and mutation data for fusion-associated dependencies
```{r}
copy_number_and_mutation_data_by_dependency_fusion_and_cell_line <- tibble(gene = NA, fusion = NA, cell_lines = NA, CCLE_names = NA, variant_in_dependency = NA, variant_classification = NA, is_deleterious = NA, variant_annotation = NA, copy_number_log2 = NA, loss_gain_neutral = NA)

counter = 0

for(gene in unique(distinct_fusion_dependency_pairings$Gene)){
  
fusions_with_gene_as_dependency <- distinct_fusion_dependency_pairings %>% filter(Gene == gene) %>% distinct(Fusion) %>% unlist() %>% unname()

for(fusion in fusions_with_gene_as_dependency){
  
cell_lines_with_fusion = ALL_fusions_protein_coding_filtered_list_final %>% filter(Fusion == fusion) %>% distinct(DepMap_ID) %>% unlist() %>% unname()  

CCLE_names_with_fusion = ALL_fusions_protein_coding_filtered_list_final %>% filter(Fusion == fusion) %>% distinct(CCLE_Name) %>% unlist() %>% unname()

cell_lines_with_each_gene_and_fusion <- tibble(cell_lines = cell_lines_with_fusion, CCLE_names = CCLE_names_with_fusion)
  
for(cell in cell_lines_with_each_gene_and_fusion$cell_lines){
  
  if(cell %in% CCLE_mutations$DepMap_ID){
    
    variants_in_cell = CCLE_mutations %>% filter(DepMap_ID == cell) %>% distinct(Hugo_Symbol) %>% unlist() %>% unname()

  } else{
  
    variants_in_cell = NA
}

variant_in_dependency <- gene %in% variants_in_cell

variant_classification <- ifelse(variant_in_dependency, CCLE_mutations %>% filter(DepMap_ID == cell & Hugo_Symbol == gene) %>% distinct(Variant_Classification) %>% unlist() %>% unname(), NA)

is_deleterious <- ifelse(variant_in_dependency, CCLE_mutations %>% filter(DepMap_ID == cell & Hugo_Symbol == gene) %>% distinct(isDeleterious) %>% unlist() %>% unname(), NA)

variant_annotation <- ifelse(variant_in_dependency, CCLE_mutations %>% filter(DepMap_ID == cell & Hugo_Symbol == gene) %>% distinct(Variant_annotation) %>% unlist() %>% unname(), NA)

copy_number_log2 <- ifelse(cell %in% CCLE_gene_cn$DepMap_ID, CCLE_gene_cn %>% filter(DepMap_ID == cell) %>% dplyr::select(gene) %>% unlist() %>% unname(), NA)
  
copy_number_and_mutation_data_by_dependency_fusion_and_cell_line <- add_row(copy_number_and_mutation_data_by_dependency_fusion_and_cell_line,gene = gene, fusion = fusion, cell_lines = cell, CCLE_names = cell_lines_with_each_gene_and_fusion %>% filter(cell_lines == cell) %>% dplyr::select(CCLE_names) %>% unlist() %>% unname(), variant_in_dependency = variant_in_dependency, variant_classification = variant_classification, is_deleterious = is_deleterious, variant_annotation = variant_annotation, copy_number_log2 = copy_number_log2, loss_gain_neutral = ifelse(copy_number_log2 > 1.5,"gain",ifelse(copy_number_log2 < 0.5,"loss",ifelse(is.na(copy_number_log2),NA,"neutral"))))
  
}

}

counter = counter + 1
print(counter)

}

copy_number_and_mutation_data_by_dependency_fusion_and_cell_line <- copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% mutate(dependency_data_available = cell_lines %in% colnames(ccle_dependency_probability_matrix))

copy_number_and_mutation_data_by_dependency_fusion_and_cell_line <- copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% mutate(is_partner = gene == str_split_fixed(fusion,"-",2)[,1] | gene == str_split_fixed(fusion,"-",2)[,2])

copy_number_and_mutation_data_by_dependency_fusion_and_cell_line <- copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% mutate(left_gene = str_split_fixed(fusion,"-",2)[,1], right_gene = str_split_fixed(fusion,"-",2)[,2])

copy_number_and_mutation_data_by_dependency_fusion_and_cell_line <- copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% mutate(cosmic_fusion = fusion %in% cosmic_fusions$value, left_gene_cosmic_translocation_partner = left_gene %in% cosmic_translocation_genes$`Gene Symbol`, right_gene_cosmic_translocation_partner = right_gene %in% cosmic_translocation_genes$`Gene Symbol`)

copy_number_and_mutation_data_by_dependency_fusion_and_cell_line <- copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% mutate(left_gene_kinase = left_gene %in% oncogenes_tsps_kinases_drivers$Kinase, right_gene_kinase = right_gene %in% oncogenes_tsps_kinases_drivers$Kinase)

copy_number_and_mutation_data_by_dependency_fusion_and_cell_line <- copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% mutate(left_gene_cosmic_census_gene = left_gene %in% cosmic_census_genes$`Gene Symbol`, right_gene_cosmic_census_gene = right_gene %in% cosmic_census_genes$`Gene Symbol`)

copy_number_and_mutation_data_by_dependency_fusion_and_cell_line <- copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% dplyr::rename(dependency = gene) %>% mutate(dependency_kinase = dependency %in% oncogenes_tsps_kinases_drivers$Kinase, dependency_cosmic_census_gene = dependency %in% cosmic_census_genes$`Gene Symbol`)


copy_number_alterations_involving_fusion_associated_dependencies_summary <- copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% group_by(is_partner,loss_gain_neutral) %>% summarise(count = n_distinct(dependency,fusion,cell_lines,CCLE_names))

copy_number_alterations_involving_fusion_associated_dependencies_summary <- copy_number_alterations_involving_fusion_associated_dependencies_summary %>% mutate(dependency_type = ifelse(is_partner == FALSE, "Collateral\ndependency", "Partner\ndependency"))

copy_number_alterations_involving_fusion_associated_dependencies_summary$loss_gain_neutral <- copy_number_alterations_involving_fusion_associated_dependencies_summary$loss_gain_neutral %>% replace_na("no data")

mutations_involving_fusion_associated_dependencies_summary <- copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% group_by(is_partner,variant_in_dependency) %>% summarise(count = n_distinct(dependency,fusion,cell_lines,CCLE_names))

mutations_involving_fusion_associated_dependencies_summary <- mutations_involving_fusion_associated_dependencies_summary %>% mutate(dependency_type = ifelse(is_partner == FALSE, "Collateral\ndependency", "Partner\ndependency"))

mutations_involving_fusion_associated_dependencies_summary <- mutations_involving_fusion_associated_dependencies_summary %>% dplyr::select(dependency_type, variant_in_dependency, count)

```

#Differential RNA expression for fusion-associated dependencies
```{r}
RNA_expression_data_by_dependency_and_fusion <- tibble(gene = character(), fusion = character(), log2_fold_change = double(), log2_expression_with_fusion = double(), log2_expression_without_fusion = double(), pvalue = double())

counter = 0

for(fusion in unique(distinct_fusion_dependency_pairings$Fusion)){
  
dependencies_associated_with_fusion <- distinct_fusion_dependency_pairings %>% filter(Fusion == fusion) %>% distinct(Gene) %>% unlist() %>% unname()

#Cell lines with expression data that have fusion of interest and those that don't
cell_lines_with_fusion_expression <- ALL_fusions_protein_coding_filtered_list_final %>% dplyr::filter(Fusion == fusion) %>% distinct(DepMap_ID) %>% unlist() %>% unname() %>% intersect(colnames(ccle_expression_protein_coding_log2tpm_matrix))
cell_lines_without_fusion_expression <- ccle_expression_protein_coding_log2tpm %>% dplyr::filter(!(DepMap_ID %in% cell_lines_with_fusion_expression)) %>% distinct(DepMap_ID) %>% unlist() %>% unname()

#Create expression matrices for cell lines that have the fusion and cell lines that don't
ccle_expression_matrix_with_fusion <- ccle_expression_protein_coding_log2tpm_matrix %>% subset(select = cell_lines_with_fusion_expression)
ccle_expression_matrix_without_fusion <- ccle_expression_protein_coding_log2tpm_matrix %>% subset(select = cell_lines_without_fusion_expression)

#Expression dataframe filtered for cell lines without fusion, for later use in density distribution
ccle_expression_protein_coding_log2tpm_without_fusion <- ccle_expression_protein_coding_log2tpm %>% filter(DepMap_ID %in% cell_lines_without_fusion_expression)

#Compare expression between the two groups with two sample t-test with equal variance
fusion_expression_table <- row_t_equalvar(ccle_expression_matrix_with_fusion, ccle_expression_matrix_without_fusion) %>% dplyr::mutate(gene = ccle_expression_protein_coding_log2tpm_matrix_df$gene) %>% dplyr::rename(log2_fold_change = `mean.diff`, log2_expression_with_fusion = `mean.x`, log2_expression_without_fusion = `mean.y`) %>% dplyr::select(gene, log2_fold_change, log2_expression_with_fusion, log2_expression_without_fusion, pvalue)

for(dependency in dependencies_associated_with_fusion){
  
if(dependency %in% colnames(ccle_expression_protein_coding_log2tpm_without_fusion)){

fusion_expression_table_for_dependency <- fusion_expression_table %>% filter(gene == dependency) %>% mutate(fusion = fusion) %>% dplyr::select(gene,fusion,log2_fold_change,log2_expression_with_fusion,log2_expression_without_fusion,pvalue)

RNA_expression_data_by_dependency_and_fusion <- full_join(RNA_expression_data_by_dependency_and_fusion, fusion_expression_table_for_dependency)

}
  
}

counter = counter + 1
print(counter)

}

RNA_expression_data_by_dependency_and_fusion <- RNA_expression_data_by_dependency_and_fusion %>% dplyr::rename(dependency = gene)

```

#Combined copy number, mutation, and RNA expression data for fusion-associated dependencies by cell line (while copy number and mutation data is unique to each cell line, RNA expression data is in aggregate for all the cell lines that have the fusion-dependency pairing)
```{r}

RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line <- full_join(copy_number_and_mutation_data_by_dependency_fusion_and_cell_line, RNA_expression_data_by_dependency_and_fusion, by = c("dependency","fusion"))

RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line <- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line[-1,]

RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line <- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% filter(dependency_data_available == TRUE)

RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% view()

#Write output of RNA expression, copy number, mutation, and annotation data for fusion-dependency pairing
write_tsv(RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line, here::here("results/datatables","RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line.tsv"))

#Data for fusion-dependency co-description visualization
RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut <- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% mutate(cell_line_name = str_split_fixed(CCLE_names,"_",2)[,1])

RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut$variant_classification <- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut$variant_classification %>% replace_na("None")

RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut$variant_classification <- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut$variant_classification %>% recode("Missense_Mutation" = "Missense", "Nonsense_Mutation" = "Nonsense", "In_Frame_Del" = "In Frame Deletion", "Splice_Site" = "Splice Site")

RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut <- left_join(RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut, disease_annotations_by_cell_line, by = c("cell_lines" = "DepMap_ID"))

RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut <- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut %>% mutate(rna_overexpression = log2_fold_change > 1)

RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut<- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut %>% rename(mutation = variant_classification, copy_number_alteration = loss_gain_neutral)

RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut<- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut %>% rename(dependency_is_partner = is_partner)

RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut_simplified <- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut %>% dplyr::select(dependency, fusion, cell_line_name, dependency_is_partner, cosmic_fusion, left_gene_cosmic_census_gene, right_gene_cosmic_census_gene, left_gene_kinase, right_gene_kinase, dependency_cosmic_census_gene, dependency_kinase, mutation, copy_number_alteration, rna_overexpression)

write_tsv(RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut_simplified, here::here("results/datatables","RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut_simplified.tsv"))

fusion_dependency_co_descriptor_plot <- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line_formatted_for_CoMut_simplified %>% dplyr::select(-c(mutation,copy_number_alteration,rna_overexpression))

fusion_dependency_co_descriptor_plot <- fusion_dependency_co_descriptor_plot %>% mutate(dependency_cosmic_census_gene = ifelse(dependency_cosmic_census_gene == TRUE, dependency, NA), dependency_kinase = ifelse(dependency_kinase == TRUE, dependency, NA))

fusion_dependency_co_descriptor_plot <- fusion_dependency_co_descriptor_plot %>% group_by(fusion) %>% summarise(cosmic_fusion = mean(cosmic_fusion), left_gene_cosmic_census_gene = mean(left_gene_cosmic_census_gene), right_gene_cosmic_census_gene = mean(right_gene_cosmic_census_gene), left_gene_kinase = mean(left_gene_kinase), right_gene_kinase = mean(right_gene_kinase), dependency_cosmic_census_gene = n_distinct(dependency_cosmic_census_gene,na.rm = TRUE), dependency_kinase = n_distinct(dependency_kinase,na.rm = TRUE))

fusion_dependency_co_descriptor_plot <- fusion_dependency_co_descriptor_plot %>% mutate(fusion_partner_cosmic_census_gene = left_gene_cosmic_census_gene + right_gene_cosmic_census_gene, fusion_partner_kinase = left_gene_kinase + right_gene_kinase)

fusion_dependency_co_descriptor_plot <- fusion_dependency_co_descriptor_plot %>% dplyr::select(-c(left_gene_cosmic_census_gene,right_gene_cosmic_census_gene,left_gene_kinase,right_gene_kinase))

write_tsv(fusion_dependency_co_descriptor_plot, here::here("results/datatables","fusion_dependency_co_descriptor_plot.tsv"))

fusion_dependency_co_descriptor_plot_cosmic_annotation <- fusion_dependency_co_descriptor_plot %>% mutate(cosmic_fusion = ifelse(cosmic_fusion == 1, "COSMIC fusion", "Other fusion"))

fusion_dependency_co_descriptor_plot_cosmic_annotation_summary <- fusion_dependency_co_descriptor_plot_cosmic_annotation %>% group_by(cosmic_fusion) %>% summarise(dependency_cosmic_census_gene_percent = (dependency_cosmic_census_gene[!dependency_cosmic_census_gene == 0] %>% length())/(n_distinct(fusion))*100, dependency_kinase_percent = (dependency_kinase[!dependency_kinase == 0] %>% length())/(n_distinct(fusion))*100, fusion_partner_cosmic_census_gene_percent = (fusion_partner_cosmic_census_gene[!fusion_partner_cosmic_census_gene == 0] %>% length())/(n_distinct(fusion))*100, fusion_partner_kinase_percent = (fusion_partner_kinase[!fusion_partner_kinase == 0] %>% length())/(n_distinct(fusion))*100)
```

#sgRNA location for fusions with partner dependencies
```{r}

fusion_guide_information <- tibble(Fusion=NA, cell_lines=NA, CCLE_names=NA, left_gene_guide_estimated_to_cut=NA,left_gene_guide_total=NA,left_gene_guide_percentage_cutting=NA,right_gene_guide_estimated_to_cut=NA,right_gene_guide_total=NA,right_gene_guide_percentage_cutting=NA)

fusions_with_partner_dependency <- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% filter(is_partner == TRUE) %>% dplyr::select(fusion) %>% unlist() %>% unname()

counter = 0

for(fusion in fusions_with_partner_dependency){

left_gene_fusion <- str_split_fixed(fusion,"-",2)[,1]
right_gene_fusion <- str_split_fixed(fusion,"-",2)[,2]

cell_lines_with_fusion <- ALL_fusions_protein_coding_filtered_list_final %>% dplyr::filter(Fusion == fusion) %>% distinct(DepMap_ID) %>% unlist() %>% unname() %>% intersect(colnames(ccle_dependency_probability_matrix))

CCLE_names_with_fusion <- ALL_fusions_protein_coding_filtered_list_final %>% filter(DepMap_ID %in% cell_lines_with_fusion) %>% distinct(CCLE_Name) %>% unlist() %>% unname()

cell_lines_with_each_fusion <- tibble(cell_lines = cell_lines_with_fusion, CCLE_names = CCLE_names_with_fusion)
  
for(cell in cell_lines_with_each_fusion$cell_lines){
  
left_gene_vector_guides_cutting_estimate <- list()
left_gene_guide_estimated_to_cut <- list()
right_gene_vector_guides_cutting_estimate <- list()
right_gene_guide_estimated_to_cut <- list()

#If dependency data available on left gene
if(left_gene_fusion %in% ccle_dependency_probability_matrix_df$gene){
  
left_gene_orientation <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(Fusion == fusion & DepMap_ID == cell) %>% dplyr::select(LeftChromOrientation) %>% distinct() %>% unlist() %>% unname()

left_gene_vector_guide_locations <- ccle_dependency_guides %>% filter(gene == left_gene_fusion) %>% dplyr::select(base) %>% distinct() %>% unlist() %>% unname() %>% as.double()

left_gene_breakpoints <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(Fusion == fusion & DepMap_ID == cell) %>% dplyr::select(LeftChromPosition) %>% unlist() %>% unname() %>% unique() %>% as.double()

left_gene_breakpoints_length <- left_gene_breakpoints %>% length()
  
#If left gene is in forward orientation, check to see if guides are to the left of the breakpoint and therefore estimated to cut
if(left_gene_orientation == "+"){
  
  for(breakpoint_index in c(1:left_gene_breakpoints_length)){
    
  left_gene_vector_guides_cutting_estimate[[breakpoint_index]] <- left_gene_vector_guide_locations < left_gene_breakpoints[[breakpoint_index]]
  left_gene_guide_estimated_to_cut[[breakpoint_index]] <- sum(left_gene_vector_guides_cutting_estimate[[breakpoint_index]] == TRUE)
    
  }
  
  }
#If left gene is in reverse orientation, check to see if guides are to the right of the breakpoint and therefore estimated to cut
  else{

  for(breakpoint_index in c(1:left_gene_breakpoints_length)){
  
  left_gene_vector_guides_cutting_estimate[[breakpoint_index]] <- left_gene_vector_guide_locations > left_gene_breakpoints[[breakpoint_index]]
  left_gene_guide_estimated_to_cut[[breakpoint_index]] <- sum(left_gene_vector_guides_cutting_estimate[[breakpoint_index]] == TRUE)
    
  } 
    
  }
  
}

#If dependency data available on right gene
if(right_gene_fusion %in% ccle_dependency_probability_matrix_df$gene){
  
right_gene_orientation <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(Fusion == fusion & DepMap_ID == cell) %>% dplyr::select(RightChromOrientation) %>% distinct() %>% unlist() %>% unname()

right_gene_vector_guide_locations <- ccle_dependency_guides %>% filter(gene == right_gene_fusion) %>% dplyr::select(base) %>% distinct() %>% unlist() %>% unname() %>% as.double()

right_gene_breakpoints <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(Fusion == fusion & DepMap_ID == cell) %>% dplyr::select(RightChromPosition) %>% unlist() %>% unname() %>% unique() %>% as.double()

right_gene_breakpoints_length <- right_gene_breakpoints %>% length()
  
#If right gene is in forward orientation, check to see if guides are to the right of the breakpoint and therefore estimated to cut
if(right_gene_orientation == "+"){
  
  for(breakpoint_index in c(1:right_gene_breakpoints_length)){
  
  right_gene_vector_guides_cutting_estimate[[breakpoint_index]] <- right_gene_vector_guide_locations > right_gene_breakpoints[[breakpoint_index]]
  right_gene_guide_estimated_to_cut[[breakpoint_index]] <- sum(right_gene_vector_guides_cutting_estimate[[breakpoint_index]] == TRUE)
    
  }
   
  }
#If right gene is in reverse orientation, check to see if guides are to the left of the breakpoint and therefore estimated to cut
  else{

  for(breakpoint_index in c(1:right_gene_breakpoints_length)){
  
  right_gene_vector_guides_cutting_estimate[[breakpoint_index]] <- right_gene_vector_guide_locations < right_gene_breakpoints[[breakpoint_index]]
  right_gene_guide_estimated_to_cut[[breakpoint_index]] <- sum(right_gene_vector_guides_cutting_estimate[[breakpoint_index]] == TRUE)
    
  }
    
  }
  
}


left_gene_guide_total <- length(left_gene_vector_guide_locations)
left_gene_guide_percentage_cutting <- percent(max(left_gene_guide_estimated_to_cut %>% unlist())/left_gene_guide_total)

right_gene_guide_total <- length(right_gene_vector_guide_locations)
right_gene_guide_percentage_cutting <- percent(max(right_gene_guide_estimated_to_cut %>% unlist())/right_gene_guide_total)

fusion_guide_information <- add_row(fusion_guide_information, Fusion=fusion, cell_lines = cell, CCLE_names = cell_lines_with_each_fusion %>% filter(cell_lines == cell) %>% dplyr::select(CCLE_names) %>% unlist() %>% unname(), left_gene_guide_estimated_to_cut=max(left_gene_guide_estimated_to_cut %>% unlist()), left_gene_guide_total=left_gene_guide_total,  left_gene_guide_percentage_cutting=left_gene_guide_percentage_cutting, right_gene_guide_estimated_to_cut=max(right_gene_guide_estimated_to_cut %>% unlist()), right_gene_guide_total=right_gene_guide_total, right_gene_guide_percentage_cutting=right_gene_guide_percentage_cutting)

}

counter = counter + 1
print(counter)

}

fusion_guide_information <- fusion_guide_information %>% mutate(dependency_data_available = cell_lines %in% colnames(ccle_dependency_probability_matrix)) %>% filter(dependency_data_available == TRUE)

is.na(fusion_guide_information) <- sapply(fusion_guide_information, is.infinite)

fusion_guide_information <- fusion_guide_information %>% dplyr::select(Fusion, cell_lines, CCLE_names, left_gene_guide_estimated_to_cut, left_gene_guide_total, right_gene_guide_estimated_to_cut, right_gene_guide_total)

fusion_guide_information <- fusion_guide_information %>% distinct(Fusion, cell_lines, CCLE_names, left_gene_guide_estimated_to_cut, left_gene_guide_total, right_gene_guide_estimated_to_cut, right_gene_guide_total)

fusions_with_partner_dependencies_and_cosmic_status <- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% filter(is_partner == TRUE & dependency_data_available == TRUE) %>% distinct(Fusion = fusion, cell_lines, CCLE_names, dependency, is_partner) %>% mutate(partner_dependency = ifelse(dependency == str_split_fixed(Fusion,"-",2)[,1],"left",ifelse(dependency == str_split_fixed(Fusion,"-",2)[,2],"right","none")))

fusion_guide_information_annotated_for_partner_dependencies <- left_join(fusions_with_partner_dependencies_and_cosmic_status, fusion_guide_information)

fusion_guide_information_annotated_for_partner_dependencies$partner_dependency <- fusion_guide_information_annotated_for_partner_dependencies$partner_dependency %>% replace_na("none")

fusion_guide_information_annotated_for_partner_dependencies <- fusion_guide_information_annotated_for_partner_dependencies %>% mutate(cosmic_fusion = Fusion %in% cosmic_fusions$value)

#Proportion of fusion-dependency-cell line combinations with partner dependencies that don't have sgRNAs falling on predicted fusion transcripts

partner_fusion_dependency_cell_line_combinations <- fusion_guide_information_annotated_for_partner_dependencies %>% summarise(n_distinct(Fusion,dependency,cell_lines)) %>% unlist() %>% unname()

partner_fusion_dependency_cell_line_combinations_with_sgRNAs_off_fusion_transcript <- fusion_guide_information_annotated_for_partner_dependencies %>% filter(partner_dependency == "left" & left_gene_guide_estimated_to_cut == 0) %>% summarise(n_distinct(Fusion,dependency,cell_lines)) %>% unlist() %>% unname() + fusion_guide_information_annotated_for_partner_dependencies %>% filter(partner_dependency == "right" & right_gene_guide_estimated_to_cut == 0) %>% summarise(n_distinct(Fusion,dependency,cell_lines)) %>% unlist() %>% unname()

proportion_of_partner_fusion_dependency_cell_line_combinations_with_sgRNAs_off_fusion_transcript <- partner_fusion_dependency_cell_line_combinations_with_sgRNAs_off_fusion_transcript/partner_fusion_dependency_cell_line_combinations

#Write output of fusion sgRNA locations
write_tsv(fusion_guide_information_annotated_for_partner_dependencies,here::here("results/datatables","fusion_guide_information_annotated_for_partner_dependencies.tsv"))

```

#CTD2 drug screening data for multiple myeloma cells
```{r}

#Add column identifying kinase targets to compound metadata

ctd2_compound_metadata <- ctd2_compound_metadata %>% mutate(list_of_targets = (gene_symbol_of_protein_target %>% str_split(pattern = ";")))

return_any_targets_that_are_kinases <- function(targets){

return(intersect(targets, oncogenes_tsps_kinases_drivers$Kinase) %>% str_c(sep = ",", collapse = ", "))
  
}

ctd2_compound_metadata$kinase_targets <- lapply(ctd2_compound_metadata$list_of_targets, return_any_targets_that_are_kinases)

ctd2_compound_metadata <- ctd2_compound_metadata %>% mutate(kinase_targets = ifelse(kinase_targets == "character(0)",FALSE,kinase_targets))

ctd2_compound_metadata <- ctd2_compound_metadata %>% mutate(kinase_targets = kinase_targets %>% as.character())

#Combining AUC data with metadata and formatting a tibble with cell names in the first column as rows and drug names as columns

ctd2_auc_annotated <- full_join(ctd2_auc, ctd2_experiment_metadata, by = "experiment_id")

ctd2_auc_annotated <- full_join(ctd2_auc_annotated, ctd2_cell_metadata, by = "master_ccl_id")

ctd2_auc_annotated <- full_join(ctd2_auc_annotated, ctd2_compound_metadata, by = "master_cpd_id")

ctd2_auc_gather <- ctd2_auc_annotated %>% dplyr::select(ccl_name, cpd_name, area_under_curve)

ctd2_auc_gather_mean <- ctd2_auc_gather %>% group_by(ccl_name, cpd_name) %>% summarise(area_under_curve = mean(area_under_curve))

ctd2_auc_spread_mean <- ctd2_auc_gather_mean %>% spread(key = cpd_name, value = area_under_curve) %>% dplyr::select(-547)

ctd2_auc_spread_mean_matrix <- ctd2_auc_spread_mean %>% column_to_rownames("ccl_name") %>% t()

ctd2_auc_spread_mean_matrix_df <- ctd2_auc_spread_mean_matrix %>% as.data.frame() %>% rownames_to_column(var = "cpd_name") 

#Multiple myeloma cell lines

multiple_myeloma_cells_all <- ALL_fusions_protein_coding_filtered_list_final %>% filter(lineage_subtype == "multiple_myeloma") %>% distinct(stripped_cell_line_name) %>% unlist() %>% unname()

multiple_myeloma_cells_IGH_NSD2 <- ALL_fusions_protein_coding_filtered_list_final %>% filter(lineage_subtype == "multiple_myeloma" & Fusion == "IGH-NSD2") %>% distinct(stripped_cell_line_name) %>% unlist() %>% unname()

multiple_myeloma_cells_IGH_NSD2_CTD2_data <- intersect(multiple_myeloma_cells_IGH_NSD2,colnames(ctd2_auc_spread_mean_matrix))

multiple_myeloma_cells_IGH_NSD2_null <- setdiff(multiple_myeloma_cells_all,multiple_myeloma_cells_IGH_NSD2)

multiple_myeloma_cells_IGH_NSD2_null_CTD2_data <- intersect(multiple_myeloma_cells_IGH_NSD2_null,colnames(ctd2_auc_spread_mean_matrix))

#Create AUC matrices for cell lines that have the fusion and cell lines that don't  
ctd2_auc_spread_mean_matrix_multiple_myeloma_cells_IGH_NSD2 <- ctd2_auc_spread_mean_matrix %>% subset(select = multiple_myeloma_cells_IGH_NSD2_CTD2_data)

ctd2_auc_spread_mean_matrix_multiple_myeloma_cells_IGH_NSD2_null <- ctd2_auc_spread_mean_matrix %>% subset(select = multiple_myeloma_cells_IGH_NSD2_null_CTD2_data)

#Compare AUC between the two groups with two sample t-test with equal variance and correct p-values using Benjamini-Hochberg procedure for multiple hypothesis testing
ctd2_auc_myeloma_cells_IGH_NSD2_with_vs_without_stats <- row_t_equalvar(ctd2_auc_spread_mean_matrix_multiple_myeloma_cells_IGH_NSD2, ctd2_auc_spread_mean_matrix_multiple_myeloma_cells_IGH_NSD2_null) %>% dplyr::mutate(BH_QValue = p.adjust(pvalue, "BH", length(ctd2_auc_spread_mean_matrix_multiple_myeloma_cells_IGH_NSD2[,1]))) %>% dplyr::mutate(negative_log10_BH_QValue = -log10(BH_QValue), cpd_name = ctd2_auc_spread_mean_matrix_df$cpd_name) %>% dplyr::rename(auc_difference = `mean.diff`, auc_with_fusion = `mean.x`, auc_without_fusion = `mean.y`) %>% dplyr::select(cpd_name, auc_difference, auc_with_fusion, auc_without_fusion, negative_log10_BH_QValue)

ctd2_auc_myeloma_cells_IGH_NSD2_with_vs_without_stats_annotated <- full_join(ctd2_auc_myeloma_cells_IGH_NSD2_with_vs_without_stats,ctd2_compound_metadata)

```

#RNA expression for multiple myeloma cells
```{r}

#Multiple myeloma cells with expression data
multiple_myeloma_cells_all_DepMap_ID <- ALL_fusions_protein_coding_filtered_list_final %>% filter(lineage_subtype == "multiple_myeloma") %>% distinct(DepMap_ID) %>% unlist() %>% unname()

multiple_myeloma_cells_IGH_NSD2_DepMap_ID <- ALL_fusions_protein_coding_filtered_list_final %>% filter(lineage_subtype == "multiple_myeloma" & Fusion == "IGH-NSD2") %>% distinct(DepMap_ID) %>% unlist() %>% unname()

multiple_myeloma_cells_IGH_NSD2_RNA_expression_data <- intersect(multiple_myeloma_cells_IGH_NSD2_DepMap_ID,colnames(ccle_expression_protein_coding_log2tpm_matrix))

multiple_myeloma_cells_IGH_NSD2_null_DepMap_ID <- setdiff(multiple_myeloma_cells_all_DepMap_ID,multiple_myeloma_cells_IGH_NSD2_DepMap_ID)

multiple_myeloma_cells_IGH_NSD2_null_RNA_expression_data <- intersect(multiple_myeloma_cells_IGH_NSD2_null_DepMap_ID,colnames(ccle_expression_protein_coding_log2tpm_matrix))

#Create RNA expression matrices for cell lines that have the fusion and cell lines that don't  
RNA_expression_matrix_multiple_myeloma_cells_IGH_NSD2 <- ccle_expression_protein_coding_log2tpm_matrix %>% subset(select = multiple_myeloma_cells_IGH_NSD2_RNA_expression_data)

RNA_expression_mean_matrix_multiple_myeloma_cells_IGH_NSD2_null <- ccle_expression_protein_coding_log2tpm_matrix %>% subset(select = multiple_myeloma_cells_IGH_NSD2_null_RNA_expression_data)

#Compare RNA expression between the two groups with two sample t-test with equal variance and correct p-values using Benjamini-Hochberg procedure for multiple hypothesis testing
RNA_expression_myeloma_cells_IGH_NSD2_with_vs_without_stats <- row_t_equalvar(RNA_expression_matrix_multiple_myeloma_cells_IGH_NSD2, RNA_expression_mean_matrix_multiple_myeloma_cells_IGH_NSD2_null) %>% dplyr::mutate(BH_QValue = p.adjust(pvalue, "BH", length(RNA_expression_matrix_multiple_myeloma_cells_IGH_NSD2[,1]))) %>% dplyr::mutate(negative_log10_BH_QValue = -log10(BH_QValue), gene = ccle_expression_protein_coding_log2tpm_matrix_df$gene) %>% dplyr::rename(log2_fold_change = `mean.diff`, expression_with_fusion = `mean.x`, expression_without_fusion = `mean.y`) %>% dplyr::select(gene, log2_fold_change, expression_with_fusion, expression_without_fusion, negative_log10_BH_QValue)

```

#Guide placement for NSD2 in IGH-NSD2 fusion
```{r}

fusion_guide_information_for_select_fusion <- tibble(Fusion=NA, cell_lines=NA, CCLE_names=NA, left_gene_guide_estimated_to_cut=NA,left_gene_guide_total=NA,left_gene_guide_percentage_cutting=NA,right_gene_guide_estimated_to_cut=NA,right_gene_guide_total=NA,right_gene_guide_percentage_cutting=NA)

fusion = "IGH-NSD2"

left_gene_fusion <- str_split_fixed(fusion,"-",2)[,1]
right_gene_fusion <- str_split_fixed(fusion,"-",2)[,2]

cell_lines_with_fusion <- ALL_fusions_protein_coding_filtered_list_final %>% dplyr::filter(Fusion == fusion) %>% distinct(DepMap_ID) %>% unlist() %>% unname() %>% intersect(colnames(ccle_dependency_probability_matrix))

CCLE_names_with_fusion <- ALL_fusions_protein_coding_filtered_list_final %>% filter(DepMap_ID %in% cell_lines_with_fusion) %>% distinct(CCLE_Name) %>% unlist() %>% unname()

cell_lines_with_each_fusion <- tibble(cell_lines = cell_lines_with_fusion, CCLE_names = CCLE_names_with_fusion)
  
for(cell in cell_lines_with_each_fusion$cell_lines){
  
left_gene_vector_guides_cutting_estimate <- list()
left_gene_guide_estimated_to_cut <- list()
right_gene_vector_guides_cutting_estimate <- list()
right_gene_guide_estimated_to_cut <- list()

#If dependency data available on left gene
if(left_gene_fusion %in% ccle_dependency_probability_matrix_df$gene){
  
left_gene_orientation <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(Fusion == fusion & DepMap_ID == cell) %>% dplyr::select(LeftChromOrientation) %>% distinct() %>% unlist() %>% unname()

left_gene_vector_guide_locations <- ccle_dependency_guides %>% filter(gene == left_gene_fusion) %>% dplyr::select(base) %>% distinct() %>% unlist() %>% unname() %>% as.double()

left_gene_breakpoints <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(Fusion == fusion & DepMap_ID == cell) %>% dplyr::select(LeftChromPosition) %>% unlist() %>% unname() %>% unique() %>% as.double()

left_gene_breakpoints_length <- left_gene_breakpoints %>% length()
  
#If left gene is in forward orientation, check to see if guides are to the left of the breakpoint and therefore estimated to cut
if(left_gene_orientation == "+"){
  
  for(breakpoint_index in c(1:left_gene_breakpoints_length)){
    
  left_gene_vector_guides_cutting_estimate[[breakpoint_index]] <- left_gene_vector_guide_locations < left_gene_breakpoints[[breakpoint_index]]
  left_gene_guide_estimated_to_cut[[breakpoint_index]] <- sum(left_gene_vector_guides_cutting_estimate[[breakpoint_index]] == TRUE)
    
  }
  
  }
#If left gene is in reverse orientation, check to see if guides are to the right of the breakpoint and therefore estimated to cut
  else{

  for(breakpoint_index in c(1:left_gene_breakpoints_length)){
  
  left_gene_vector_guides_cutting_estimate[[breakpoint_index]] <- left_gene_vector_guide_locations > left_gene_breakpoints[[breakpoint_index]]
  left_gene_guide_estimated_to_cut[[breakpoint_index]] <- sum(left_gene_vector_guides_cutting_estimate[[breakpoint_index]] == TRUE)
    
  } 
    
  }
  
}

#If dependency data available on right gene
if(right_gene_fusion %in% ccle_dependency_probability_matrix_df$gene){
  
right_gene_orientation <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(Fusion == fusion & DepMap_ID == cell) %>% dplyr::select(RightChromOrientation) %>% distinct() %>% unlist() %>% unname()

right_gene_vector_guide_locations <- ccle_dependency_guides %>% filter(gene == right_gene_fusion) %>% dplyr::select(base) %>% distinct() %>% unlist() %>% unname() %>% as.double()

right_gene_breakpoints <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(Fusion == fusion & DepMap_ID == cell) %>% dplyr::select(RightChromPosition) %>% unlist() %>% unname() %>% unique() %>% as.double()

right_gene_breakpoints_length <- right_gene_breakpoints %>% length()
  
#If right gene is in forward orientation, check to see if guides are to the right of the breakpoint and therefore estimated to cut
if(right_gene_orientation == "+"){
  
  for(breakpoint_index in c(1:right_gene_breakpoints_length)){
  
  right_gene_vector_guides_cutting_estimate[[breakpoint_index]] <- right_gene_vector_guide_locations > right_gene_breakpoints[[breakpoint_index]]
  right_gene_guide_estimated_to_cut[[breakpoint_index]] <- sum(right_gene_vector_guides_cutting_estimate[[breakpoint_index]] == TRUE)
    
  }
   
  }
#If right gene is in reverse orientation, check to see if guides are to the left of the breakpoint and therefore estimated to cut
  else{

  for(breakpoint_index in c(1:right_gene_breakpoints_length)){
  
  right_gene_vector_guides_cutting_estimate[[breakpoint_index]] <- right_gene_vector_guide_locations < right_gene_breakpoints[[breakpoint_index]]
  right_gene_guide_estimated_to_cut[[breakpoint_index]] <- sum(right_gene_vector_guides_cutting_estimate[[breakpoint_index]] == TRUE)
    
  }
    
  }
  
}


left_gene_guide_total <- length(left_gene_vector_guide_locations)
left_gene_guide_percentage_cutting <- percent(max(left_gene_guide_estimated_to_cut %>% unlist())/left_gene_guide_total)

right_gene_guide_total <- length(right_gene_vector_guide_locations)
right_gene_guide_percentage_cutting <- percent(max(right_gene_guide_estimated_to_cut %>% unlist())/right_gene_guide_total)

fusion_guide_information_for_select_fusion <- add_row(fusion_guide_information_for_select_fusion, Fusion=fusion, cell_lines = cell, CCLE_names = cell_lines_with_each_fusion %>% filter(cell_lines == cell) %>% dplyr::select(CCLE_names) %>% unlist() %>% unname(), left_gene_guide_estimated_to_cut=max(left_gene_guide_estimated_to_cut %>% unlist()), left_gene_guide_total=left_gene_guide_total,  left_gene_guide_percentage_cutting=left_gene_guide_percentage_cutting, right_gene_guide_estimated_to_cut=max(right_gene_guide_estimated_to_cut %>% unlist()), right_gene_guide_total=right_gene_guide_total, right_gene_guide_percentage_cutting=right_gene_guide_percentage_cutting)

}

fusion_guide_information_for_select_fusion <- fusion_guide_information_for_select_fusion[-1,]

write_tsv(fusion_guide_information_for_select_fusion,here::here("results/datatables","fusion_guide_information_for_multiple_myeloma_cells_with_IGH_NSD2_fusion.tsv"))

```

#Analysis for CRISPR data from NCIH23 lung cancer cell based organoid model CRISPR screen from "CRISPR screens in cancer spheroids identify 3D growth-specific vulnerabilities". Looking to see if EML4, a collateral dependency in the cell line, is also "disenriched" in the organoid model
```{r}

#Analysis for EML4

#NCIH23

NCIH23_sgrna_counts <- full_join(NCIH23_D19_3D_U1_counts, NCIH23_D19_3D_U2_counts, by = "sgrna")

NCIH23_sgrna_counts <- full_join(NCIH23_sgrna_counts, NCIH23_T0_counts, by = "sgrna")

NCIH23_sgrna_counts <- NCIH23_sgrna_counts %>% dplyr::rename(replicate_1 = count.x, replicate_2 = count.y, t_0 = count)

NCIH23_sgrna_counts <- NCIH23_sgrna_counts %>% mutate(gene = str_split_fixed(sgrna,"_",3)[,2]) %>% dplyr::select(sgrna,gene,replicate_1,replicate_2,t_0)

NCIH23_sgrna_counts <- NCIH23_sgrna_counts %>% mutate(replicate_1_log2fc = log2(replicate_1/t_0), replicate_2_log2fc = log2(replicate_2/t_0))

NCIH23_median_negative_control_sgrna_replicate_1 <- NCIH23_sgrna_counts %>% filter(gene %in% c("none","safe")) %>% summarise(median(replicate_1_log2fc,na.rm = TRUE)) %>% unlist() %>% unname() %>% as.double()

NCIH23_sd_negative_control_sgrna_replicate_1 <- NCIH23_sgrna_counts %>% filter(gene %in% c("none","safe")) %>% summarise(sd(replicate_1_log2fc,na.rm = TRUE)) %>% unlist() %>% unname() %>% as.double()

NCIH23_median_negative_control_sgrna_replicate_2 <- NCIH23_sgrna_counts %>% filter(gene %in% c("none","safe")) %>% summarise(median(replicate_2_log2fc,na.rm = TRUE)) %>% unlist() %>% unname() %>% as.double()

NCIH23_sd_negative_control_sgrna_replicate_2 <- NCIH23_sgrna_counts %>% filter(gene %in% c("none","safe")) %>% summarise(sd(replicate_2_log2fc,na.rm = TRUE)) %>% unlist() %>% unname() %>% as.double()

NCIH23_sgrna_counts <- NCIH23_sgrna_counts %>% mutate(replicate_1_log2fc_normalized = replicate_1_log2fc - NCIH23_median_negative_control_sgrna_replicate_1, replicate_2_log2fc_normalized = replicate_2_log2fc - NCIH23_median_negative_control_sgrna_replicate_2)

NCIH23_sgrna_counts <- NCIH23_sgrna_counts %>% mutate(replicate_1_pZ = replicate_1_log2fc_normalized/NCIH23_sd_negative_control_sgrna_replicate_1, replicate_2_pZ = replicate_2_log2fc_normalized/NCIH23_sd_negative_control_sgrna_replicate_2)

NCIH23_sgrna_counts_pZ <- NCIH23_sgrna_counts %>% dplyr::select(sgrna,gene,replicate_1_pZ,replicate_2_pZ)

NCIH23_sgrna_counts_pZ_gather <- NCIH23_sgrna_counts_pZ %>% gather(key = "replicate", value = "pZ", c(replicate_1_pZ, replicate_2_pZ))

NCIH23_sgrna_counts_pZ_gather_EML4 <- NCIH23_sgrna_counts_pZ_gather %>% filter(gene == "EML4") %>% mutate(cell_line = "NCIH23")

NCIH23_sgrna_counts_pZ_gather_EML4$replicate <- NCIH23_sgrna_counts_pZ_gather_EML4$replicate %>% recode(replicate_1_pZ = "Replicate 1", replicate_2_pZ = "Replicate 2")

#NCIH1975

NCIH1975_sgrna_counts <- full_join(NCIH1975_D19_3D_U1_counts, NCIH1975_D19_3D_U2_counts, by = "sgrna")

NCIH1975_sgrna_counts <- full_join(NCIH1975_sgrna_counts, NCIH1975_T0_counts, by = "sgrna")

NCIH1975_sgrna_counts <- NCIH1975_sgrna_counts %>% dplyr::rename(replicate_1 = count.x, replicate_2 = count.y, t_0 = count)

NCIH1975_sgrna_counts <- NCIH1975_sgrna_counts %>% mutate(gene = str_split_fixed(sgrna,"_",3)[,2]) %>% dplyr::select(sgrna,gene,replicate_1,replicate_2,t_0)

NCIH1975_sgrna_counts <- NCIH1975_sgrna_counts %>% mutate(replicate_1_log2fc = log2(replicate_1/t_0), replicate_2_log2fc = log2(replicate_2/t_0))

NCIH1975_median_negative_control_sgrna_replicate_1 <- NCIH1975_sgrna_counts %>% filter(gene %in% c("none","safe")) %>% summarise(median(replicate_1_log2fc,na.rm = TRUE)) %>% unlist() %>% unname() %>% as.double()

NCIH1975_sd_negative_control_sgrna_replicate_1 <- NCIH1975_sgrna_counts %>% filter(gene %in% c("none","safe")) %>% summarise(sd(replicate_1_log2fc,na.rm = TRUE)) %>% unlist() %>% unname() %>% as.double()

NCIH1975_median_negative_control_sgrna_replicate_2 <- NCIH1975_sgrna_counts %>% filter(gene %in% c("none","safe")) %>% summarise(median(replicate_2_log2fc,na.rm = TRUE)) %>% unlist() %>% unname() %>% as.double()

NCIH1975_sd_negative_control_sgrna_replicate_2 <- NCIH1975_sgrna_counts %>% filter(gene %in% c("none","safe")) %>% summarise(sd(replicate_2_log2fc,na.rm = TRUE)) %>% unlist() %>% unname() %>% as.double()

NCIH1975_sgrna_counts <- NCIH1975_sgrna_counts %>% mutate(replicate_1_log2fc_normalized = replicate_1_log2fc - NCIH1975_median_negative_control_sgrna_replicate_1, replicate_2_log2fc_normalized = replicate_2_log2fc - NCIH1975_median_negative_control_sgrna_replicate_2)

NCIH1975_sgrna_counts <- NCIH1975_sgrna_counts %>% mutate(replicate_1_pZ = replicate_1_log2fc_normalized/NCIH1975_sd_negative_control_sgrna_replicate_1, replicate_2_pZ = replicate_2_log2fc_normalized/NCIH1975_sd_negative_control_sgrna_replicate_2)

NCIH1975_sgrna_counts_pZ <- NCIH1975_sgrna_counts %>% dplyr::select(sgrna,gene,replicate_1_pZ,replicate_2_pZ)

NCIH1975_sgrna_counts_pZ_gather <- NCIH1975_sgrna_counts_pZ %>% gather(key = "replicate", value = "pZ", c(replicate_1_pZ, replicate_2_pZ))

NCIH1975_sgrna_counts_pZ_gather_EML4 <- NCIH1975_sgrna_counts_pZ_gather %>% filter(gene == "EML4") %>% mutate(cell_line = "NCIH1975")

NCIH1975_sgrna_counts_pZ_gather_EML4$replicate <- NCIH1975_sgrna_counts_pZ_gather_EML4$replicate %>% recode(replicate_1_pZ = "Replicate 1", replicate_2_pZ = "Replicate 2")

#NCIH2009

NCIH2009_sgrna_counts <- full_join(NCIH2009_D19_3D_U1_counts, NCIH2009_D19_3D_U2_counts, by = "sgrna")

NCIH2009_sgrna_counts <- full_join(NCIH2009_sgrna_counts, NCIH2009_T0_counts, by = "sgrna")

NCIH2009_sgrna_counts <- NCIH2009_sgrna_counts %>% dplyr::rename(replicate_1 = count.x, replicate_2 = count.y, t_0 = count)

NCIH2009_sgrna_counts <- NCIH2009_sgrna_counts %>% mutate(gene = str_split_fixed(sgrna,"_",3)[,2]) %>% dplyr::select(sgrna,gene,replicate_1,replicate_2,t_0)

NCIH2009_sgrna_counts <- NCIH2009_sgrna_counts %>% mutate(replicate_1_log2fc = log2(replicate_1/t_0), replicate_2_log2fc = log2(replicate_2/t_0))

NCIH2009_median_negative_control_sgrna_replicate_1 <- NCIH2009_sgrna_counts %>% filter(gene %in% c("none","safe")) %>% summarise(median(replicate_1_log2fc,na.rm = TRUE)) %>% unlist() %>% unname() %>% as.double()

NCIH2009_sd_negative_control_sgrna_replicate_1 <- NCIH2009_sgrna_counts %>% filter(gene %in% c("none","safe")) %>% summarise(sd(replicate_1_log2fc,na.rm = TRUE)) %>% unlist() %>% unname() %>% as.double()

NCIH2009_median_negative_control_sgrna_replicate_2 <- NCIH2009_sgrna_counts %>% filter(gene %in% c("none","safe")) %>% summarise(median(replicate_2_log2fc,na.rm = TRUE)) %>% unlist() %>% unname() %>% as.double()

NCIH2009_sd_negative_control_sgrna_replicate_2 <- NCIH2009_sgrna_counts %>% filter(gene %in% c("none","safe")) %>% summarise(sd(replicate_2_log2fc,na.rm = TRUE)) %>% unlist() %>% unname() %>% as.double()

NCIH2009_sgrna_counts <- NCIH2009_sgrna_counts %>% mutate(replicate_1_log2fc_normalized = replicate_1_log2fc - NCIH2009_median_negative_control_sgrna_replicate_1, replicate_2_log2fc_normalized = replicate_2_log2fc - NCIH2009_median_negative_control_sgrna_replicate_2)

NCIH2009_sgrna_counts <- NCIH2009_sgrna_counts %>% mutate(replicate_1_pZ = replicate_1_log2fc_normalized/NCIH2009_sd_negative_control_sgrna_replicate_1, replicate_2_pZ = replicate_2_log2fc_normalized/NCIH2009_sd_negative_control_sgrna_replicate_2)

NCIH2009_sgrna_counts_pZ <- NCIH2009_sgrna_counts %>% dplyr::select(sgrna,gene,replicate_1_pZ,replicate_2_pZ)

NCIH2009_sgrna_counts_pZ_gather <- NCIH2009_sgrna_counts_pZ %>% gather(key = "replicate", value = "pZ", c(replicate_1_pZ, replicate_2_pZ))

NCIH2009_sgrna_counts_pZ_gather_EML4 <- NCIH2009_sgrna_counts_pZ_gather %>% filter(gene == "EML4") %>% mutate(cell_line = "NCIH2009")

NCIH2009_sgrna_counts_pZ_gather_EML4$replicate <- NCIH2009_sgrna_counts_pZ_gather_EML4$replicate %>% recode(replicate_1_pZ = "Replicate 1", replicate_2_pZ = "Replicate 2")

#Combined data table of phenotypic Z scores for sgRNAs targeting EML4

combined_sgrna_counts_pZ_gather_EML4 <- bind_rows(NCIH23_sgrna_counts_pZ_gather_EML4, NCIH1975_sgrna_counts_pZ_gather_EML4, NCIH2009_sgrna_counts_pZ_gather_EML4)

combined_sgrna_counts_pZ_gather_EML4 <- combined_sgrna_counts_pZ_gather_EML4 %>% mutate(cell_line_with_or_without_fusion = ifelse(cell_line == "NCIH23","Fusion", "No fusion"))

combined_sgrna_counts_pZ_gather_EML4$cell_line <- factor(combined_sgrna_counts_pZ_gather_EML4$cell_line, levels = c("NCIH23","NCIH1975", "NCIH2009"))

combined_sgrna_counts_pZ_gather_EML4$cell_line_with_or_without_fusion <- factor(combined_sgrna_counts_pZ_gather_EML4$cell_line_with_or_without_fusion, levels = c("Fusion","No fusion"))

#Combined data table of phenotypic Z scores for sgRNAs targeting all nonessential genes

NCIH23_sgrna_counts_pZ_gather <- NCIH23_sgrna_counts_pZ_gather %>% mutate(cell_line = "NCIH23")

NCIH1975_sgrna_counts_pZ_gather <- NCIH1975_sgrna_counts_pZ_gather %>% mutate(cell_line = "NCIH1975")

NCIH2009_sgrna_counts_pZ_gather <- NCIH2009_sgrna_counts_pZ_gather %>% mutate(cell_line = "NCIH2009")

combined_sgrna_counts_pZ_gather <- bind_rows(NCIH23_sgrna_counts_pZ_gather, NCIH1975_sgrna_counts_pZ_gather, NCIH2009_sgrna_counts_pZ_gather)

combined_sgrna_counts_pZ_gather <- combined_sgrna_counts_pZ_gather %>% mutate(cell_line_with_or_without_fusion = ifelse(cell_line == "NCIH23","Fusion", "No fusion"))

combined_sgrna_counts_pZ_gather$cell_line <- factor(combined_sgrna_counts_pZ_gather$cell_line, levels = c("NCIH23","NCIH1975", "NCIH2009"))

combined_sgrna_counts_pZ_gather$cell_line_with_or_without_fusion <- factor(combined_sgrna_counts_pZ_gather$cell_line_with_or_without_fusion, levels = c("Fusion","No fusion"))

combined_sgrna_counts_pZ_gather_all_nonessential <- combined_sgrna_counts_pZ_gather %>% filter(gene %in% nonessentials_gene_list)

#Mean phenotypic Z scores of nonessential genes (grouped by gene)

mean_pZ_nonessentials <- combined_sgrna_counts_pZ_gather_all_nonessential %>% group_by(cell_line, cell_line_with_or_without_fusion, gene) %>% summarize(mean_pZ = mean(pZ, na.rm = TRUE))

```

#Analysis of which fusion-dependency pairings fall into fragile sites
```{r}

#Distinct fusion-dependency pairings annotated for chromosome starts and ends (for some reason there are two duplicated records - seems like some right partners may appear in the gene table multiple times)
distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends <- distinct_fusion_dependency_pairings %>% dplyr::rename(fusion = Fusion, dependency = Gene) %>% dplyr::select(fusion, dependency) %>% mutate(left_partner = str_split_fixed(fusion,"-",2)[,1], right_partner = str_split_fixed(fusion,"-",2)[,2])

distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends <- left_join(distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends,gene_coordinate_table_hg38, by = c("dependency" = "hgnc_symbol")) %>% dplyr::rename(dependency_chromosome = chromosome_name, dependency_start = start_position, dependency_end = end_position)

distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends <- left_join(distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends,gene_coordinate_table_hg38, by = c("left_partner" = "hgnc_symbol")) %>% dplyr::rename(left_partner_chromosome = chromosome_name, left_partner_start = start_position, left_partner_end = end_position)

distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends <- left_join(distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends,gene_coordinate_table_hg38, by = c("right_partner" = "hgnc_symbol")) %>% dplyr::rename(right_partner_chromosome = chromosome_name, right_partner_start = start_position, right_partner_end = end_position)

#Looking at partners and dependencies in fragile sites

sqldf('SELECT distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends.*,fragile_sites_PCAWG_hg38.* FROM distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends INNER JOIN fragile_sites_PCAWG_hg38 ON ((distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends.dependency_start BETWEEN fragile_sites_PCAWG_hg38.start AND fragile_sites_PCAWG_hg38.end) OR (distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends.dependency_end BETWEEN fragile_sites_PCAWG_hg38.start AND fragile_sites_PCAWG_hg38.end)) AND (distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends.dependency_chromosome = fragile_sites_PCAWG_hg38.chromosome)')

sqldf('SELECT distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends.*,fragile_sites_PCAWG_hg38.* FROM distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends INNER JOIN fragile_sites_PCAWG_hg38 ON ((distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends.left_partner_start BETWEEN fragile_sites_PCAWG_hg38.start AND fragile_sites_PCAWG_hg38.end) OR (distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends.left_partner_end BETWEEN fragile_sites_PCAWG_hg38.start AND fragile_sites_PCAWG_hg38.end)) AND (distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends.left_partner_chromosome = fragile_sites_PCAWG_hg38.chromosome)')

sqldf('SELECT distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends.*,fragile_sites_PCAWG_hg38.* FROM distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends INNER JOIN fragile_sites_PCAWG_hg38 ON ((distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends.right_partner_start BETWEEN fragile_sites_PCAWG_hg38.start AND fragile_sites_PCAWG_hg38.end) OR (distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends.right_partner_end BETWEEN fragile_sites_PCAWG_hg38.start AND fragile_sites_PCAWG_hg38.end)) AND (distinct_fusion_dependency_pairings_annotated_for_chromosome_starts_and_ends.right_partner_chromosome = fragile_sites_PCAWG_hg38.chromosome)')

```

#Revision: Evaluating the relationship between collateral dependency and TAD size (in the context of fusions)
```{r}

#TADs annotated with the genes assigned to them

reference_tad_boundaries_hg38_updated <- reference_tad_boundaries_hg38 %>% mutate(corresponding_genes = NA)

count <- 0

for (TAD in reference_tad_boundaries_hg38_updated$TAD_number){

genes_in_tad <- intersect(Gene_TAD_table %>% filter(TAD_identifier == TAD) %>% distinct(gene) %>% unlist() %>% unname(),ccle_dependency_probability_matrix_df$gene)

genes_adjacent_to_tad <- intersect(Gene_TAD_boundary_table %>% filter(upstream_TAD_identifier == TAD | downstream_TAD_identifier == TAD) %>% distinct(gene) %>% unlist() %>% unname(),ccle_dependency_probability_matrix_df$gene)

count_of_total_tad_associated_genes <- c(genes_in_tad,genes_adjacent_to_tad) %>% unique() %>% length()

reference_tad_boundaries_hg38_updated <- reference_tad_boundaries_hg38_updated %>% mutate(corresponding_genes = ifelse(TAD_number==TAD,count_of_total_tad_associated_genes,corresponding_genes))

count <- count + 1
print(count)

}

#Updated gene, dependency, partner, collateral status table with TAD annotations (And only filtering for genes belonging to a TAD, or in close proximity to an upstream or downstream TAD)

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers <- left_join(combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE,Gene_TAD_table[,c("gene","TAD_identifier")])

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers <- left_join(combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers,Gene_TAD_boundary_table)

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(!is.na(TAD_identifier) | !is.na(TAD_identifier) | !is.na(downstream_TAD_identifier))

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers <- left_join(combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers,reference_tad_boundaries_hg38_updated[,c("TAD_number","corresponding_genes")],by=c("TAD_identifier" = "TAD_number")) %>% rename(TAD_corresponding_genes=corresponding_genes)

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers <- left_join(combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers,reference_tad_boundaries_hg38_updated[,c("TAD_number","corresponding_genes")],by=c("upstream_TAD_identifier" = "TAD_number")) %>% rename(upstream_TAD_corresponding_genes=corresponding_genes)

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers <- left_join(combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers,reference_tad_boundaries_hg38_updated[,c("TAD_number","corresponding_genes")],by=c("downstream_TAD_identifier" = "TAD_number")) %>% rename(downstream_TAD_corresponding_genes=corresponding_genes)

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers$total_gene_count_corresponding_to_TADs <- rowSums(combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers[,c("TAD_corresponding_genes","upstream_TAD_corresponding_genes","downstream_TAD_corresponding_genes")], na.rm = TRUE)

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(total_gene_count_corresponding_to_TADs > 0) %>% mutate(total_gene_count_corresponding_to_TADs_quartile = ntile(total_gene_count_corresponding_to_TADs,4))

#Refining quartile assignment (TADs with 6, 11, and 22 genes are edge cases between quartile assignment). Reconcile by splitting the genes belonging to these TADs randomly between the upper or lower TAD
gene_TAD_quartile_tibble <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% group_by(gene) %>% distinct(total_gene_count_corresponding_to_TADs_quartile, total_gene_count_corresponding_to_TADs)

gene_TAD_quartile_tibble <- gene_TAD_quartile_tibble %>% group_by(gene) %>% mutate(TAD_quartiles = str_c(total_gene_count_corresponding_to_TADs_quartile,collapse = ", ")) %>% distinct(gene, total_gene_count_corresponding_to_TADs, TAD_quartiles) %>% mutate(TAD_quartiles = ifelse(TAD_quartiles %in% c(1,2,3,4),TAD_quartiles %>% as.double(),NA))

gene_TAD_quartile_tibble <- gene_TAD_quartile_tibble %>% mutate(TAD_quartiles_updated=ifelse(total_gene_count_corresponding_to_TADs == 6, sample(1:2,1), ifelse(total_gene_count_corresponding_to_TADs == 11, sample(2:3,1), ifelse(total_gene_count_corresponding_to_TADs == 22, sample(3:4,1),TAD_quartiles))))

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers <- left_join(combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers,gene_TAD_quartile_tibble[,c("gene","TAD_quartiles_updated")])

#Collateral dependency enrichment analysis for fusions repeated by TAD gene count quartile
#First quartile

sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 1 & sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 1 & sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 1 & sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 1 & sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile,sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile,sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile,sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile),nrow = 2)

fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile)

#Second quartile
sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 2 & sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 2 & sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 2 & sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 2 & sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile,sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile,sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile,sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile),nrow = 2)

fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile)

#Third quartile
sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 3 & sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 3 & sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 3 & sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 3 & sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile,sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile,sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile,sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile),nrow = 2)

fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile)

#Fourth quartile
sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 4 & sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 4 & sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 4 & sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_quartiles_updated == 4 & sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile,sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile,sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile,sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile),nrow = 2)

fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile)

#Distribution of TAD size plot

mean_genes_per_TAD <- reference_tad_boundaries_hg38_updated %>% filter(corresponding_genes>0) %>% summarise(mean(corresponding_genes)) %>% unlist() %>% unname() %>% as.double()

frequency_of_TADs_with_a_given_gene_count_3_22_21 <- ggplot(data = reference_tad_boundaries_hg38_updated %>% filter(corresponding_genes>0), aes(corresponding_genes)) + geom_histogram(binwidth = 1, color = "Dark blue") + geom_vline(xintercept = 5.75, linetype = "dashed", color = "red", size = 1) + geom_text(aes(x=13,y=300,label = str_c("Mean = ", mean_genes_per_TAD %>% round(1)), size = 6)) + labs(title = "Frequency of TADs with a given gene count", x = "Number of genes in TAD", y = "")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 18, color = "black"), axis.text.x = element_text(size = 18, color = "black"), axis.title = element_text(size = 18, color = "black"), title = element_text(size = 18, color = "black"), legend.position="none")

ggsave(here::here("results/TAD_fusion_dependency_and_expression_summary_plots","frequency_of_TADs_with_a_given_gene_count_3_22_21.png"),frequency_of_TADs_with_a_given_gene_count_3_22_21, height = 4, width = 8)

#Enrichment of fusion collateral genes amongst dependencies: stratified by TAD quartile

fusion_collateral_by_TAD_quartile_OR_text <- cbind(
  c("","TAD Quartile 1", "TAD Quartile 2", "TAD Quartile 3", "TAD Quartile 4"), c("OR",fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile)$estimate %>% round(2),fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile)$estimate %>% round(2),fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile)$estimate %>% round(2),fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile)$estimate %>% round(2)), c("p-value", "<.001","<.001","<.001","<.001"))

fusion_collateral_by_TAD_quartile_OR_data <- tibble(mean = c(NA,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile)$estimate,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile)$estimate,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile)$estimate,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile)$estimate), lower = c(NA,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile)$conf.int[1],fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile)$conf.int[1],fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile)$conf.int[1],fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile)$conf.int[1]), upper = c(NA,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_first_quartile)$conf.int[2],fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_second_quartile)$conf.int[2],fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_third_quartile)$conf.int[2],fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_fourth_quartile)$conf.int[2]))

forestplot::forestplot(fusion_collateral_by_TAD_quartile_OR_text,fusion_collateral_by_TAD_quartile_OR_data,is.summary = c(FALSE,FALSE,FALSE,FALSE), col = fpColors(box = "Dark blue", line = "Dark blue"), title = "Dependencies among fusion collateral genes vs.\nother genes stratified by TAD quartile", graph.pos = 3, zero = 1, txt_gp = fpTxtGp(ticks = gpar(cex = 1)))


#Collateral dependency enrichment analysis stratified by the presence or absence of a COSMIC Cancer Census Gene

TAD_identifiers_associated_with_COSMIC_genes <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(gene %in% cosmic_census_gene_symbols) %>% distinct(TAD_identifier, upstream_TAD_identifier, downstream_TAD_identifier) %>% unlist() %>% unname()

TAD_identifiers_associated_with_COSMIC_genes <- TAD_identifiers_associated_with_COSMIC_genes[!is.na(TAD_identifiers_associated_with_COSMIC_genes)]

combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% mutate(TAD_contains_COSMIC_gene = TAD_identifier %in% TAD_identifiers_associated_with_COSMIC_genes | upstream_TAD_identifier %in% TAD_identifiers_associated_with_COSMIC_genes | downstream_TAD_identifier %in% TAD_identifiers_associated_with_COSMIC_genes)

#With COSMIC genes

sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_contains_COSMIC_gene == TRUE & sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_contains_COSMIC_gene == TRUE & sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_contains_COSMIC_gene == TRUE & sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_contains_COSMIC_gene == TRUE & sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC,sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC,sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC,sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC),nrow = 2)

fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC)

#Without COSMIC genes

sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_contains_COSMIC_gene == FALSE & sv_collateral_gene == TRUE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_contains_COSMIC_gene == FALSE & sv_collateral_gene == TRUE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_contains_COSMIC_gene == FALSE & sv_collateral_gene == FALSE & dependency == TRUE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC <- combined_cell_line_gene_tibble_with_dependency_partner_collateral_information_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_with_TAD_identifiers %>% filter(TAD_contains_COSMIC_gene == FALSE & sv_collateral_gene == FALSE & dependency == FALSE) %>% summarise(n_distinct(cell_line,gene)) %>% unlist() %>% unname()

sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC <- matrix(c(sv_collateral_TRUE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC,sv_collateral_TRUE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC,sv_collateral_FALSE_and_dependency_TRUE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC,sv_collateral_FALSE_and_dependency_FALSE_count_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC),nrow = 2)

fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC)

#Forest plot

fusion_collateral_by_COSMIC_OR_text <- cbind(
  c("","With same-TAD\nCOSMIC gene", "Without same-TAD\nCOSMIC gene"), c("OR",fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC)$estimate %>% round(2),fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC)$estimate %>% round(2)), c("p-value",fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC)$p %>% scientific(),fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC)$p %>% scientific()))

fusion_collateral_by_COSMIC_OR_data <- tibble(mean = c(NA,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC)$estimate,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC)$estimate), lower = c(NA,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC)$conf.int[1],fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC)$conf.int[1]), upper = c(NA,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITH_COSMIC)$conf.int[2],fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_WITHOUT_COSMIC)$conf.int[2]))

forestplot::forestplot(fusion_collateral_by_COSMIC_OR_text,fusion_collateral_by_COSMIC_OR_data,is.summary = c(FALSE,FALSE,FALSE,FALSE), col = fpColors(box = "Dark blue", line = "Dark blue"), title = "Dependencies among fusion collateral genes vs.\nother genes stratified by same-TAD COSMIC genes", graph.pos = 3, zero = 1, txt_gp = fpTxtGp(ticks = gpar(cex = 1)))


```

#Revision: Updating gene permutation null model for TAD size/ number of TAD genes
```{r}


#Creating an updated dependency probability matrix annotated with TAD_quartiles

gene_TAD_quartile_tibble_updated <- gene_TAD_quartile_tibble %>% distinct(gene,total_gene_count_corresponding_to_TADs,TAD_quartiles_updated)

dependency_probability_fusion_with_vs_without_stats_TAD_quartiles <- list()
dependency_probability_fusion_with_vs_without_stats_TAD_quartiles_matrix <- list()

count <-  0

for(fusion in ALL_fusions_with_dependency_data){
  
dependency_probability_fusion_with_vs_without_stats_TAD_quartiles[[fusion]] <- left_join(dependency_probability_fusion_with_vs_without_stats[[fusion]], gene_TAD_quartile_tibble_updated) 

dependency_probability_fusion_with_vs_without_stats_TAD_quartiles[[fusion]]$TAD_quartiles_updated <- dependency_probability_fusion_with_vs_without_stats_TAD_quartiles[[fusion]]$TAD_quartiles_updated %>% replace_na(0)

dependency_probability_fusion_with_vs_without_stats_TAD_quartiles_matrix[[fusion]] <- dependency_probability_fusion_with_vs_without_stats_TAD_quartiles[[fusion]] %>% mutate(dependency = ifelse(dependency_probability_difference > 0.5,1,0), significant = ifelse(negative_log10_BH_QValue > -log10(.05),1,0), dependency_and_significant = ifelse(dependency == 1 & significant == 1, 1, 0)) %>% dplyr::select(dependency_and_significant,TAD_quartiles_updated)  

count = count + 1
print(count)
  
}

#Creating lists of corresponding TAD quartiles for all unique coding TAD neighbors with dependency data available

all_unique_coding_TAD_neighbors_with_dependency_data_tad_quartiles <- list()

count <-  0

for(fusion in ALL_fusions_with_dependency_data){

all_unique_coding_TAD_neighbors_with_dependency_data_tad_quartiles[[fusion]] <- dependency_probability_fusion_with_vs_without_stats_TAD_quartiles[[fusion]] %>% filter(gene %in% all_unique_coding_TAD_neighbors_with_dependency_data[[fusion]]) %>% dplyr::select(TAD_quartiles_updated) %>% unlist() %>% unname()     

counter = counter + 1
print(counter)
  
}

#Update gene permutation model

iteration_one_thousand <- c(1:1000)

multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_tad_quartiles <- c()

iteration_counter = 1

for(i in iteration_one_thousand){

cumulative_other_TAD_dependencies <- c()

for(fusion in ALL_fusions_with_dependency_data){

#Binary matrix of significant dependencies (0 = no, 1 = yes) and associated tad quartile
dependency_and_significant <- dependency_probability_fusion_with_vs_without_stats_TAD_quartiles_matrix[[fusion]][,c("dependency_and_significant","TAD_quartiles_updated")] 
dependency_and_significant <- dependency_and_significant %>% filter(!dependency_and_significant %>% is.na())

#Binary matrices of significant dependencies filtered for tad quartile
dependency_and_significant_no_quartile_tad <- dependency_and_significant %>% filter(TAD_quartiles_updated == 0) %>% dplyr::select(dependency_and_significant) %>% unlist() %>% unname()
dependency_and_significant_first_quartile_tad <- dependency_and_significant %>% filter(TAD_quartiles_updated == 1) %>% dplyr::select(dependency_and_significant) %>% unlist() %>% unname()
dependency_and_significant_second_quartile_tad <- dependency_and_significant %>% filter(TAD_quartiles_updated == 2) %>% dplyr::select(dependency_and_significant) %>% unlist() %>% unname()
dependency_and_significant_third_quartile_tad <- dependency_and_significant %>% filter(TAD_quartiles_updated == 3) %>% dplyr::select(dependency_and_significant) %>% unlist() %>% unname()
dependency_and_significant_fourth_quartile_tad <- dependency_and_significant %>% filter(TAD_quartiles_updated == 4) %>% dplyr::select(dependency_and_significant) %>% unlist() %>% unname()

#Individually sample the number of unique coding TAD neighbors with dependency data from each of the binary matrices, and sum these samples together. This is the equivalent of permuting all the genes.
sample_other_TAD_dependency <- sum(dependency_and_significant_no_quartile_tad %>% sample(length(all_unique_coding_TAD_neighbors_with_dependency_data_tad_quartiles[[fusion]][all_unique_coding_TAD_neighbors_with_dependency_data_tad_quartiles[[fusion]] == 0])), dependency_and_significant_first_quartile_tad %>% sample(length(all_unique_coding_TAD_neighbors_with_dependency_data_tad_quartiles[[fusion]][all_unique_coding_TAD_neighbors_with_dependency_data_tad_quartiles[[fusion]] == 1])), dependency_and_significant_second_quartile_tad %>% sample(length(all_unique_coding_TAD_neighbors_with_dependency_data_tad_quartiles[[fusion]][all_unique_coding_TAD_neighbors_with_dependency_data_tad_quartiles[[fusion]] == 2])), dependency_and_significant_third_quartile_tad %>% sample(length(all_unique_coding_TAD_neighbors_with_dependency_data_tad_quartiles[[fusion]][all_unique_coding_TAD_neighbors_with_dependency_data_tad_quartiles[[fusion]] == 3])), dependency_and_significant_fourth_quartile_tad %>% sample(length(all_unique_coding_TAD_neighbors_with_dependency_data_tad_quartiles[[fusion]][all_unique_coding_TAD_neighbors_with_dependency_data_tad_quartiles[[fusion]] == 4])))

cumulative_other_TAD_dependencies <- c(cumulative_other_TAD_dependencies, sample_other_TAD_dependency)

}

multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_tad_quartiles <- c(multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_tad_quartiles, cumulative_other_TAD_dependencies %>% sum())

iteration_counter = iteration_counter + 1
print(iteration_counter)

}


#Write output of fusion-dependency pairings expected from gene label permutation
write_tsv(as_tibble(multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_tad_quartiles),here::here("results/datatables","multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_tad_quartiles.tsv"))

#Updated collateral gene permutation model (controlling for TAD size)
multiple_iterations_cumulative_collateral_dependencies_permuted_by_tad_quartiles_3_21_22 <- ggplot(as_tibble(multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_tad_quartiles), aes(x = value)) + geom_density(size = 1, fill = "Dark grey") + geom_segment(data = count_of_actual_fusion_dependency_pairings_conservative %>% filter(partner_or_other_TAD == "other_TAD"), aes(x = count, xend = count, y = .02, yend = 0, size = 2, color = partner_or_other_TAD), arrow = arrow(length = unit(0.5,"cm")))+scale_color_manual(values = c("#B9DBF4"))+ labs(x = "Collateral fusion-dependency pairings", y = "Density") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank(), axis.text.x = element_text(size = 24, color = "black"), axis.title = element_text(size = 24, color = "black"), title = element_text(size = 24, color = "black"), legend.position = "none")

ggsave(here::here("results/TAD_fusion_dependency_and_expression_summary_plots","multiple_iterations_cumulative_collateral_dependencies_permuted_by_tad_quartiles_3_21_22.png"),multiple_iterations_cumulative_collateral_dependencies_permuted_by_tad_quartiles_3_21_22)

```

#Revision: IgH-NSD2 expression space and associated chromatin marks
```{r}

LETM1_expression_protein_coding_log2tpm_multiple_myeloma_cell_lines <- ccle_expression_protein_coding_log2tpm %>% select("DepMap_ID","LETM1") %>% filter(DepMap_ID %in% c(multiple_myeloma_cells_IGH_NSD2_RNA_expression_data,multiple_myeloma_cells_IGH_NSD2_null_RNA_expression_data)) %>% mutate(IGH_NSD2 = DepMap_ID %in% multiple_myeloma_cells_IGH_NSD2_RNA_expression_data)

LETM1_RNA_expression_among_multiple_myeloma_cell_lines <- ggplot(LETM1_expression_protein_coding_log2tpm_multiple_myeloma_cell_lines, aes(x = IGH_NSD2, y = LETM1, color = IGH_NSD2)) + geom_jitter () + scale_color_manual(values = c("Dark blue","Dark blue")) + geom_label_repel(data=LETM1_expression_protein_coding_log2tpm_multiple_myeloma_cell_lines %>% filter(DepMap_ID == "ACH-000541"), aes(label = c("KMS34")), label.size = NA, size = 6, fontface = "bold.italic", box.padding = .25, segment.color = "transparent") + labs(title = "LETM1 RNA expression among\nmultiple myeloma cell lines", x = "", y = "log2(TPM + 1)")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 18, color = "black"), axis.text.x = element_text(size = 18, color = "black"), axis.title = element_text(size = 18, color = "black"), title = element_text(size = 18, color = "black"), legend.position="none") + scale_x_discrete(labels = c("No IGH-NSD2\nfusion","","IGH-NSD2\nfusion"), limits = c("FALSE","","TRUE"))

ggsave(here::here("results/TAD_fusion_dependency_and_expression_summary_plots","LETM1_RNA_expression_among_multiple_myeloma_cell_lines_3_21_21.png"),LETM1_RNA_expression_among_multiple_myeloma_cell_lines)

NSD2_expression_protein_coding_log2tpm_multiple_myeloma_cell_lines <- ccle_expression_protein_coding_log2tpm %>% select(DepMap_ID,NSD2) %>% filter(DepMap_ID %in% c(multiple_myeloma_cells_IGH_NSD2_RNA_expression_data,multiple_myeloma_cells_IGH_NSD2_null_RNA_expression_data)) %>% mutate(IGH_NSD2 = DepMap_ID %in% multiple_myeloma_cells_IGH_NSD2_RNA_expression_data)

NSD2_RNA_expression_among_multiple_myeloma_cell_lines <- ggplot(NSD2_expression_protein_coding_log2tpm_multiple_myeloma_cell_lines, aes(x = IGH_NSD2, y = NSD2, color = IGH_NSD2)) + geom_jitter() + scale_color_manual(values = c("Dark blue","Dark blue")) + geom_label_repel(data=NSD2_expression_protein_coding_log2tpm_multiple_myeloma_cell_lines %>% filter(DepMap_ID %in% c("ACH-000050","ACH-000714")), aes(label = c("KMS11","NCIH929")), label.size = NA, size = 6, fontface = "bold.italic", box.padding = 1, segment.color = "transparent") + labs(title = "NSD2 RNA expression among\nmultiple myeloma cell lines", x = "", y = "log2(TPM + 1)")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 18, color = "black"), axis.text.x = element_text(size = 18, color = "black"), axis.title = element_text(size = 18, color = "black"), title = element_text(size = 18, color = "black"), legend.position="none") + scale_x_discrete(labels = c("No IGH-NSD2\nfusion","","IGH-NSD2\nfusion"), limits = c("FALSE","","TRUE"))

ggsave(here::here("results/TAD_fusion_dependency_and_expression_summary_plots","NSD2_RNA_expression_among_multiple_myeloma_cell_lines_3_21_21.png"),NSD2_RNA_expression_among_multiple_myeloma_cell_lines)

FGFR3_expression_protein_coding_log2tpm_multiple_myeloma_cell_lines <- ccle_expression_protein_coding_log2tpm %>% select(DepMap_ID,FGFR3) %>% filter(DepMap_ID %in% c(multiple_myeloma_cells_IGH_NSD2_RNA_expression_data,multiple_myeloma_cells_IGH_NSD2_null_RNA_expression_data)) %>% mutate(IGH_NSD2 = DepMap_ID %in% multiple_myeloma_cells_IGH_NSD2_RNA_expression_data)

FGFR3_RNA_expression_among_multiple_myeloma_cell_lines <- ggplot(FGFR3_expression_protein_coding_log2tpm_multiple_myeloma_cell_lines, aes(x = IGH_NSD2, y = FGFR3, color = IGH_NSD2)) + geom_jitter() + scale_color_manual(values = c("Dark blue","Dark blue")) + labs(title = "FGFR3 RNA expression among\nmultiple myeloma cell lines", x = "", y = "log2(TPM + 1)")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 18, color = "black"), axis.text.x = element_text(size = 18, color = "black"), axis.title = element_text(size = 18, color = "black"), title = element_text(size = 18, color = "black"), legend.position="none") + scale_x_discrete(labels = c("No IGH-NSD2\nfusion","","IGH-NSD2\nfusion"), limits = c("FALSE","","TRUE")) + scale_y_continuous(breaks = c(2,4,6,8,10))

ggsave(here::here("results/TAD_fusion_dependency_and_expression_summary_plots","FGFR3_RNA_expression_among_multiple_myeloma_cell_lines_3_21_21.png"),FGFR3_RNA_expression_among_multiple_myeloma_cell_lines)

```

#Revision: TCGA comparative analysis
```{r}

write_tsv(frequency_of_fusion_and_partner_recurrence_in_human_samples_filtered_for_fusions_from_cell_lines_derived_from_tumors_with_representation_in_tcga_fusion_call_list,here::here("results/datatables","frequency_of_fusion_and_partner_recurrence_in_human_samples_filtered_for_fusions_from_cell_lines_derived_from_tumors_with_representation_in_tcga_fusion_call_list.tsv"))

mean_partner_representation_count_of_CCLE_fusion_in_TCGA <- frequency_of_fusion_and_partner_recurrence_in_human_samples_filtered_for_fusions_from_cell_lines_derived_from_tumors_with_representation_in_tcga_fusion_call_list %>% filter(!Fusion == "TMPRSS2-ERG") %>% summarise(mean(tcga_max_partner_count)) %>% unlist() %>% unname() %>% as.double()

representation_of_CCLE_fusions_in_the_TCGA_3_22_21 <- ggplot(data = frequency_of_fusion_and_partner_recurrence_in_human_samples_filtered_for_fusions_from_cell_lines_derived_from_tumors_with_representation_in_tcga_fusion_call_list, aes(tcga_max_partner_count)) + geom_histogram(binwidth = 1, color = "Dark blue") + geom_vline(xintercept = 13.6, linetype = "dashed", color = "red", size = 1) +geom_label_repel(data=frequency_of_fusion_and_partner_recurrence_in_human_samples_filtered_for_fusions_from_cell_lines_derived_from_tumors_with_representation_in_tcga_fusion_call_list %>% filter(Fusion == "TMPRSS2-ERG"), aes(label = "TMPRSS2-ERG"), label.size = NA, size = 6, fontface = "bold.italic", box.padding = 1, segment.color = "Red", y = 1) + geom_text(aes(x=35,y=20,label = str_c("Mean = ", mean_partner_representation_count_of_CCLE_fusion_in_TCGA %>% round(1)), size = 6))  + labs(title = "Representation of 295 fusions\nfrom CCLE in the TCGA", x = "Count of times a partner involved in a CCLE\nfusion is seen in a TCGA fusion", y = "Frequency")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 18, color = "black"), axis.text.x = element_text(size = 18, color = "black"), axis.title = element_text(size = 18, color = "black"), title = element_text(size = 18, color = "black"), legend.position="none")

ggsave(here::here("results/TAD_fusion_dependency_and_expression_summary_plots","representation_of_CCLE_fusions_in_the_TCGA_3_22_21.png"),representation_of_CCLE_fusions_in_the_TCGA_3_22_21)

```

#Revision: Fusions with partner dependencies - in-frame vs. out-of-frame
```{r}

#Fusions for which you need in-frame vs. out-of-frame information for

fusions_with_partner_dependencies <- distinct_fusion_dependency_pairings %>% filter(is_partner == TRUE) %>% distinct(Fusion) %>% unlist() %>% unname()

fusions_with_partner_dependencies_tibble <- fusions_with_partner_dependencies %>% as_tibble()

fusions_with_partner_dependencies_tibble <- fusions_with_partner_dependencies_tibble %>% mutate(fusion_name = str_c(str_split_fixed(value,"-",2)[,1],"--",str_split_fixed(value,"-",2)[,2]))

STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies <- ccle_fusions %>% filter(DepMap_ID %in% ccle_dependency_probability$DepMap_ID & !DepMap_ID == "ACH-000315" & (`#FusionName` %in% fusions_with_partner_dependencies_tibble$fusion_name | str_detect(`#FusionName`,"BCL2--IGH") | str_detect(`#FusionName`,"RUNX1--IGH")))

write_tsv(STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies,here::here("data","STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies_3_18_21.tsv"))

#Fusions updated with in-frame vs. out-of-frame annotations

STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies_with_coding_effects_updated <- read_tsv(here::here("data","STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies_with_coding_effects_updated_3_18_21.txt"))

STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies_with_coding_effects_updated_protein_annotations_only <- STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies_with_coding_effects_updated %>% filter(!PROT_FUSION_TYPE == ".")

fusions_with_multiple_protein_annotations <- STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies_with_coding_effects_updated_protein_annotations_only %>% group_by(`#FusionName`) %>% summarise(count_of_protein_annotations = n_distinct(PROT_FUSION_TYPE)) %>% arrange(desc(count_of_protein_annotations)) %>% filter(count_of_protein_annotations == 2) %>% distinct(`#FusionName`) %>% unlist() %>% unname()

STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies_with_coding_effects_updated_protein_annotations_only <- STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies_with_coding_effects_updated_protein_annotations_only %>% filter(!(`#FusionName` %in% fusions_with_multiple_protein_annotations & PROT_FUSION_TYPE == "FRAMESHIFT")) %>% distinct(`#FusionName`,PROT_FUSION_TYPE) %>% filter(!`#FusionName` %in% c("BCL2--IGHG2","RUNX1--IGHD"))

STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies_with_coding_effects_updated_protein_annotations_only$`#FusionName` <- STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies_with_coding_effects_updated_protein_annotations_only$`#FusionName` %>% str_replace("IGH@","IGH")

STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies_with_coding_effects_updated_protein_annotations_only$PROT_FUSION_TYPE <- STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies_with_coding_effects_updated_protein_annotations_only$PROT_FUSION_TYPE %>% str_replace("FRAMESHIFT","Out-of-frame") %>% str_replace("INFRAME","In-frame")

write_tsv(STARFusion_calls_for_ccle_for_fusions_with_partner_dependencies_with_coding_effects_updated_protein_annotations_only,here::here("results/datatables","predicted_protein_coding_consequence_of_selected_fusions_with_partner_dependencies.tsv"))

```

#Revision: RNA expression
```{r}

partner_fusion_dependency_pairings <- distinct_fusion_dependency_pairings %>% filter(is_partner == TRUE) %>% mutate(fusion_dependency_pairing = str_c(Fusion,"-",Gene)) %>% distinct(fusion_dependency_pairing) %>% unlist() %>% unname()

collateral_fusion_dependency_pairings <- distinct_fusion_dependency_pairings %>% filter(is_partner == FALSE) %>% mutate(fusion_dependency_pairing = str_c(Fusion,"-",Gene)) %>% distinct(fusion_dependency_pairing) %>% unlist() %>% unname()

RNA_expression_data_by_dependency_and_fusion_updated <- RNA_expression_data_by_dependency_and_fusion %>% mutate(fusion_dependency_pairing = str_c(fusion,"-",dependency))

RNA_expression_data_by_dependency_and_fusion_updated <- RNA_expression_data_by_dependency_and_fusion_updated %>% mutate(is_partner = fusion_dependency_pairing %in% partner_fusion_dependency_pairings)

rna_expression_distribution_of_fusion_dependency_pairings <- ggplot(data = RNA_expression_data_by_dependency_and_fusion_updated, aes(x=is_partner,y=log2_fold_change,color=is_partner)) + geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 1) + geom_violin(size = 1) + scale_color_manual(values = c("Dark Blue","Dark Blue"))+ stat_summary(fun.y=mean, geom="point", size=2, color=c("Dark Blue","Dark Blue")) + labs(title = "RNA expression distribution\nof fusion-associated dependencies", x = "", y = "log2 fold change (TPM + 1)")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 18, color = "black"), axis.text.x = element_text(size = 18, color = "black"), axis.title = element_text(size = 18, color = "black"), title = element_text(size = 18, color = "black"), legend.position="none") + scale_x_discrete(labels = c("Collateral","Partner")) + stat_compare_means(method = "t.test", comparisons = ttest_comparisons_partners, size = 6, vjust = 1, bracket.size = 0, step.increase = .1)

ggsave(here::here("results/TAD_fusion_dependency_and_expression_summary_plots","rna_expression_distribution_of_fusion_dependency_pairings_3_20_21.png"),rna_expression_distribution_of_fusion_dependency_pairings, height = 6, width = 10)

fusion_dependency_log2_fold_change_stratified_rna_expression_tibble <- tibble(log2_fold_change = c("log2 fold change\nTPM > 1", "log2 fold change\nTPM < -1"), proportion = c(387/659*100,31/659*100))

rna_expression_distribution_of_fusion_dependency_pairings_stratified <- ggplot(fusion_dependency_log2_fold_change_stratified_rna_expression_tibble,aes(fill = log2_fold_change, x = log2_fold_change, y = proportion))+geom_bar(color = "black", position = "stack", stat = "identity") + labs(title = "RNA expression distribution of fusion-associated\ndependencies (stratified by under- and over-expression)",x = "", y = "Percentage", fill = "") + scale_fill_manual(values = c("Dark blue","Dark blue"))  + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text = element_text(size = 18, color = "black"), axis.title = element_text(size = 18, color = "black"), title = element_text(size = 18, color = "black"), legend.text = element_text(size = 18, color = "black"), legend.position = "none") + coord_cartesian(ylim = c(0,110))+ scale_y_continuous(breaks = c(0,20,40,60,80,100))

ggsave(here::here("results/TAD_fusion_dependency_and_expression_summary_plots","rna_expression_distribution_of_fusion_dependency_pairings_stratified_3_20_21.png"),rna_expression_distribution_of_fusion_dependency_pairings_stratified, height = 6, width = 10)

```


#Plots
```{r}

#Forest plot summary of structural variant enrichment for partner dependencies

sv_partner_OR_text <- cbind(
  c("Structural variants", "Fusions", "Translocations", "Inversions", 
    "Deletions", "Duplications", "All"), c("OR",fisher.test(sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$estimate %>% round(2),fisher.test(sv_partner_dependency_matrix_TRANSLOCATIONS)$estimate %>% round(2),fisher.test(sv_partner_dependency_matrix_INVERSIONS)$estimate %>% round(2),fisher.test(sv_partner_dependency_matrix_DELETIONS)$estimate %>% round(2),fisher.test(sv_partner_dependency_matrix_DUPLICATIONS)$estimate %>% round(2),fisher.test(sv_partner_dependency_matrix_ALL_SVs)$estimate %>% round(2)), c("p-value","<.004",".074","<.004","<.004","<.004","<.004"))

sv_partner_OR_data <- tibble(mean = c(NA,fisher.test(sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$estimate,fisher.test(sv_partner_dependency_matrix_TRANSLOCATIONS)$estimate,fisher.test(sv_partner_dependency_matrix_INVERSIONS)$estimate,fisher.test(sv_partner_dependency_matrix_DELETIONS)$estimate,fisher.test(sv_partner_dependency_matrix_DUPLICATIONS)$estimate,fisher.test(sv_partner_dependency_matrix_ALL_SVs)$estimate), lower = c(NA,fisher.test(sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$conf.int[1],fisher.test(sv_partner_dependency_matrix_TRANSLOCATIONS)$conf.int[1],fisher.test(sv_partner_dependency_matrix_INVERSIONS)$conf.int[1],fisher.test(sv_partner_dependency_matrix_DELETIONS)$conf.int[1],fisher.test(sv_partner_dependency_matrix_DUPLICATIONS)$conf.int[1],fisher.test(sv_partner_dependency_matrix_ALL_SVs)$conf.int[1]), upper = c(NA,fisher.test(sv_partner_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$conf.int[2],fisher.test(sv_partner_dependency_matrix_TRANSLOCATIONS)$conf.int[2],fisher.test(sv_partner_dependency_matrix_INVERSIONS)$conf.int[2],fisher.test(sv_partner_dependency_matrix_DELETIONS)$conf.int[2],fisher.test(sv_partner_dependency_matrix_DUPLICATIONS)$conf.int[2],fisher.test(sv_partner_dependency_matrix_ALL_SVs)$conf.int[2]))

forestplot::forestplot(sv_partner_OR_text,sv_partner_OR_data,is.summary = c(TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE), col = fpColors(box = "Dark blue", line = "Dark blue", summary = "Dark blue"), title = "Dependencies among structural variant partner genes vs. other genes", graph.pos = 3, zero = 1, txt_gp = fpTxtGp(ticks = gpar(cex = 1)))

#Forest plot summary of structural variant enrichment for collateral dependencies

sv_collateral_OR_text <- cbind(
  c("Structural variants", "Fusions", "Translocations", "Inversions", 
    "Deletions", "Duplications", "All"), c("OR",fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$estimate %>% round(2),fisher.test(sv_collateral_dependency_matrix_TRANSLOCATIONS)$estimate %>% round(2),fisher.test(sv_collateral_dependency_matrix_INVERSIONS)$estimate %>% round(2),fisher.test(sv_collateral_dependency_matrix_DELETIONS)$estimate %>% round(2),fisher.test(sv_collateral_dependency_matrix_DUPLICATIONS)$estimate %>% round(2),fisher.test(sv_collateral_dependency_matrix_ALL_SVs)$estimate %>% round(2)), c("p-value","<.004","<.004","<.004","<.004","<.004","<.004"))

sv_collateral_OR_data <- tibble(mean = c(NA,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$estimate,fisher.test(sv_collateral_dependency_matrix_TRANSLOCATIONS)$estimate,fisher.test(sv_collateral_dependency_matrix_INVERSIONS)$estimate,fisher.test(sv_collateral_dependency_matrix_DELETIONS)$estimate,fisher.test(sv_collateral_dependency_matrix_DUPLICATIONS)$estimate,fisher.test(sv_collateral_dependency_matrix_ALL_SVs)$estimate), lower = c(NA,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$conf.int[1],fisher.test(sv_collateral_dependency_matrix_TRANSLOCATIONS)$conf.int[1],fisher.test(sv_collateral_dependency_matrix_INVERSIONS)$conf.int[1],fisher.test(sv_collateral_dependency_matrix_DELETIONS)$conf.int[1],fisher.test(sv_collateral_dependency_matrix_DUPLICATIONS)$conf.int[1],fisher.test(sv_collateral_dependency_matrix_ALL_SVs)$conf.int[1]), upper = c(NA,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$conf.int[2],fisher.test(sv_collateral_dependency_matrix_TRANSLOCATIONS)$conf.int[2],fisher.test(sv_collateral_dependency_matrix_INVERSIONS)$conf.int[2],fisher.test(sv_collateral_dependency_matrix_DELETIONS)$conf.int[2],fisher.test(sv_collateral_dependency_matrix_DUPLICATIONS)$conf.int[2],fisher.test(sv_collateral_dependency_matrix_ALL_SVs)$conf.int[2]))

forestplot::forestplot(sv_collateral_OR_text,sv_collateral_OR_data,is.summary = c(TRUE,FALSE,FALSE,FALSE,FALSE,FALSE,TRUE), col = fpColors(box = "Dark blue", line = "Dark blue", summary = "Dark blue"), title = "Dependencies among structural variant collateral genes vs. other genes", graph.pos = 3, zero = 1, txt_gp = fpTxtGp(ticks = gpar(cex = 1)), xticks = c(0.5,1,1.5,2))

#Forest plot summary of fusion enrichment for collateral dependencies, comparing the use of TADs vs. genomic distances

fusion_genomic_distance_vs_tad_OR_text <- cbind(
  c("", "Defined by\ngenomic distance", "Defined by normal\nTAD boundaries"), c("OR",fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances)$estimate %>% round(2),fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$estimate %>% round(2)), c("p-value","<.001","<.001"))

fusion_genomic_distance_vs_tad_OR_data <- tibble(mean = c(NA,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances)$estimate,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$estimate), lower = c(NA,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances)$conf.int[1],fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$conf.int[1]), upper = c(NA,fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE_using_genomic_distances)$conf.int[2],fisher.test(sv_collateral_dependency_matrix_FUSIONS_SUPPORTED_BY_SV_EVIDENCE)$conf.int[2]))

forestplot::forestplot(fusion_genomic_distance_vs_tad_OR_text,fusion_genomic_distance_vs_tad_OR_data,is.summary = c(TRUE,FALSE,FALSE), col = fpColors(box = "Dark blue", line = "Dark blue", summary = "Dark blue"), title = "Dependencies among fusion collateral genes vs. other genes", graph.pos = 3, zero = 1, txt_gp = fpTxtGp(ticks = gpar(cex = 1)), xticks = c(0.5,1,1.5,2))

#Forest plot summary of enrichment of COSMIC fusions and COSMIC cancer genes among fusions with partner dependencies

fusions_with_partner_dependencies_enrichment_of_COSMIC_fusions_and_COSMIC_cancer_genes_OR_text <- fusion_genomic_distance_vs_tad_OR_text <- cbind(
  c("", "COSMIC fusions", "COSMIC cancer\ncensus genes"), c("OR",fisher.test(fusion_partner_dependency_cosmic_fusion_matrix)$estimate %>% round(2),fisher.test(fusion_partner_dependency_cosmic_gene_matrix)$estimate %>% round(2)), c("p-value","<.001","<.001"))

fusions_with_partner_dependencies_enrichment_of_COSMIC_fusions_and_COSMIC_cancer_genes_OR_data <- tibble(mean = c(NA,fisher.test(fusion_partner_dependency_cosmic_fusion_matrix)$estimate,fisher.test(fusion_partner_dependency_cosmic_gene_matrix)$estimate), lower = c(NA,fisher.test(fusion_partner_dependency_cosmic_fusion_matrix)$conf.int[1],fisher.test(fusion_partner_dependency_cosmic_gene_matrix)$conf.int[1]), upper = c(NA,fisher.test(fusion_partner_dependency_cosmic_fusion_matrix)$conf.int[2],fisher.test(fusion_partner_dependency_cosmic_gene_matrix)$conf.int[2]))

forestplot::forestplot(fusions_with_partner_dependencies_enrichment_of_COSMIC_fusions_and_COSMIC_cancer_genes_OR_text,fusions_with_partner_dependencies_enrichment_of_COSMIC_fusions_and_COSMIC_cancer_genes_OR_data,is.summary = c(TRUE,FALSE,FALSE), col = fpColors(box = "Dark blue", line = "Dark blue", summary = "Dark blue"), title = "COSMIC fusions and COSMIC cancer census genes among fusions\nwith partner dependencies vs. no associated dependencies", graph.pos = 3, zero = 1, txt_gp = fpTxtGp(ticks = gpar(cex = 1)))

#Forest plot summary of enrichment of COSMIC fusions and COSMIC cancer genes among fusions with collateral dependencies

fusions_with_collateral_dependencies_enrichment_of_COSMIC_fusions_and_COSMIC_cancer_genes_OR_text <- fusion_genomic_distance_vs_tad_OR_text <- cbind(
  c("", "COSMIC fusions", "COSMIC cancer\ncensus genes"), c("OR",fisher.test(fusion_collateral_dependency_cosmic_fusion_matrix)$estimate %>% round(2),fisher.test(fusion_collateral_dependency_cosmic_gene_matrix)$estimate %>% round(2)), c("p-value","0.25","0.74"))

fusions_with_collateral_dependencies_enrichment_of_COSMIC_fusions_and_COSMIC_cancer_genes_OR_data <- tibble(mean = c(NA,fisher.test(fusion_collateral_dependency_cosmic_fusion_matrix)$estimate,fisher.test(fusion_collateral_dependency_cosmic_gene_matrix)$estimate), lower = c(NA,fisher.test(fusion_collateral_dependency_cosmic_fusion_matrix)$conf.int[1],fisher.test(fusion_collateral_dependency_cosmic_gene_matrix)$conf.int[1]), upper = c(NA,fisher.test(fusion_collateral_dependency_cosmic_fusion_matrix)$conf.int[2],fisher.test(fusion_collateral_dependency_cosmic_gene_matrix)$conf.int[2]))

forestplot::forestplot(fusions_with_collateral_dependencies_enrichment_of_COSMIC_fusions_and_COSMIC_cancer_genes_OR_text,fusions_with_collateral_dependencies_enrichment_of_COSMIC_fusions_and_COSMIC_cancer_genes_OR_data,is.summary = c(TRUE,FALSE,FALSE), col = fpColors(box = "Dark blue", line = "Dark blue", summary = "Dark blue"), title = "COSMIC fusions and COSMIC cancer census genes among fusions\nwith collateral dependencies vs. no associated dependencies", graph.pos = 3, zero = 1, txt_gp = fpTxtGp(ticks = gpar(cex = 1)))

#Violin plots of the distribution of ORs for enrichment of partner and collateral genes (on a cell line basis) among absolute dependencies by SV category
ttest_comparisons_partners <- list(c("fusion_partner_OR", "translocation_partner_OR"),c("fusion_partner_OR", "inversion_partner_OR"),c("fusion_partner_OR", "deletion_partner_OR"),c("fusion_partner_OR", "duplication_partner_OR"))

ttest_comparisons_collateral <- list(c("fusion_collateral_OR", "translocation_collateral_OR"),c("fusion_collateral_OR", "inversion_collateral_OR"),c("fusion_collateral_OR", "deletion_collateral_OR"),c("fusion_collateral_OR", "duplication_collateral_OR"))

distribution_of_odds_ratios_for_enrichment_of_partner_genes_among_absolute_dependencies_by_SV_category <- ggplot(data = cell_lines_and_fusion_partner_and_collateral_gene_ORs_tibble_filtered_to_cell_lines_with_fusions_with_WGS_evidence_gathered %>% filter(category %in% c("fusion_partner_OR","translocation_partner_OR","inversion_partner_OR","deletion_partner_OR","duplication_partner_OR") & odds_ratio != "Inf"), aes(x=category,y=odds_ratio,color=category)) + geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 1) + geom_violin(size = 1) + scale_color_manual(values = c("Red","Black","Black","Black","Black"))+ stat_summary(fun.y=mean, geom="point", size=2, color=c("Red","Black","Black","Black","Black")) + labs(title = "Distribution of odds ratios for enrichment of partner\ngenes among absolute dependencies by SV category", x = "", y = "Odds ratio")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none") + scale_x_discrete(labels = c("Fusions","Translocations","Inversions","Deletions","Duplications")) + stat_compare_means(method = "t.test", comparisons = ttest_comparisons_partners, size = 6, vjust = 1, bracket.size = 0, step.increase = .1)

distribution_of_odds_ratios_for_enrichment_of_collateral_genes_among_absolute_dependencies_by_SV_category <- ggplot(data = cell_lines_and_fusion_partner_and_collateral_gene_ORs_tibble_filtered_to_cell_lines_with_fusions_with_WGS_evidence_gathered %>% filter(category %in% c("fusion_collateral_OR","translocation_collateral_OR","inversion_collateral_OR","deletion_collateral_OR","duplication_collateral_OR") & odds_ratio != "Inf"), aes(x=category,y=odds_ratio,color=category)) + geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 1) + geom_violin(size = 1) + scale_color_manual(values = c("Red","Black","Black","Black","Black"))+ stat_summary(fun.y=mean, geom="point", size=2, color=c("Red","Black","Black","Black","Black")) + labs(title = "Distribution of odds ratios for enrichment of collateral\ngenes among absolute dependencies by SV category", x = "", y = "Odds ratio")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none") + scale_x_discrete(labels = c("Fusions","Translocations","Inversions","Deletions","Duplications")) + stat_compare_means(method = "t.test", comparisons = ttest_comparisons_collateral, size = 6, vjust = 1, bracket.size = 0, step.increase = .1)

ggsave(plot = distribution_of_odds_ratios_for_enrichment_of_partner_genes_among_absolute_dependencies_by_SV_category, width = 10, height = 7, filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","distribution_of_odds_ratios_for_enrichment_of_partner_genes_among_absolute_dependencies_by_SV_category.png"))

ggsave(plot = distribution_of_odds_ratios_for_enrichment_of_collateral_genes_among_absolute_dependencies_by_SV_category, width = 10, height = 7, filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","distribution_of_odds_ratios_for_enrichment_of_collateral_genes_among_absolute_dependencies_by_SV_category.png"))

#100% stacked bar plot of all fusions and cell lines stratified by those that have partner dependencies, unique other TAD dependencies, or no clearly associated dependencies

fusions_with_partner_dependency <- distinct_fusion_dependency_pairings %>% filter(is_partner == TRUE) %>% distinct(Fusion) %>% unlist() %>% unname()

fusions_with_unique_other_tad_dependency <- setdiff(distinct_fusion_dependency_pairings %>% filter(is_partner == FALSE) %>% distinct(Fusion) %>% unlist() %>% unname(), fusions_with_partner_dependency)

fusion_with_no_associated_dependency <- setdiff(ALL_fusions_with_dependency_data,c(fusions_with_partner_dependency,fusions_with_unique_other_tad_dependency))

total_fusions_with_dependency_data <- unique(ALL_fusions_with_dependency_data)


cell_lines_with_partner_dependency <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(Fusion %in% fusions_with_partner_dependency) %>% distinct(DepMap_ID) %>% unlist() %>% unname() %>% intersect(colnames(ccle_dependency_probability_matrix))

cell_lines_with_unique_other_tad_dependency <- setdiff(ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(Fusion %in% fusions_with_unique_other_tad_dependency) %>% distinct(DepMap_ID) %>% unlist() %>% unname() %>% intersect(colnames(ccle_dependency_probability_matrix)), cell_lines_with_partner_dependency)

cell_lines_with_no_associated_dependency <- setdiff(ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% distinct(DepMap_ID) %>% unlist() %>% unname() %>% intersect(colnames(ccle_dependency_probability_matrix)),c(cell_lines_with_partner_dependency,cell_lines_with_unique_other_tad_dependency))

total_cell_lines_with_dependency_data <- c(cell_lines_with_partner_dependency,cell_lines_with_unique_other_tad_dependency,cell_lines_with_no_associated_dependency)

ALL_fusions_tibble_with_tad_dependencies_summary_3_1_20 <- tibble(Fusion_or_Cell_Lines = c("Fusions","Fusions","Fusions","Cell lines","Cell lines","Cell lines"), Dependency_Info = c("No fusion-associated\ndependency","Other TAD gene\nis dependency","Partner\nis dependency","No fusion-associated\ndependency","Other TAD gene\nis dependency","Partner\nis dependency"), Count = c(length(fusion_with_no_associated_dependency)/length(total_fusions_with_dependency_data)*100,length(fusions_with_unique_other_tad_dependency)/length(total_fusions_with_dependency_data)*100,length(fusions_with_partner_dependency)/length(total_fusions_with_dependency_data)*100,length(cell_lines_with_no_associated_dependency)/length(total_cell_lines_with_dependency_data)*100,length(cell_lines_with_unique_other_tad_dependency)/length(total_cell_lines_with_dependency_data)*100,length(cell_lines_with_partner_dependency)/length(total_cell_lines_with_dependency_data)*100))

ALL_fusions_tibble_with_tad_dependencies_summary_3_1_20 <- ALL_fusions_tibble_with_tad_dependencies_summary_3_1_20 %>% mutate(Aggregated_Dependency_Info = ifelse(Dependency_Info == "No fusion-associated\ndependency", "No fusion-associated\ndependency", "Fusion-associated\ndependency"))

ALL_fusions_tibble_with_tad_dependencies_summary_3_1_20$Dependency_Info <- factor(ALL_fusions_tibble_with_tad_dependencies_summary_3_1_20$Dependency_Info, levels = c("No fusion-associated\ndependency","Other TAD gene\nis dependency","Partner\nis dependency"))

ALL_fusions_tibble_with_tad_dependencies_summary_3_1_20$Fusion_or_Cell_Lines <- factor(ALL_fusions_tibble_with_tad_dependencies_summary_3_1_20$Fusion_or_Cell_Lines, levels = c("Fusions","Cell lines"))

ALL_fusions_tibble_with_tad_dependencies_summary_3_1_20$Aggregated_Dependency_Info <- factor(ALL_fusions_tibble_with_tad_dependencies_summary_3_1_20$Aggregated_Dependency_Info, levels = c("No fusion-associated\ndependency","Fusion-associated\ndependency"))

ALL_fusions_tibble_with_tad_dependencies_summary_plot_3_1_20 <- ggplot(ALL_fusions_tibble_with_tad_dependencies_summary_3_1_20 %>% group_by(Aggregated_Dependency_Info, Fusion_or_Cell_Lines) %>% summarise(Count = sum(Count)),aes(fill = Aggregated_Dependency_Info, x = Fusion_or_Cell_Lines, y = Count))+geom_bar(color = "black", position = "stack", stat = "identity") + labs(x = "", y = "Percentage", fill = "") + scale_fill_manual(values = c("#E6E7E8","Dark blue"))  + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text = element_text(size = 32, color = "black"), axis.title = element_text(size = 32, color = "black"), title = element_text(size = 32, color = "black"), legend.text = element_text(size = 32, color = "black"), legend.position = "right", legend.box="vertical", legend.key.height = unit(1,"inches"), legend.key.width = unit(1,"inches")) + guides(fill = guide_legend(nrow = 3)) + coord_cartesian(ylim = c(0,110))+ scale_y_continuous(breaks = c(0,20,40,60,80,100))

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","ALL_fusions_tibble_with_tad_dependencies_summary_plot_3_1_20.png"), plot = ALL_fusions_tibble_with_tad_dependencies_summary_plot_3_1_20, height = 12, width = 12)

ALL_fusions_tibble_with_tad_dependencies_summary_plot_fusions_only <- ggplot(ALL_fusions_tibble_with_tad_dependencies_summary_3_1_20 %>% filter(Fusion_or_Cell_Lines == "Fusions") %>% group_by(Aggregated_Dependency_Info, Fusion_or_Cell_Lines) %>% summarise(Count = sum(Count)),aes(fill = Aggregated_Dependency_Info, x = Fusion_or_Cell_Lines, y = Count))+geom_bar(color = "black", position = "stack", stat = "identity") + labs(x = "", y = "Percentage", fill = "") + scale_fill_manual(values = c("#E6E7E8","Dark blue"))  + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text = element_text(size = 32, color = "black"), axis.title = element_text(size = 32, color = "black"), title = element_text(size = 32, color = "black"), legend.text = element_text(size = 32, color = "black"), legend.position = "none", legend.box="vertical", legend.key.height = unit(1,"inches"), legend.key.width = unit(1,"inches")) + guides(fill = guide_legend(nrow = 3)) + coord_cartesian(ylim = c(0,110))+ scale_y_continuous(breaks = c(0,20,40,60,80,100))

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","ALL_fusions_tibble_with_tad_dependencies_summary_plot_fusions_only.png"), plot = ALL_fusions_tibble_with_tad_dependencies_summary_plot_fusions_only, height = 12, width = 4)

ALL_fusions_tibble_with_tad_dependencies_summary_plot_cell_lines_only <- ggplot(ALL_fusions_tibble_with_tad_dependencies_summary_3_1_20 %>% filter(Fusion_or_Cell_Lines == "Cell lines") %>% group_by(Aggregated_Dependency_Info, Fusion_or_Cell_Lines) %>% summarise(Count = sum(Count)),aes(fill = Aggregated_Dependency_Info, x = Fusion_or_Cell_Lines, y = Count))+geom_bar(color = "black", position = "stack", stat = "identity") + labs(x = "", y = "", fill = "") + scale_fill_manual(values = c("#E6E7E8","Dark blue"))  + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks=element_blank(), axis.text.x = element_text(size = 32, color = "black"), axis.text.y = element_blank(), axis.title = element_text(size = 32, color = "black"), title = element_text(size = 32, color = "black"), legend.text = element_text(size = 32, color = "black"), legend.position = "right", legend.box="vertical", legend.key.height = unit(1,"inches"), legend.key.width = unit(1,"inches")) + guides(fill = guide_legend(nrow = 3)) + coord_cartesian(ylim = c(0,110))+ scale_y_continuous(breaks = c(0,20,40,60,80,100))

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","ALL_fusions_tibble_with_tad_dependencies_summary_plot_cell_lines_only.png"), plot = ALL_fusions_tibble_with_tad_dependencies_summary_plot_cell_lines_only, height = 12, width = 9)

#Cell lines with dependencies

cell_lines_with_partner_dependency_by_disease <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(DepMap_ID %in% cell_lines_with_partner_dependency) %>% group_by(primary_disease) %>% summarise(partner_dependency = n_distinct(DepMap_ID))

cell_lines_with_unique_other_tad_dependency_by_disease <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(DepMap_ID %in% cell_lines_with_unique_other_tad_dependency) %>% group_by(primary_disease) %>% summarise(other_tad_dependency= n_distinct(DepMap_ID))

cell_lines_with_no_associated_dependency_by_disease <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(DepMap_ID %in% cell_lines_with_no_associated_dependency) %>% group_by(primary_disease) %>% summarise(no_dependency = n_distinct(DepMap_ID))

ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20 <- full_join(cell_lines_with_partner_dependency_by_disease,cell_lines_with_unique_other_tad_dependency_by_disease)

ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20 <- full_join(ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20,cell_lines_with_no_associated_dependency_by_disease)

ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20 <- ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20 %>% gather(key = "dependency_category", value = "count", -primary_disease)

ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20 <- ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20 %>% replace_na(list(count = 0))

ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20$dependency_category <- recode(ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20$dependency_category, partner_dependency = "Partner is dependency", other_tad_dependency = "Other TAD gene is dependency", no_dependency = "No fusion-associated dependency")
  
ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20$dependency_category <- factor(ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20$dependency_category, levels = c("No fusion-associated dependency","Other TAD gene is dependency","Partner is dependency"))

ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20 <- ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20 %>% mutate(aggregated_dependency_category = ifelse(dependency_category == "No fusion-associated dependency", "No fusion-associated dependency", "Fusion-associated dependency"))

ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20$aggregated_dependency_category <- factor(ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20$aggregated_dependency_category, levels = c("No fusion-associated dependency","Fusion-associated dependency"))

ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20 <- ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20 %>% mutate(partner_dependency = ifelse(dependency_category == "Partner is dependency","Partner dependency","No partner dependency"), collateral_dependency = ifelse(dependency_category == "Other TAD gene is dependency","Collateral dependency","No collateral dependency"))

ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20$partner_dependency <- factor(ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20$partner_dependency, levels = c("No partner dependency","Partner dependency"))

ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20$collateral_dependency <- factor(ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20$collateral_dependency, levels = c("No collateral dependency","Collateral dependency"))

ALL_fusions_tibble_with_tad_dependencies_by_disease_plot_4_27_20 <- ggplot(ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20 %>% group_by(aggregated_dependency_category, primary_disease) %>% summarise(count = sum(count)),aes(fill = aggregated_dependency_category, x = reorder(primary_disease, -count), y = count))+geom_bar(color = "black", position = "stack", stat = "identity") + labs(x = "", y = "Count", fill = "") + scale_fill_manual(values = c("#E6E7E8","Dark blue")) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 18, color = "black", angle = 90, hjust = 1, vjust = 0.5), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position = "none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","ALL_fusions_tibble_with_tad_dependencies_by_disease_plot_4_27_20.png"), plot = ALL_fusions_tibble_with_tad_dependencies_by_disease_plot_4_27_20, height = 8, width = 10)

ALL_fusions_tibble_with_tad_dependencies_by_disease_plot_partners_only <- ggplot(ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20 %>% group_by(partner_dependency, primary_disease) %>% summarise(count = sum(count)),aes(fill = partner_dependency, x = reorder(primary_disease, -count), y = count))+geom_bar(color = "black", position = "stack", stat = "identity") + labs(x = "", y = "Count", fill = "") + scale_fill_manual(values = c("#E6E7E8","#317EC2")) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 18, color = "black", angle = 90, hjust = 1, vjust = 0.5), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position = "none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","ALL_fusions_tibble_with_tad_dependencies_by_disease_plot_partners_only.png"), plot = ALL_fusions_tibble_with_tad_dependencies_by_disease_plot_partners_only, height = 8, width = 10)

ALL_fusions_tibble_with_tad_dependencies_by_disease_plot_collaterals_only <- ggplot(ALL_fusions_tibble_with_tad_dependencies_by_disease_4_27_20 %>% group_by(collateral_dependency, primary_disease) %>% summarise(count = sum(count)),aes(fill = collateral_dependency, x = reorder(primary_disease, -count), y = count))+geom_bar(color = "black", position = "stack", stat = "identity") + labs(x = "", y = "Count", fill = "") + scale_fill_manual(values = c("#E6E7E8","#B9DBF4")) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 18, color = "black", angle = 90, hjust = 1, vjust = 0.5), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position = "none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","ALL_fusions_tibble_with_tad_dependencies_by_disease_plot_collaterals_only.png"), plot = ALL_fusions_tibble_with_tad_dependencies_by_disease_plot_collaterals_only, height = 8, width = 10)

#Unique dependencies and fusion-dependency pairings
partner_dependencies <- distinct_fusion_dependency_pairings %>% filter(is_partner == TRUE) %>% distinct(Gene) %>% unlist() %>% unname()

unique_other_tad_dependencies <- setdiff(distinct_fusion_dependency_pairings %>% filter(is_partner == FALSE) %>% distinct(Gene) %>% unlist() %>% unname(), partner_dependencies)

fusion_dependency_pairings_with_partner_dependencies <- distinct_fusion_dependency_pairings %>% filter(is_partner == TRUE) %>% mutate(Fusion_Dependency_Pairing = str_c(Fusion,"-",Gene)) %>% distinct(Fusion_Dependency_Pairing) %>% unlist() %>% unname()

fusion_dependency_pairings_with_other_tad_dependencies <- setdiff(distinct_fusion_dependency_pairings %>% filter(is_partner == FALSE) %>% mutate(Fusion_Dependency_Pairing = str_c(Fusion,"-",Gene)) %>% distinct(Fusion_Dependency_Pairing) %>% unlist() %>% unname(), fusion_dependency_pairings_with_partner_dependencies)

fusion_dependency_pairings_with_partner_dependencies_duplicates_removed <- count_of_actual_fusion_dependency_pairings_conservative %>% filter(partner_or_other_TAD == "partner") %>% dplyr::select(count) %>% unlist() %>% unname()

fusion_dependency_pairings_with_other_tad_dependencies_duplicates_removed <- count_of_actual_fusion_dependency_pairings_conservative %>% filter(partner_or_other_TAD == "other_TAD") %>% dplyr::select(count) %>% unlist() %>% unname()

unique_fusion_associated_dependency_summary_3_1_20 <- tibble(summary_type = c("Dependencies", "Dependencies", "Fusion-Dependency Pairings", "Fusion-Dependency Pairings", "Fusion-Dependency Pairings (accounting for complex rearrangements)","Fusion-Dependency Pairings (accounting for complex rearrangements)"), dependency_type = c("Partner dependency", "Collateral dependency", "Partner dependency", "Collateral dependency", "Partner dependency", "Collateral dependency"), count = c(length(partner_dependencies),length(unique_other_tad_dependencies),length(fusion_dependency_pairings_with_partner_dependencies),length(fusion_dependency_pairings_with_other_tad_dependencies),fusion_dependency_pairings_with_partner_dependencies_duplicates_removed,fusion_dependency_pairings_with_other_tad_dependencies_duplicates_removed))

unique_fusion_associated_dependency_summary_3_1_20$summary_type <- factor(unique_fusion_associated_dependency_summary_3_1_20$summary_type, levels = c("Dependencies", "Fusion-Dependency Pairings", "Fusion-Dependency Pairings (accounting for complex rearrangements)"))

unique_fusion_associated_dependency_summary_plot_3_1_20 <- ggplot(unique_fusion_associated_dependency_summary_3_1_20 %>% filter(!summary_type == "Dependencies"), aes(fill = dependency_type, x = summary_type, y = count))+geom_bar(position = "stack", stat = "identity", color = "black") + labs(x = "", y = "Count", fill = "") + scale_fill_manual(labels = c("Collateral","Partner"), values = c("#B9DBF4","#317EC2")) + scale_x_discrete(labels = function(x) str_wrap(x, width = 15)) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 18, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.text = element_text(size = 20, color = "black"), legend.position = "right",legend.box="vertical", legend.margin=margin())+ guides(fill = guide_legend(nrow = 2))

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","unique_fusion_associated_dependency_summary_plot_3_1_20.png"), plot = unique_fusion_associated_dependency_summary_plot_3_1_20, height = 7, width = 6)

#Average number of high-confidence fusions per cell line by disease type
mean_fusions_per_cell_line_by_disease <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% group_by(primary_disease) %>% summarise(total_fusions = n_distinct(Fusion), total_cell_lines = n_distinct(stripped_cell_line_name)) %>% mutate(mean_fusions_per_cell_line = total_fusions/total_cell_lines)

mean_fusions_per_cell_line_by_disease_plot <- ggplot(mean_fusions_per_cell_line_by_disease,aes(fill = "", x = reorder(primary_disease, -mean_fusions_per_cell_line), y = mean_fusions_per_cell_line))+geom_bar(color = "black", position = "stack", stat = "identity") + labs(x = "", y = "Mean fusion count / cell line", fill = "") + scale_fill_manual(values = c("Dark blue")) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 18, color = "black", angle = 90, hjust = 1, vjust = 0.5), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position = "none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","mean_fusions_per_cell_line_by_disease_plot.png"), plot = mean_fusions_per_cell_line_by_disease_plot, height = 8, width = 10)

#The distributions of random sampling from null empirical distributions

random_sampling_from_null_empirical_distributions <- tibble(iteration = c(1:1000), multiple_iterations_cumulative_partner_dependencies_permuted_by_expression_quartiles = multiple_iterations_cumulative_partner_dependencies_permuted_by_expression_quartiles, multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_expression_quartiles = multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_expression_quartiles)

multiple_iterations_cumulative_partner_dependencies_plot_3_1_20 <- ggplot(random_sampling_from_null_empirical_distributions, aes(x = multiple_iterations_cumulative_partner_dependencies_permuted_by_expression_quartiles)) + geom_density(size = 1, fill = "#E6E7E8") + geom_segment(data = count_of_actual_fusion_dependency_pairings_conservative %>% filter(partner_or_other_TAD == "partner"), aes(x = count, xend = count, y = .05, yend = 0, size = 2, color = partner_or_other_TAD), arrow = arrow(length = unit(0.5,"cm"))) +scale_color_manual(values = c("#317EC2")) + labs(x = "Partner fusion-dependency pairings", y = "Density") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank(), axis.text.x = element_text(size = 24, color = "black"), axis.title = element_text(size = 24, color = "black"), title = element_text(size = 24, color = "black"), legend.position = "none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","multiple_iterations_cumulative_partner_dependencies_plot_3_1_20.png"), plot = multiple_iterations_cumulative_partner_dependencies_plot_3_1_20)

multiple_iterations_cumulative_other_TAD_dependencies_plot_3_1_20 <- ggplot(random_sampling_from_null_empirical_distributions, aes(x = multiple_iterations_cumulative_other_TAD_dependencies_permuted_by_expression_quartiles)) + geom_density(size = 1, fill = "#E6E7E8") + geom_segment(data = count_of_actual_fusion_dependency_pairings_conservative %>% filter(partner_or_other_TAD == "other_TAD"), aes(x = count, xend = count, y = .02, yend = 0, size = 2, color = partner_or_other_TAD), arrow = arrow(length = unit(0.5,"cm"))) +scale_color_manual(values = c("#B9DBF4")) + labs(x = "Collateral fusion-dependency pairings", y = "Density") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank(), axis.text.x = element_text(size = 24, color = "black"), axis.title = element_text(size = 24, color = "black"), title = element_text(size = 24, color = "black"), legend.position = "none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","multiple_iterations_cumulative_other_TAD_dependencies_plot_3_1_20.png"), plot = multiple_iterations_cumulative_other_TAD_dependencies_plot_3_1_20)

#The distributions of random sampling from null empirical distributions (phenotypic_permutation)

random_sampling_from_null_empirical_distributions_phenotypic_permutation <- tibble(iteration = c(1:1000), count_of_partner_dependencies_phenotypic_permutation = count_of_partner_dependencies_phenotypic_permutation, count_of_other_TAD_dependencies_phenotypic_permutation = count_of_other_TAD_dependencies_phenotypic_permutation)

multiple_iterations_cumulative_partner_dependencies_plot_phenotypic_permutation <- ggplot(random_sampling_from_null_empirical_distributions_phenotypic_permutation, aes(x = count_of_partner_dependencies_phenotypic_permutation)) + geom_density(size = 1, fill = "#E6E7E8") + geom_segment(data = count_of_actual_fusion_dependency_pairings_conservative %>% filter(partner_or_other_TAD == "partner"), aes(x = count, xend = count, y = .05, yend = 0, size = 2, color = partner_or_other_TAD), arrow = arrow(length = unit(0.5,"cm"))) +scale_color_manual(values = c("#317EC2")) + labs(x = "Partner fusion-dependency pairings", y = "Density") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank(), axis.text.x = element_text(size = 24, color = "black"), axis.title = element_text(size = 24, color = "black"), title = element_text(size = 24, color = "black"), legend.position = "none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","multiple_iterations_cumulative_partner_dependencies_plot_phenotypic_permutation.png"), plot = multiple_iterations_cumulative_partner_dependencies_plot_phenotypic_permutation)

multiple_iterations_cumulative_other_TAD_dependencies_plot_phenotypic_permutation <- ggplot(random_sampling_from_null_empirical_distributions_phenotypic_permutation, aes(x = count_of_other_TAD_dependencies_phenotypic_permutation)) + geom_density(size = 1, fill = "#E6E7E8") + geom_segment(data = count_of_actual_fusion_dependency_pairings_conservative %>% filter(partner_or_other_TAD == "other_TAD"), aes(x = count, xend = count, y = .015, yend = 0, size = 2, color = partner_or_other_TAD), arrow = arrow(length = unit(0.5,"cm"))) +scale_color_manual(values = c("#B9DBF4")) + labs(x = "Collateral fusion-dependency pairings", y = "Density") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank(), axis.text.x = element_text(size = 24, color = "black"), axis.title = element_text(size = 24, color = "black"), title = element_text(size = 24, color = "black"), legend.position = "none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","multiple_iterations_cumulative_other_TAD_dependencies_plot_phenotypic_permutation.png"), plot = multiple_iterations_cumulative_other_TAD_dependencies_plot_phenotypic_permutation)

#Overlap of results from genome-scale approach to identifying fusion-dependency pairings with fusion-associated dependency t-statistic analysis
venn.diagram(x = list(fusion_associated_dependencies_with_FDRs_TSTATS$Fusion_Dependency_Pairing,fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.05_duplicates_removed$Fusion_Dependency_Pairing), category.names = c("Fusion-dependency pairings based on\ngenome-scale t-tests with BH correction (FDR < .05)","Fusion-dependency pairings based on\npartner TAD gene t-tests only with permutation-based\ncorrection of t-statistics (FDR < .05)"), filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","fusion_dependency_pairing_for_different_methods_of_FDR_permutation_FDR_point05_venn_diagram_6_22_20.png"), output = TRUE, height = 8, width = 12, units = "in", main = "", fill = c("Dark Blue", "#080808"), alpha = .5, main.cex = 4, main.fontfamily = "sans", cex = 0, fontface = "bold", fontfamily = "sans", cat.dist = c(0.05, 0.05), cat.just = list(c(1,-13),c(0,-10)), cat.default.pos = "outer", cat.cex = 0, cat.fontface = "bold", cat.fontfamily = "sans")

venn.diagram(x = list(fusion_associated_dependencies_with_FDRs_TSTATS$Fusion_Dependency_Pairing,fusion_associated_dependency_TSTAT_FDR_NA_removed_FDR_0.1_duplicates_removed$Fusion_Dependency_Pairing), category.names = c("Fusion-dependency pairings based on\ngenome-scale t-tests with BH correction (FDR < .05)","Fusion-dependency pairings based on\npartner TAD gene t-tests only with permutation-based\ncorrection of t-statistics (FDR < .1)"), filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","fusion_dependency_pairing_for_different_methods_of_FDR_permutation_FDR_point1_venn_diagram_6_22_20.png"), output = TRUE, height = 8, width = 12, units = "in", main = "", fill = c("Dark Blue", "#080808"), alpha = .5, main.cex = 4, main.fontfamily = "sans", cex = 0, fontface = "bold", fontfamily = "sans", cat.dist = c(0.05, 0.05), cat.just = list(c(1,-14),c(0,-10)), cat.default.pos = "outer", cat.cex = 0, cat.fontface = "bold", cat.fontfamily = "sans", ext.line.lwd	= 0)

#FDR approach comparison scatterplot

FDR_approach_comparison_scatter_plot <- ggplot(data = fusion_dependency_pairings_with_FDRs_from_both_approaches %>% filter(dependency_probability_difference > 0), aes(x = genome_scale_negative_log10_BH_QValue,y=cell_line_permutation_negative_log10_QValue))+geom_point(color = "#B5B3B3")+ geom_point(data=fusion_dependency_pairings_with_FDRs_from_both_approaches %>% filter(dependency_probability_difference > 0 & genome_scale_negative_log10_BH_QValue > -log10(.05) & cell_line_permutation_negative_log10_QValue > -log10(.05)), aes(x = genome_scale_negative_log10_BH_QValue, y = cell_line_permutation_negative_log10_QValue), color = "black")+geom_label_repel(data=fusion_dependency_pairings_with_FDRs_from_both_approaches %>% filter(Fusion_Dependency_Pairing %in% c("BCR-ABL1_ABL1", "IGH-NSD2_FGFR3", "PAFAH1B2-FOXR1_FOXR1", "THADA-MTA3_EML4", "TMPRSS2-ERG_ERG")), aes(label = c("BCR-ABL1, ABL1", "IGH-NSD2, FGFR3", "PAFAH1B2-FOXR1, FOXR1", "THADA-MTA3, EML4", "TMPRSS2-ERG, ERG")), label.size = NA, size = 4, fontface = "bold.italic", box.padding = 1, nudge_x = 4, segment.color = "Red") + labs(title = "Comparison of -log10 FDR values for partner and collateral\nfusion-gene pairings", x = "FDR derived from genome-\nscale t-tests with BH correction", y = "FDR derived from t-statistics\nand cell line permutation")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_text(size = 18, color = "black"), axis.text.x = element_text(size = 18, color = "black"), axis.title = element_text(size = 18, color = "black"), title = element_text(size = 18, color = "black"), legend.position="none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","FDR_approach_comparison_scatter_plot.png"), plot = FDR_approach_comparison_scatter_plot, height = 6, width = 9)

#Distribution of Hotspot drivers in cell lines

hotspot_drivers_in_cell_lines <- full_join(other_driver_count_by_cell_line %>% mutate(cell_line_with_FAD = TRUE),other_driver_count_by_cell_line_for_other_fusion_contexts %>% mutate(cell_line_with_FAD = FALSE))

hotspot_drivers_in_cell_lines$cell_line_with_FAD <- factor(hotspot_drivers_in_cell_lines$cell_line_with_FAD, levels = c(TRUE,FALSE))

ttest_comparisons_cell_lines_with_FAD_vs_those_without <- list(c(TRUE, FALSE))

hotspot_drivers_in_cell_lines_plot <- ggplot(data = hotspot_drivers_in_cell_lines, aes(x=cell_line_with_FAD,y=other_driver_count,color=cell_line_with_FAD)) + geom_violin(size = 1) + scale_color_manual(values = c("Red","Black"))+ stat_summary(fun.y=mean, geom="point", size=2, color=c("Red","Black")) + labs(title = "Distribution of hotspot mutation counts across cell lines", x = "", y = "")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none") + scale_x_discrete(labels = c("Cell lines with fusion-\nassociated dependencies","Cell lines without fusion-\nassociated dependencies"))

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","hotspot_drivers_in_cell_lines_plot.png"),plot = hotspot_drivers_in_cell_lines_plot, height = 7, width = 12)

#Generating dependency and expression volcano plots for fusions with associated dependencies
counter = 0

for(fusion in unique(distinct_fusion_dependency_pairings$Fusion)){

ggplot(dependency_probability_fusion_with_vs_without_stats[[fusion]], aes(x = dependency_probability_difference, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 0.5, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -0.5, color = "blue", linetype = "dashed", size = 1)  + geom_point(data=dependency_probability_fusion_with_vs_without_stats[[fusion]] %>% filter(dependency_probability_difference > 0.5 & negative_log10_BH_QValue > -log10(.05)), aes(x = dependency_probability_difference, y = negative_log10_BH_QValue), color = "black") + geom_label_repel(data=dependency_probability_fusion_with_vs_without_stats[[fusion]] %>% filter(gene %in% c(all_unique_coding_TAD_neighbors_with_dependency_data[[fusion]], fusion_partners[[fusion]]) & dependency_probability_difference > 0.5 & negative_log10_BH_QValue > -log10(.05)), aes(label = gene), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 2) + geom_point(data=dependency_probability_fusion_with_vs_without_stats[[fusion]] %>% filter(gene %in% c(all_unique_coding_TAD_neighbors_with_dependency_data[[fusion]], fusion_partners[[fusion]]) & dependency_probability_difference > 0.5 & negative_log10_BH_QValue > -log10(.05)), aes(x = dependency_probability_difference, y = negative_log10_BH_QValue), color = "red", size = 3) + labs(x = 'Difference in dependency probability', y = expression(-log[10](Q~value)), title = str_c("Fusion: ", fusion)) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(),  axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), plot.subtitle = element_text(size = 20, color = "black"), legend.position="none") + xlim(-1,1)
  
ggsave(filename = here::here("results/fusion_dependency_probability_plots_for_associated_dependencies",str_c(fusion,".png")))

ggplot(expression_fusion_with_vs_without_stats[[fusion]], aes(x = log2_fold_change, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 1, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -1, color = "blue", linetype = "dashed", size = 1)  + geom_point(data=expression_fusion_with_vs_without_stats[[fusion]] %>% filter(log2_fold_change > 1 & negative_log10_BH_QValue > -log10(.05)), aes(x = log2_fold_change, y = negative_log10_BH_QValue), color = "black") + geom_label_repel(data=expression_fusion_with_vs_without_stats[[fusion]] %>% filter(gene %in% c(all_unique_coding_TAD_neighbors_with_dependency_data[[fusion]], fusion_partners[[fusion]]) & log2_fold_change > 1 & negative_log10_BH_QValue > -log10(.05)), aes(label = gene), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 2) + geom_point(data=expression_fusion_with_vs_without_stats[[fusion]] %>% filter(gene %in% c(all_unique_coding_TAD_neighbors_with_dependency_data[[fusion]], fusion_partners[[fusion]]) & log2_fold_change > 1 & negative_log10_BH_QValue > -log10(.05)), aes(x = log2_fold_change, y = negative_log10_BH_QValue), color = "red", size = 3) + labs(x = 'Log2 Fold Change in TPM', y = expression(-log[10](Q~value)), title = "Pan-cancer differential expression:", subtitle = fusion) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), plot.subtitle = element_text(size = 20, color = "black"), legend.position="none") 

ggsave(filename = here::here("results/fusion_RNA_expression_plots_for_associated_dependencies",str_c(fusion,".png")))

counter = counter + 1
print(counter)

}

#Specific dependency examples

#EWSR1-ERG
ggplot(dependency_probability_fusion_with_vs_without_stats[["EWSR1-ERG"]], aes(x = dependency_probability_difference, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 0.5, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -0.5, color = "blue", linetype = "dashed", size = 1) + geom_point(data=dependency_probability_fusion_with_vs_without_stats[["EWSR1-ERG"]] %>% filter(dependency_probability_difference > 0.5 & negative_log10_BH_QValue > -log10(.05)), aes(x = dependency_probability_difference, y = negative_log10_BH_QValue), color = "black") + geom_label_repel(data=dependency_probability_fusion_with_vs_without_stats[["EWSR1-ERG"]] %>% filter(gene %in% fusion_partners[["EWSR1-ERG"]]), aes(label = gene), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 2) + labs(x = 'Difference in dependency probability', y = expression(-log[10](Q~value)), title = "Fusion: EWSR1-ERG") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none") + xlim(-1,1)

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","EWSR1-ERG_dependency.png"))

#EWSR1-FLI1
ggplot(dependency_probability_fusion_with_vs_without_stats[["EWSR1-FLI1"]], aes(x = dependency_probability_difference, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 0.5, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -0.5, color = "blue", linetype = "dashed", size = 1) + geom_point(data=dependency_probability_fusion_with_vs_without_stats[["EWSR1-FLI1"]] %>% filter(dependency_probability_difference > 0.5 & negative_log10_BH_QValue > -log10(.05)), aes(x = dependency_probability_difference, y = negative_log10_BH_QValue), color = "black") + geom_label_repel(data=dependency_probability_fusion_with_vs_without_stats[["EWSR1-FLI1"]] %>% filter(gene %in% fusion_partners[["EWSR1-FLI1"]]), aes(label = gene), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 2) + geom_point(data=dependency_probability_fusion_with_vs_without_stats[["EWSR1-FLI1"]] %>% filter(gene == "FLI1"), aes(x = dependency_probability_difference, y = negative_log10_BH_QValue), color = "red", size = 3)  + labs(x = 'Difference in dependency probability', y = expression(-log[10](Q~value)), title = "Fusion: EWSR1-FLI1") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none") + xlim(-1,1)

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","EWSR1-FLI1_dependency.png"))

#IGH-NSD2
ggplot(dependency_probability_fusion_with_vs_without_stats[["IGH-NSD2"]], aes(x = dependency_probability_difference, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 0.5, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -0.5, color = "blue", linetype = "dashed", size = 1) + geom_point(data=dependency_probability_fusion_with_vs_without_stats[["IGH-NSD2"]] %>% filter(dependency_probability_difference > 0.5 & negative_log10_BH_QValue > -log10(.05)), aes(x = dependency_probability_difference, y = negative_log10_BH_QValue), color = "black") + geom_label_repel(data=dependency_probability_fusion_with_vs_without_stats[["IGH-NSD2"]] %>% filter(gene %in% c("NSD2","FGFR3")), aes(label = gene), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 2) + geom_point(data=dependency_probability_fusion_with_vs_without_stats[["IGH-NSD2"]] %>% filter(gene == "FGFR3"), aes(x = dependency_probability_difference, y = negative_log10_BH_QValue), color = "red", size = 3)  + labs(x = 'Difference in dependency probability', y = expression(-log[10](Q~value)), title = "Fusion: IGH-NSD2") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none") + xlim(-1,1)

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","IGH-NSD2_dependency.png"))

#BCR-ABL1
ggplot(dependency_probability_fusion_with_vs_without_stats[["BCR-ABL1"]], aes(x = dependency_probability_difference, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 0.5, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -0.5, color = "blue", linetype = "dashed", size = 1) + geom_point(data=dependency_probability_fusion_with_vs_without_stats[["BCR-ABL1"]] %>% filter(dependency_probability_difference > 0.5 & negative_log10_BH_QValue > -log10(.05)), aes(x = dependency_probability_difference, y = negative_log10_BH_QValue), color = "black") + geom_label_repel(data=dependency_probability_fusion_with_vs_without_stats[["BCR-ABL1"]] %>% filter(gene %in% fusion_partners[["BCR-ABL1"]]), aes(label = gene), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 2) + geom_point(data=dependency_probability_fusion_with_vs_without_stats[["BCR-ABL1"]] %>% filter(gene %in% fusion_partners[["BCR-ABL1"]]), aes(x = dependency_probability_difference, y = negative_log10_BH_QValue), color = "red", size = 3) + labs(x = 'Difference in dependency probability', y = expression(-log[10](Q~value)), title = "Fusion: BCR-ABL1") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none") + xlim(-1,1)

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","BCR-ABL1_dependency.png"))

#Generic mock example
ggplot(dependency_probability_fusion_with_vs_without_stats[["TMPRSS2-ERG"]], aes(x = dependency_probability_difference, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3", size = 3) + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 0.5, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -0.5, color = "blue", linetype = "dashed", size = 1) + geom_point(data=dependency_probability_fusion_with_vs_without_stats[["TMPRSS2-ERG"]] %>% filter(dependency_probability_difference > 0.5 & negative_log10_BH_QValue > -log10(.05)), aes(x = dependency_probability_difference, y = negative_log10_BH_QValue), color = "black", size = 3) + geom_point(data=dependency_probability_fusion_with_vs_without_stats[["TMPRSS2-ERG"]] %>% filter(gene == "ERG"), aes(x = dependency_probability_difference, y = negative_log10_BH_QValue), color = "red", size = 7) + labs(x = 'Difference in dependency probability', y = expression(-log[10](Q~value)), title = str_c("Dependency space for\nspecific fusion")) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 24, color = "black"), axis.text.x = element_text(size = 24, color = "black"), axis.title = element_text(size = 24, color = "black"), title = element_text(size = 24, color = "black"), legend.position="none") + xlim(-1,1)

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","mock_dependency.png"))

#TPM3-NTRK1
ggplot(dependency_probability_fusion_with_vs_without_stats[["TPM3-NTRK1"]], aes(x = dependency_probability_difference, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 0.5, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -0.5, color = "blue", linetype = "dashed", size = 1) + geom_point(data=dependency_probability_fusion_with_vs_without_stats[["TPM3-NTRK1"]] %>% filter(dependency_probability_difference > 0.5 & negative_log10_BH_QValue > -log10(.05)), aes(x = dependency_probability_difference, y = negative_log10_BH_QValue), color = "black") + geom_label_repel(data=dependency_probability_fusion_with_vs_without_stats[["TPM3-NTRK1"]] %>% filter(gene %in% fusion_partners[["TPM3-NTRK1"]]), aes(label = gene), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 2) + labs(x = 'Difference in dependency probability', y = expression(-log[10](Q~value)), title = "Fusion: TPM3-NTRK1") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none") + xlim(-1,1)

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","TPM3-NTRK1_dependency.png"))

#TCF3-PBX1
ggplot(dependency_probability_fusion_with_vs_without_stats[["TCF3-PBX1"]], aes(x = dependency_probability_difference, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 0.5, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -0.5, color = "blue", linetype = "dashed", size = 1) + geom_point(data=dependency_probability_fusion_with_vs_without_stats[["TCF3-PBX1"]] %>% filter(dependency_probability_difference > 0.5 & negative_log10_BH_QValue > -log10(.05)), aes(x = dependency_probability_difference, y = negative_log10_BH_QValue), color = "black") + geom_label_repel(data=dependency_probability_fusion_with_vs_without_stats[["TCF3-PBX1"]] %>% filter(gene %in% fusion_partners[["TCF3-PBX1"]]), aes(label = gene), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 2) + labs(x = 'Difference in dependency probability', y = expression(-log[10](Q~value)), title = "Fusion: TCF3-PBX1") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none") + xlim(-1,1)

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","TCF3-PBX1_dependency.png"))

#Specific expression examples

#BCR-ABL1
ggplot(expression_fusion_with_vs_without_stats[["BCR-ABL1"]], aes(x = log2_fold_change, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 1, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -1, color = "blue", linetype = "dashed", size = 1) + geom_point(data=expression_fusion_with_vs_without_stats[["BCR-ABL1"]] %>% filter(log2_fold_change > 1 & negative_log10_BH_QValue > -log10(.05)), aes(x = log2_fold_change, y = negative_log10_BH_QValue), color = "black") + geom_label_repel(data=expression_fusion_with_vs_without_stats[["BCR-ABL1"]] %>% filter(gene %in% fusion_partners[["BCR-ABL1"]]), aes(label = gene), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 2, nudge_x = -2) + labs(x = 'Log2 Fold Change in TPM', y = expression(-log[10](Q~value)), title = "Pan-cancer differential expression:", subtitle = "BCR-ABL1") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), plot.subtitle = element_text(size = 20, color = "black"), legend.position="none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","BCR-ABL1_expression.png"))

#KMT2A-AFDN
ggplot(expression_fusion_with_vs_without_stats[["KMT2A-AFDN"]], aes(x = log2_fold_change, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 1, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -1, color = "blue", linetype = "dashed", size = 1) + geom_point(data=expression_fusion_with_vs_without_stats[["KMT2A-AFDN"]] %>% filter(log2_fold_change > 1 & negative_log10_BH_QValue > -log10(.05)), aes(x = log2_fold_change, y = negative_log10_BH_QValue), color = "black") + geom_label_repel(data=expression_fusion_with_vs_without_stats[["KMT2A-AFDN"]] %>% filter(gene %in% fusion_partners[["KMT2A-AFDN"]]), aes(label = gene), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 2, nudge_x = -2) + labs(x = 'Log2 Fold Change in TPM', y = expression(-log[10](Q~value)), title = "Pan-cancer differential expression:", subtitle = "KMT2A-AFDN") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), plot.subtitle = element_text(size = 20, color = "black"), legend.position="none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","KMT2A-AFDN_expression.png"))

#KMT2A-AFF1
ggplot(expression_fusion_with_vs_without_stats[["KMT2A-AFF1"]], aes(x = log2_fold_change, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 1, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -1, color = "blue", linetype = "dashed", size = 1) + geom_point(data=expression_fusion_with_vs_without_stats[["KMT2A-AFF1"]] %>% filter(log2_fold_change > 1 & negative_log10_BH_QValue > -log10(.05)), aes(x = log2_fold_change, y = negative_log10_BH_QValue), color = "black") + geom_label_repel(data=expression_fusion_with_vs_without_stats[["KMT2A-AFF1"]] %>% filter(gene %in% fusion_partners[["KMT2A-AFF1"]]), aes(label = gene), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 2, nudge_x = -2) + labs(x = 'Log2 Fold Change in TPM', y = expression(-log[10](Q~value)), title = "Pan-cancer differential expression:", subtitle = "KMT2A-AFF1") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), plot.subtitle = element_text(size = 20, color = "black"), legend.position="none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","KMT2A-AFF1_expression.png"))

#KMT2A-MLLT3
ggplot(expression_fusion_with_vs_without_stats[["KMT2A-MLLT3"]], aes(x = log2_fold_change, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 1, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -1, color = "blue", linetype = "dashed", size = 1) + geom_point(data=expression_fusion_with_vs_without_stats[["KMT2A-MLLT3"]] %>% filter(log2_fold_change > 1 & negative_log10_BH_QValue > -log10(.05)), aes(x = log2_fold_change, y = negative_log10_BH_QValue), color = "black") + geom_label_repel(data=expression_fusion_with_vs_without_stats[["KMT2A-MLLT3"]] %>% filter(gene %in% fusion_partners[["KMT2A-MLLT3"]]), aes(label = gene), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 2, nudge_x = -2) + labs(x = 'Log2 Fold Change in TPM', y = expression(-log[10](Q~value)), title = "Pan-cancer differential expression:", subtitle = "KMT2A-MLLT3") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), plot.subtitle = element_text(size = 20, color = "black"), legend.position="none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","KMT2A-MLLT3_expression.png"))

#Supporting WGS data for fusions

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary_plot_3_1_20 <- ggplot(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary %>% group_by(evidence_of_SV_in_WGS_data_aggregated) %>% summarise(percentage = sum(percentage)), aes(fill = evidence_of_SV_in_WGS_data_aggregated, x = NA, y = percentage))+geom_bar(position = "stack", stat = "identity", color = "black") + labs(x = "", y = "Percentage", fill = "") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_blank(), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_blank(), axis.text.x = element_blank(), axis.title = element_blank(), title = element_text(size = 24, color = "black"), legend.text = element_text(size = 24, color = "black"), legend.position="none", legend.box="vertical", legend.margin=margin()) + scale_fill_manual(values = c("#E6E7E8","Light green","Dark green")) + guides(fill = guide_legend(nrow = 5))

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary_plot_3_1_20.png"), plot = list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_combined_summary_plot_3_1_20, height = 7, width = 2)

#Comparison of supporting WGS data between fusions with dependencies and fusions without dependencies

comparison_of_supporting_WGS_data_for_fusions_with_and_without_associate_dependencies <- ggplot(all_fusions_with_orthogonal_WGS_data_combined_aggregated %>% group_by(fusions_with_associated_dependency,evidence_of_SV_in_WGS_data_aggregated) %>% summarise(percentage = sum(percentage)), aes(fill = evidence_of_SV_in_WGS_data_aggregated, x = fusions_with_associated_dependency, y = percentage))+geom_bar(position = "stack", stat = "identity", color = "black") + labs(title = "Proportion of fusions with\nsupporting WGS evidence",x = "", y = "Percentage", fill = "") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 18, color = "black"), axis.text.x = element_text(size = 18, color = "black", angle = 0, hjust = 0.5, vjust = 0.5), axis.title = element_blank(), title = element_text(size = 18, color = "black"), legend.text = element_text(size = 18, color = "black"), legend.position="right", legend.box="vertical", legend.margin=margin()) + scale_fill_manual(values = c("#E6E7E8","Light green","Dark green")) + guides(fill = guide_legend(nrow = 5)) + coord_cartesian(ylim = c(0,110))+ scale_y_continuous(breaks = c(0,20,40,60,80,100))

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","comparison_of_supporting_WGS_data_for_fusions_with_and_without_associate_dependencies.png"), plot = comparison_of_supporting_WGS_data_for_fusions_with_and_without_associate_dependencies, height = 7, width = 7)

#Number of SVs that don't involve one of the fusion partners that are detected with WGS in the same TAD as a fusion partner

list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all_summarized_by_SV_count_groupings$SV_in_same_TAD_group <- factor(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all_summarized_by_SV_count_groupings$SV_in_same_TAD_group, levels = c("0","1-5","6-10",">10"))

bar_plot_of_SVs_in_same_TAD_as_fusions_with_associated_dependencies <- ggplot(list_of_fusions_with_related_dependencies_and_associated_cell_lines_with_orthogonal_WGS_data_annotated_with_TADs_all_summarized_by_SV_count_groupings,aes(fill = "", x = SV_in_same_TAD_group, y = count))+geom_bar(color = "black", position = "stack", stat = "identity") + labs(title = "Distribution of fusions\namong SV categories", x = "Number of same TAD SVs as fusion\n(not involving fusion partner)", y = "", fill = "") + scale_fill_manual(values = c("Dark blue")) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 18, color = "black", angle = 0, hjust = 1, vjust = 0.5), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position = "none")

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","bar_plot_of_SVs_in_same_TAD_as_fusions_with_associated_dependencies.png"), plot = bar_plot_of_SVs_in_same_TAD_as_fusions_with_associated_dependencies)

#Evidence for fusions or partners in TCGA dataset
summary_of_tcga_samples_fusions_with_tcga_disease_rep <- summary_of_tcga_samples_fusions_with_tcga_disease_rep %>% gather(key = "fusion_or_partner", value = "percent", 2:3)

summary_of_tcga_samples_fusions_with_tcga_disease_rep$fusion_or_partner <- summary_of_tcga_samples_fusions_with_tcga_disease_rep$fusion_or_partner %>% recode(fusion_percent = "Exact\nfusion", partner_percent = "One\nfusion\npartner")

summary_of_tcga_samples_fusions_with_tcga_disease_rep$frequency <- factor(summary_of_tcga_samples_fusions_with_tcga_disease_rep$frequency, levels = c("0","1","2 - 5","5+"))

summary_of_tcga_samples_fusions_with_tcga_disease_rep <- summary_of_tcga_samples_fusions_with_tcga_disease_rep %>% mutate(aggregated_frequency = ifelse(frequency == "0","0",ifelse(frequency == "5+","5+","1 - 5")))

summary_of_tcga_samples_fusions_with_tcga_disease_rep$aggregated_frequency <- factor(summary_of_tcga_samples_fusions_with_tcga_disease_rep$aggregated_frequency, levels = c("0","1 - 5","5+"))

summary_of_tcga_samples_plot <- ggplot(summary_of_tcga_samples_fusions_with_tcga_disease_rep %>% group_by(aggregated_frequency,fusion_or_partner) %>% summarise(percent = sum(percent)), aes(fill = aggregated_frequency, x = fusion_or_partner, y = percent))+geom_bar(position = "stack", stat = "identity", color = "black") + labs(fill = "Count in TCGA", x = "", y = "Percentage", fill = "") + scale_fill_brewer(palette = "Greens") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), legend.title = element_text(size = 20, color = "black"), legend.text = element_text(size = 20, color = "black"), legend.position="right", legend.box="vertical", legend.margin=margin()) + scale_fill_manual(values = c("#E6E7E8","Light green","Dark green")) + coord_cartesian(ylim = c(0,100))+ scale_y_continuous(breaks = c(0,20,40,60,80,100))

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","summary_of_tcga_samples_plot.png"), plot = summary_of_tcga_samples_plot, height = 7, width = 6)

#Venn diagrams of partner-gene pairings that are dependencies and those that are overexpressed

fusion_overexpression_pairings_with_partners <- TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed %>% filter(is_partner == TRUE) %>% mutate(Fusion_Overexpression_Pairing = str_c(Fusion,"-",Gene)) %>% distinct(Fusion_Overexpression_Pairing) %>% unlist() %>% unname()

fusion_overexpression_pairings_with_other_tad_genes <- setdiff(TAD_signficant_expression_fusions_and_cell_lines_ALL_with_boundaries_duplicates_removed %>% filter(is_partner == FALSE) %>% mutate(Fusion_Overexpression_Pairing = str_c(Fusion,"-",Gene)) %>% distinct(Fusion_Overexpression_Pairing) %>% unlist() %>% unname(), fusion_overexpression_pairings_with_partners)

venn.diagram(x = list(fusion_dependency_pairings_with_partner_dependencies,fusion_overexpression_pairings_with_partners), category.names = c("",""), filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","partner_dependencies_and_overexpressed_genes_venn_diagram_3_1_20.png"), output = TRUE, height = 2, width = 3, units = "in", main = "", fill = c("#317EC2", "#080808"), alpha = .5, main.cex = 4, main.fontfamily = "arial", cex = 0, fontface = "bold", fontfamily = "sans", cat.pos = 0, cat.default.pos = "outer", cat.cex = 1, cat.fontface = "bold", cat.fontfamily = "arial")

venn.diagram(x = list(fusion_dependency_pairings_with_other_tad_dependencies,fusion_overexpression_pairings_with_other_tad_genes), category.names = c("",""), filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","other_TAD_dependencies_and_overexpressed_genes_venn_diagram_3_1_20.png"), output = TRUE, height = 2, width = 3, units = "in", main = "", fill = c("#B9DBF4", "#080808"), alpha = .5, main.cex = 4,  main.fontfamily = "arial", cex = 0, ext.dist = -0.5, ext.line.lwd	= 0, fontface = "bold", fontfamily = "sans", cat.pos = 0, cat.default.pos = "outer", cat.cex = 1, cat.fontface = "bold", cat.fontfamily = "sans")

#Summary copy number data
copy_number_alterations_involving_fusion_associated_dependencies_summary$loss_gain_neutral <- recode(copy_number_alterations_involving_fusion_associated_dependencies_summary$loss_gain_neutral, `no data` = "No data", neutral = "Neutral", loss = "Loss", gain = "Gain")

copy_number_alterations_involving_fusion_associated_dependencies_summary$loss_gain_neutral <- factor(copy_number_alterations_involving_fusion_associated_dependencies_summary$loss_gain_neutral, levels = c("No data","Neutral","Loss","Gain"))

copy_number_alterations_involving_fusion_associated_dependencies_summary$dependency_type <- factor(copy_number_alterations_involving_fusion_associated_dependencies_summary$dependency_type, levels = c("Partner\ndependency","Collateral\ndependency"))

copy_number_alterations_involving_fusion_associated_dependencies_summary_plot_3_4_20 <- ggplot(copy_number_alterations_involving_fusion_associated_dependencies_summary %>% filter(!loss_gain_neutral == "No data"), aes(fill = loss_gain_neutral, x = dependency_type, y = count))+geom_bar(color = "black", position = "stack", stat = "identity") + labs(title = "Count of fusion-dependency-cell\ncontexts with copy number\nalterations affecting dependency", x = "", y = "Count", fill = "Copy number alteration") + scale_fill_manual(values = c("#E6E7E8", "Red", "Dark Blue")) + scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.text = element_text(size = 20, color = "black"), legend.position="right", legend.box="vertical", legend.margin=margin(), legend.title = element_blank())

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","copy_number_alterations_involving_fusion_associated_dependencies_summary_plot_3_4_20.png"), plot = copy_number_alterations_involving_fusion_associated_dependencies_summary_plot_3_4_20, height = 8, width = 6)

#Summary mutation data

mutations_involving_fusion_associated_dependencies_summary <- mutations_involving_fusion_associated_dependencies_summary %>% mutate(mutation_in_dependency = ifelse(variant_in_dependency == TRUE, "Mutation", "No mutation"))

mutations_involving_fusion_associated_dependencies_summary$mutation_in_dependency <- factor(mutations_involving_fusion_associated_dependencies_summary$mutation_in_dependency, levels = c("No mutation", "Mutation"))

mutations_involving_fusion_associated_dependencies_summary$dependency_type <- factor(mutations_involving_fusion_associated_dependencies_summary$dependency_type, levels = c("Partner\ndependency","Collateral\ndependency"))

mutations_involving_fusion_associated_dependencies_summary <- mutations_involving_fusion_associated_dependencies_summary %>% remove_missing()

mutations_involving_fusion_associated_dependencies_summary_plot_3_4_20 <- ggplot(mutations_involving_fusion_associated_dependencies_summary, aes(fill = mutation_in_dependency, x = dependency_type, y = count))+geom_bar(color = "black", position = "stack", stat = "identity") + labs(title = "Count of fusion-dependency-cell\ncontexts with mutations\naffecting dependency", x = "", y = "Count", fill = "Mutation in dependency?") + scale_fill_manual(labels = c("None","Mutation"), values = c("#E6E7E8","Dark Blue"))  + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.text = element_text(size = 20, color = "black"), legend.position="right", legend.box="vertical", legend.margin=margin(), legend.title = element_blank())

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","mutations_involving_fusion_associated_dependencies_summary_plot_3_4_20.png"), plot = mutations_involving_fusion_associated_dependencies_summary_plot_3_4_20, height = 8, width = 6)

#Pie chart of proportion of Cosmic fusions with dependency data that have an associated dependency

cosmic_fusions_duplicates_marked <- ALL_fusions_protein_coding_filtered_list_final_with_dependency_data %>% filter(DepMap_ID %in% colnames(ccle_dependency_probability_matrix) & Cosmic == TRUE) %>% distinct(Fusion) %>% mutate(Inverse_Fusion = str_c(str_split_fixed(Fusion,"-",2)[,2],"-",str_c(str_split_fixed(Fusion,"-",2)[,1]))) %>% mutate(duplicate = Inverse_Fusion %in% cosmic_fusions_duplicates_marked$Fusion)

cosmic_fusions_duplicates_removed <- cosmic_fusions_duplicates_marked %>% filter(!Fusion %in% c("PRKCE-MBOAT2","ABL1-BCR","AFF1-KMT2A","RARA-PML"))

cosmic_fusions_with_associated_dependencies_duplicates_marked <- RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% filter(cosmic_fusion == TRUE) %>% distinct(fusion) %>% mutate(inverse_fusion = str_c(str_split_fixed(fusion,"-",2)[,2],"-",str_c(str_split_fixed(fusion,"-",2)[,1]))) %>% mutate(duplicate = inverse_fusion %in% cosmic_fusions_with_associated_dependencies_duplicates_marked$fusion)

RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% filter(cosmic_fusion == TRUE & is_partner == TRUE) %>% summarise(n_distinct(fusion)) %>% view()

RNA_expression_copy_number_and_mutation_data_by_dependency_fusion_and_cell_line %>% filter(cosmic_fusion == TRUE & is_partner == FALSE) %>% summarise(n_distinct(fusion)) %>% view()

pie_chart_proportion_of_cosmic_fusions_with_associated_dependency <- pie(x = c(19,1,15), labels = NA, clockwise = FALSE, col = c("#317EC2","#B9DBF4", "#E6E7E8"))

#Bar plots of COSMIC census genes and kinases
percentage_of_fusion_where_associated_dependency_is_cosmic_census_gene <- ggplot(fusion_dependency_co_descriptor_plot_cosmic_annotation_summary, aes(x = cosmic_fusion, y = dependency_cosmic_census_gene_percent))+geom_bar(color = "black", fill = "dark blue", stat = "identity") + labs(title = "% of fusions with dependency\nas COSMIC cancer census gene", x = "", y = "") + scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position = "none") + scale_y_continuous(limits = c(0,100), breaks = c(0,20,40,60,80,100))

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","percentage_of_fusion_where_associated_dependency_is_cosmic_census_gene.png") , plot = percentage_of_fusion_where_associated_dependency_is_cosmic_census_gene, height = 8, width = 6)

percentage_of_fusion_where_associated_dependency_is_kinase <- ggplot(fusion_dependency_co_descriptor_plot_cosmic_annotation_summary, aes(x = cosmic_fusion, y = dependency_kinase_percent))+geom_bar(color = "black", fill = "dark blue", stat = "identity") + labs(title = "% of fusions with dependency\nas kinase gene", x = "", y = "") + scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position = "none") + scale_y_continuous(limits = c(0,25), breaks = c(0,5,10,15,20,25))

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","percentage_of_fusion_where_associated_dependency_is_kinase.png") , plot = percentage_of_fusion_where_associated_dependency_is_kinase, height = 8, width = 6)

percentage_of_fusion_where_fusion_partner_is_cosmic_census_gene <- ggplot(fusion_dependency_co_descriptor_plot_cosmic_annotation_summary, aes(x = cosmic_fusion, y = fusion_partner_cosmic_census_gene_percent))+geom_bar(color = "black", fill = "dark blue", stat = "identity") + labs(title = "% of fusions with partner\nas COSMIC cancer census gene", x = "", y = "") + scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position = "none") + scale_y_continuous(limits = c(0,100), breaks = c(0,20,40,60,80,100))

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","percentage_of_fusion_where_fusion_partner_is_cosmic_census_gene.png") , plot = percentage_of_fusion_where_fusion_partner_is_cosmic_census_gene, height = 8, width = 6)

percentage_of_fusion_where_fusion_partner_is_kinase <- ggplot(fusion_dependency_co_descriptor_plot_cosmic_annotation_summary, aes(x = cosmic_fusion, y = fusion_partner_kinase_percent))+geom_bar(color = "black", fill = "dark blue", stat = "identity") + labs(title = "% of fusions with partner\nas kinase gene", x = "", y = "") + scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position = "none") + scale_y_continuous(limits = c(0,25), breaks = c(0,5,10,15,20,25))

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","percentage_of_fusion_where_fusion_partner_is_kinase.png") , plot = percentage_of_fusion_where_fusion_partner_is_kinase, height = 8, width = 6)


#Venetoclax drug data for B-ALL cell line with IgH-NSD2 fusion vs. all other B-ALL cell lines
#BCL2 appears as dependency in 4/6 B-ALL cell lines that also have dependency data: SEM, HB1119, SEMK2, 697, REH(weak), NALM6(weak)
venetoclax_screen_all_cell_lines <- venetoclax_screen_all_cell_lines %>% mutate(B_ALL = ifelse(DepMap_ID %in% B_ALL_cell_lines,"B-ALL cells\n(n=10)", "Other cancer cells\n(n=460)"))

ggplot(venetoclax_screen_all_cell_lines, aes(x = B_ALL, y = venetoclax_AUC)) + geom_violin(size = 2, aes(fill = B_ALL)) + scale_color_manual(values = c("Black","Black")) + scale_fill_manual(values = c("Light blue","#E6E7E8")) + geom_point(venetoclax_screen_all_cell_lines %>% filter(DepMap_ID ==	"ACH-000151"), mapping = aes(x = B_ALL, y = venetoclax_AUC), color = "red", size = 3) + geom_label_repel(venetoclax_screen_all_cell_lines %>% filter(DepMap_ID ==	"ACH-000151"), mapping = aes(x = B_ALL, y = venetoclax_AUC), label = "Cell line with\nBCL2-IGH fusion", box.padding = 2, size = 6, nudge_x = 0.5, nudge_y = 5) + labs(x = '', y = 'AUC', title = "Cell line sensitivity to venetoclax") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.text = element_text(size = 20, color = "black"), legend.position="none") + coord_cartesian(ylim = c(0,20)) + stat_compare_means(data = venetoclax_screen_all_cell_lines, aes(x = B_ALL), method = "t.test", comparisons = list(c("B-ALL cells\n(n=10)", "Other cancer cells\n(n=460)")), size = 6)

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","Cell lines sensitivity to venetoclax.png"))

#Volcano plot comparing AUC drug data between multiple myeloma cells
ggplot(ctd2_auc_myeloma_cells_IGH_NSD2_with_vs_without_stats_annotated, aes(x = auc_difference, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept =1, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -1, color = "blue", linetype = "dashed", size = 1) + geom_label_repel(data=ctd2_auc_myeloma_cells_IGH_NSD2_with_vs_without_stats_annotated %>% filter(cpd_name %in% c("AZD4547","nintedanib","cediranib","lenvatinib")), aes(label = cpd_name), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 1)  + geom_point(data=ctd2_auc_myeloma_cells_IGH_NSD2_with_vs_without_stats_annotated %>% filter(negative_log10_BH_QValue > -log10(.05)), aes(x = auc_difference, y = negative_log10_BH_QValue), color = "black") + geom_point(data=ctd2_auc_myeloma_cells_IGH_NSD2_with_vs_without_stats_annotated %>% filter(cpd_name %in% c("AZD4547","nintedanib")), aes(x = auc_difference, y = negative_log10_BH_QValue), color = "red", size = 3) + labs(x = 'Difference in AUC', y = expression(-log[10](Q~value)), title = "Compound screening for multiple\nmyeloma cell lines stratified by\npresence/absence of IGH-NSD2 fusion") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none")+ylim(0,2)+xlim(-5,5)

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","Difference_in_AUC_for_multiple_myeloma_cell_lines_based_on_IGH_NSD2.png"))

#Volcano plot comparing RNA expression between multiple myeloma cells stratified by presence of IgH-NSD2 fusion
ggplot(RNA_expression_myeloma_cells_IGH_NSD2_with_vs_without_stats, aes(x = log2_fold_change, y = negative_log10_BH_QValue)) + geom_point(color = "#B5B3B3") + geom_hline(yintercept = -log10(.05), color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = 1, color = "blue", linetype = "dashed", size = 1) + geom_vline(xintercept = -1, color = "blue", linetype = "dashed", size = 1) + geom_point(data=RNA_expression_myeloma_cells_IGH_NSD2_with_vs_without_stats %>% filter(log2_fold_change > 1 & negative_log10_BH_QValue > -log10(.05)), aes(x = log2_fold_change, y = negative_log10_BH_QValue), color = "black") + geom_label_repel(data=RNA_expression_myeloma_cells_IGH_NSD2_with_vs_without_stats %>% filter(gene %in% c("FGFR3","NSD2")), aes(label = gene), label.size = NA, size = 8, fontface = "bold.italic", box.padding = 2, nudge_x = 2)  + geom_point(data=RNA_expression_myeloma_cells_IGH_NSD2_with_vs_without_stats %>% filter(gene %in% c("FGFR3","NSD2")), aes(x = log2_fold_change, y = negative_log10_BH_QValue), color = "red", size = 3) + labs(x = 'Log2 Fold Change in TPM', y = expression(-log[10](Q~value)), title = str_c("Differential expression for multiple\nmyeloma cell lines stratified by presence/\nabsence of IGH-NSD2 fusion")) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none")+xlim(-9,9)

ggsave(filename = here::here("results/TAD_fusion_dependency_and_expression_summary_plots","Difference_in_RNA_expression_for_multiple_myeloma_cell_lines_based_on_IGH_NSD2.png"))

#CRISPR phenotypic kill scores of EML4 in spheroids (individual and aggregated)

ttest_comparisons_individual <- list(c("NCIH23","NCIH1975"),c("NCIH23","NCIH2009"))

ttest_comparisons_aggregate <- list(c("Fusion", "No fusion"))

phenotypic_kill_scores_in_CRISPR_organoid_model_of_lung_cancer_cell_lines_EML4 <- ggplot(combined_sgrna_counts_pZ_gather_EML4, aes(x = cell_line, y = pZ, color = cell_line)) + geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 1) + annotate("text", label = "Median kill score\nfor non-targeting\nguides", x = 4, y = 2, size = 5) + geom_violin(size = 2) + scale_color_manual(values = c("Red","Black","Black")) + stat_summary(fun.y=mean, geom="point", size=2, color=c("red","black","black")) + labs(title = "Phenotypic kill scores in CRISPR\nspheroid models of lung cancer cell\nlines with targeting of EML4", x = "", y = "")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none") + coord_cartesian(ylim = c(-7,5)) + scale_x_discrete(labels = c("NCIH23\n(Fusion\npresent)","NCIH1975\n(No fusion)","NCIH2009\n(No fusion)",""), limits = c("NCIH23","NCIH1975","NCIH2009","")) + stat_compare_means(method = "t.test", comparisons = ttest_comparisons_individual, size = 6, vjust = -1, bracket.size = 0)

ggsave(filename = here::here("results/organoid_crispr_plots","phenotypic_kill_scores_in_CRISPR_organoid_model_of_lung_cancer_cell_lines_EML4.png"), plot = phenotypic_kill_scores_in_CRISPR_organoid_model_of_lung_cancer_cell_lines_EML4)

phenotypic_kill_scores_in_CRISPR_organoid_model_of_lung_cancer_cell_lines_aggregated_EML4 <- ggplot(combined_sgrna_counts_pZ_gather_EML4, aes(x = cell_line_with_or_without_fusion, y = pZ, color = cell_line_with_or_without_fusion)) + geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 1) + annotate("text", label = "Median kill score\nfor non-targeting\nguides", x = 3, y = 2, size = 7) + geom_violin(size = 2) + scale_color_manual(values = c("Red","Black")) + stat_summary(fun.y=mean, geom="point", size=2, color=c("red","black")) + labs(title = "Phenotypic kill scores in CRISPR\nspheroid models of lung cancer cell\nlines with targeting of EML4", x = "", y = "")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none") + coord_cartesian(ylim = c(-7,5)) + scale_x_discrete(labels = c("NCIH23\n(Fusion present)","NCIH1975,\nNCIH2009\n(No fusion)",""), limits = c("Fusion","No fusion","")) + stat_compare_means(method = "t.test", comparisons = ttest_comparisons_aggregate, size = 6, vjust = -1, bracket.size = 0)

ggsave(filename = here::here("results/organoid_crispr_plots","phenotypic_kill_scores_in_CRISPR_organoid_model_of_lung_cancer_cell_lines_aggregated_EML4.png"), plot = phenotypic_kill_scores_in_CRISPR_organoid_model_of_lung_cancer_cell_lines_aggregated_EML4)

#CRISPR MEAN phenotypic kill scores of nonessential genes in spheroids (individual and aggregated)

mean_phenotypic_kill_scores_in_CRISPR_organoid_model_of_lung_cancer_cell_lines_all_nonessential <- ggplot(mean_pZ_nonessentials, aes(x = cell_line, y = mean_pZ, color = cell_line)) + geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 1) + annotate("text", label = "Median kill score\nfor non-targeting\nguides", x = 4, y = 2, size = 5) + geom_jitter () + scale_color_manual(values = c("Red","Black","Black")) + labs(title = "Mean phenotypic kill scores in CRISPR\nspheroid models of lung cancer cell\nlines with targeting of nonessentials", x = "", y = "")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none") + coord_cartesian(ylim = c(-7,5)) + scale_x_discrete(labels = c("NCIH23\n(Fusion\npresent)","NCIH1975\n(No fusion)","NCIH2009\n(No fusion)",""), limits = c("NCIH23","NCIH1975","NCIH2009",""))

ggsave(filename = here::here("results/organoid_crispr_plots","mean_phenotypic_kill_scores_in_CRISPR_organoid_model_of_lung_cancer_cell_lines_all_nonessential.png"), plot = mean_phenotypic_kill_scores_in_CRISPR_organoid_model_of_lung_cancer_cell_lines_all_nonessential)

mean_phenotypic_kill_scores_in_CRISPR_organoid_model_of_lung_cancer_cell_lines_aggregated_all_nonessential <- ggplot(mean_pZ_nonessentials, aes(x = cell_line_with_or_without_fusion, y = mean_pZ, color = cell_line_with_or_without_fusion)) + geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 1) + annotate("text", label = "Median kill score\nfor non-targeting\nguides", x = 3, y = 2, size = 7) + geom_jitter () + scale_color_manual(values = c("Red","Black")) + labs(title = "Mean phenotypic kill scores in CRISPR\nspheroid models of lung cancer cell\nlines with targeting of nonessentials", x = "", y = "")+ theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.ticks.x=element_blank(), axis.text.y = element_text(size = 20, color = "black"), axis.text.x = element_text(size = 20, color = "black"), axis.title = element_text(size = 20, color = "black"), title = element_text(size = 20, color = "black"), legend.position="none") + coord_cartesian(ylim = c(-7,5)) + scale_x_discrete(labels = c("NCIH23\n(Fusion present)","NCIH1975,\nNCIH2009\n(No fusion)",""), limits = c("Fusion","No fusion",""))

ggsave(filename = here::here("results/organoid_crispr_plots","mean_phenotypic_kill_scores_in_CRISPR_organoid_model_of_lung_cancer_cell_lines_aggregated_all_nonessential.png"), plot = mean_phenotypic_kill_scores_in_CRISPR_organoid_model_of_lung_cancer_cell_lines_aggregated_all_nonessential)

```

